<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ†ÙÙŠØ° ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .sql-box {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
            margin-bottom: 20px;
            direction: ltr;
            text-align: left;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            margin: 20px auto;
            transition: background 0.3s;
        }
        .button:hover {
            background: #0056b3;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #bee5eb;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨Ù‡Ø§</h1>
        
        <div class="info">
            <strong>ØªØ¹Ù„ÙŠÙ…Ø§Øª:</strong><br>
            1. Ø§Ù†Ø³Ø® Ù…Ø­ØªÙˆÙ‰ SQL Ø£Ø¯Ù†Ø§Ù‡<br>
            2. Ø§ÙØªØ­ <a href="https://supabase.com/dashboard/project/bojrgkiqsahuwufbkacm/sql" target="_blank">Supabase SQL Editor</a><br>
            3. Ø§Ù„ØµÙ‚ SQL ÙˆØ§Ø¶ØºØ· Run
        </div>

        <div class="sql-box" id="sqlContent"></div>

        <button class="button" onclick="copySQL()">ğŸ“‹ Ù†Ø³Ø® SQL</button>

        <div id="status" class="status"></div>
    </div>

    <script>
        const sql = `-- ============================================
-- ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨Ù‡Ø§
-- ============================================

BEGIN;

-- 1. Ø­Ø°Ù Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© (Ù†Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø£Ø­Ø¯Ø«)
DO $$
DECLARE
    perm_record RECORD;
    kept_id UUID;
BEGIN
    FOR perm_record IN 
        SELECT action, COUNT(*) as cnt, array_agg(id ORDER BY created_at DESC) as ids
        FROM public.permissions
        GROUP BY action
        HAVING COUNT(*) > 1
    LOOP
        kept_id := perm_record.ids[1];
        
        -- Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ role_permissions Ø¥Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        UPDATE public.role_permissions
        SET permission_id = kept_id
        WHERE permission_id = ANY(perm_record.ids[2:array_length(perm_record.ids, 1)])
        AND permission_id != kept_id;
        
        -- Ø­Ø°Ù role_permissions Ø§Ù„Ù…ÙƒØ±Ø±Ø©
        DELETE FROM public.role_permissions
        WHERE permission_id = ANY(perm_record.ids[2:array_length(perm_record.ids, 1)]);
        
        -- Ø­Ø°Ù Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
        DELETE FROM public.permissions
        WHERE id = ANY(perm_record.ids[2:array_length(perm_record.ids, 1)]);
        
        RAISE NOTICE 'Removed % duplicate(s) for action: %', perm_record.cnt - 1, perm_record.action;
    END LOOP;
END $$;

-- 2. Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ display_order
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_schema = 'public' 
        AND table_name = 'permissions' 
        AND column_name = 'display_order'
    ) THEN
        ALTER TABLE public.permissions ADD COLUMN display_order INTEGER DEFAULT 999;
        RAISE NOTICE 'Added display_order column';
    END IF;
END $$;

-- 3. ØªØ­Ø¯ÙŠØ« ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø±Ø¶ - Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
UPDATE public.permissions SET display_order = 1 WHERE action = 'view:daily_watchlist';
UPDATE public.permissions SET display_order = 2 WHERE action = 'view:stock_analysis';
UPDATE public.permissions SET display_order = 3 WHERE action = 'view:forecast_accuracy';
UPDATE public.permissions SET display_order = 4 WHERE action = 'view:forecast_history_analysis';
UPDATE public.permissions SET display_order = 5 WHERE action = 'view:dashboard';

-- Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
UPDATE public.permissions SET display_order = 10 WHERE action = 'manage:users';
UPDATE public.permissions SET display_order = 11 WHERE action = 'manage:roles';
UPDATE public.permissions SET display_order = 12 WHERE action = 'manage:announcements';
UPDATE public.permissions SET display_order = 13 WHERE action = 'view:system_documentation';
UPDATE public.permissions SET display_order = 14 WHERE action = 'manage:stocks';
UPDATE public.permissions SET display_order = 15 WHERE action = 'manage:translations';
UPDATE public.permissions SET display_order = 16 WHERE action = 'view:activity_log';
UPDATE public.permissions SET display_order = 17 WHERE action = 'submit:user_notes';
UPDATE public.permissions SET display_order = 18 WHERE action = 'manage:user_notes';
UPDATE public.permissions SET display_order = 19 WHERE action = 'manage:settings';
UPDATE public.permissions SET display_order = 20 WHERE action = 'truncate:activity_log';

-- Ø¨Ù‚ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
UPDATE public.permissions SET display_order = 999 WHERE display_order IS NULL OR display_order = 999;

COMMIT;`;

        document.getElementById('sqlContent').textContent = sql;

        function copySQL() {
            navigator.clipboard.writeText(sql).then(() => {
                const status = document.getElementById('status');
                status.className = 'status success';
                status.style.display = 'block';
                status.textContent = 'âœ… ØªÙ… Ù†Ø³Ø® SQL Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø¢Ù† Ø§ÙØªØ­ Supabase SQL Editor ÙˆØ§Ù„ØµÙ‚Ù‡.';
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }).catch(err => {
                alert('âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®: ' + err.message);
            });
        }
    </script>
</body>
</html>


