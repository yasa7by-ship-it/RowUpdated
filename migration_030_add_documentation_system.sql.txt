-- #############################################################################
-- #
-- # MIGRATION SCRIPT: Add System Documentation Feature
-- #
-- # Purpose: This script introduces a feature to auto-generate documentation
-- # for the database schema, accessible from within the app.
-- #
-- # It performs three key actions:
-- # 1. Creates a new permission `view:system_documentation`.
-- # 2. Assigns this new permission to the 'Admin' role.
-- # 3. Creates a secure PostgreSQL RPC function `get_database_documentation`
-- #    that queries the database's information schema and returns a structured
-- #    JSON object containing details about tables, functions, and policies.
-- #
-- # This script is safe to run multiple times.
-- #
-- #############################################################################

BEGIN;

-- Step 1: Add the new permission to the permissions table.
INSERT INTO public.permissions (action, description)
VALUES ('view:system_documentation', 'Can view the auto-generated database and system documentation.')
ON CONFLICT (action) DO UPDATE SET description = EXCLUDED.description;


-- Step 2: Assign the new permission to the Admin role.
DO $$
DECLARE
    admin_role_id UUID;
    view_docs_perm_id UUID;
BEGIN
    RAISE NOTICE 'SUCCESS: Permission "view:system_documentation" added or already exists.';
    -- Get IDs
    SELECT id INTO admin_role_id FROM public.roles WHERE name = 'Admin';
    SELECT id INTO view_docs_perm_id FROM public.permissions WHERE action = 'view:system_documentation';

    -- Assign the permission to Admin if both exist
    IF admin_role_id IS NOT NULL AND view_docs_perm_id IS NOT NULL THEN
        INSERT INTO public.role_permissions (role_id, permission_id)
        VALUES (admin_role_id, view_docs_perm_id)
        ON CONFLICT (role_id, permission_id) DO NOTHING;

        IF FOUND THEN
             RAISE NOTICE 'SUCCESS: Assigned "view:system_documentation" permission to Admin role.';
        ELSE
             RAISE NOTICE 'INFO: Admin role already has "view:system_documentation" permission.';
        END IF;
    ELSE
        RAISE WARNING 'Could not assign "view:system_documentation" permission. Admin role or permission not found.';
    END IF;
END $$;


-- Step 3: Create the RPC function to fetch all schema information.
CREATE OR REPLACE FUNCTION public.get_database_documentation()
RETURNS json
LANGUAGE sql
SECURITY DEFINER
SET search_path = public, auth, pg_catalog, information_schema
AS $$
SELECT json_build_object(
    'tables', (
        SELECT COALESCE(json_agg(
            json_build_object(
                'name', t.table_name,
                'description', pg_catalog.obj_description(c.oid, 'pg_class'),
                'columns', (
                    SELECT COALESCE(json_agg(
                        json_build_object(
                            'name', col.column_name,
                            'type', col.udt_name,
                            'nullable', col.is_nullable,
                            'default', col.column_default,
                            'description', pg_catalog.col_description(c.oid, col.ordinal_position::int)
                        ) ORDER BY col.ordinal_position
                    ), '[]'::json)
                    FROM information_schema.columns col
                    WHERE col.table_schema = 'public' AND col.table_name = t.table_name
                )
            ) ORDER BY t.table_name
        ), '[]'::json)
        FROM information_schema.tables t
        JOIN pg_catalog.pg_class c ON c.relname = t.table_name
        JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace AND n.nspname = 'public'
        WHERE t.table_schema = 'public' AND t.table_type = 'BASE TABLE'
    ),
    'functions', (
        SELECT COALESCE(json_agg(
            json_build_object(
                'name', p.proname,
                'definition', pg_catalog.pg_get_functiondef(p.oid)
            ) ORDER BY p.proname
        ), '[]'::json)
        FROM pg_catalog.pg_proc p
        JOIN pg_catalog.pg_namespace n ON n.oid = p.pronamespace
        WHERE n.nspname = 'public'
    ),
    'policies', (
        SELECT COALESCE(json_agg(
            json_build_object(
                'table', p.tablename,
                'name', p.policyname,
                'command', p.cmd,
                'definition', p.qual,
                'with_check', p.with_check
            ) ORDER BY p.tablename, p.policyname
        ), '[]'::json)
        FROM pg_catalog.pg_policies p
        WHERE p.schemaname = 'public'
    )
);
$$;
RAISE NOTICE 'SUCCESS: RPC function "get_database_documentation" created or updated.';


COMMIT;