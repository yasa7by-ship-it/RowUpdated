# ุดุฑุญ ุฏุงูุฉ `get_the_coming_trend_data()` ุจุงูุชูุตูู

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐู ุงูุฏุงูุฉ ุชุฌูุน **ุฌููุน ุงูุจูุงูุงุช ุงููุทููุจุฉ** ูุนุฑุถ ุตูุญุฉ **"ุงูุงุชุฌุงู ุงููุงุฏู" (Daily Watchlist)** ูู ููุงู ูุงุญุฏ. ุจุฏูุงู ูู ุนูู ุนุฏุฉ ุงุณุชุนูุงูุงุช ูููุตูุฉุ ุชุนูุฏ ุงูุฏุงูุฉ ูู ุงูุจูุงูุงุช ูู ุงุณุชุนูุงู ูุงุญุฏ ูุญุณูู.

---

## ๐ฏ ูุง ุชูุนูู ุงูุฏุงูุฉุ

ุชุฌูุน ุงูุจูุงูุงุช ุงูุชุงููุฉ ููู ุณูู:
1. **ูุนูููุงุช ุงูุณูู ุงูุฃุณุงุณูุฉ** (ุงูุฑูุฒุ ุงูุงุณูุ ุงูุณุนุฑุ ุงูุชุบููุฑ)
2. **ุงูุชููุน ุงููุงุฏู** (ุงูุชุงุฑูุฎุ ุงููุทุงู ุงููุชููุน)
3. **ุงููุคุดุฑุงุช ุงููููุฉ** (RSIุ MACDุ SMA)
4. **ููุท ุงูุดูุนุฉ** (ุงุณู ุงูููุทุ ูู ูู ุตุงุนุฏ ุฃู ูุงุจุท)
5. **ุงููุทุงู ุงูุณุนุฑู ุงููุนูู** (ุฃุฏูู ูุฃุนูู ุณุนุฑ ุชู ุงููุตูู ุฅููู ูุนููุงู)

---

## ๐ ููู ุชุนูู ุงูุฏุงูุฉ ุฎุทูุฉ ุจุฎุทูุฉุ

### **ุงูุฎุทูุฉ 1: ุชุญุฏูุฏ ุขุฎุฑ ููู ุนูู**
```sql
SELECT MAX(date) INTO latest_historical_date FROM public.historical_data;
```
- ุชุฌุฏ **ุขุฎุฑ ุชุงุฑูุฎ** ูุชููุฑ ูู ุฌุฏูู `historical_data`
- ูุฐุง ุงูุชุงุฑูุฎ ููุซู **ุขุฎุฑ ููู ุนูู ุชู ุชุฏุงููู ูุนููุงู**

---

### **ุงูุฎุทูุฉ 2: ุงูุจุฏุก ูู ุฌุฏูู ุงูุฃุณูู**
```sql
FROM public.stocks s
WHERE s.is_tracked = true
```
- ุชุจุฏุฃ ูู ุฌุฏูู `stocks`
- ุชุฎุชุงุฑ ููุท ุงูุฃุณูู ุงูุชู `is_tracked = true` (ุงูุฃุณูู ุงููุชุงุจุนุฉ)

---

### **ุงูุฎุทูุฉ 3: ุฌูุจ ุงูุชููุน ุงููุงุฏู**
```sql
LEFT JOIN LATERAL (
    SELECT *
    FROM public.forecasts
    WHERE stock_symbol = s.symbol 
      AND forecast_date > latest_historical_date
    ORDER BY forecast_date ASC
    LIMIT 1
) nf ON true
```

**ูุง ุชูุนูู:**
- ุชุจุญุซ ูู ุฌุฏูู `forecasts` ุนู **ุฃูู ุชููุน ูุงุฏู**
- ุงูุดุฑุท: `forecast_date > latest_historical_date` (ุชุงุฑูุฎ ุงูุชููุน ุจุนุฏ ุขุฎุฑ ููู ุนูู)
- `LIMIT 1` = ุชุฃุฎุฐ ููุท ุงูุชููุน ุงูุฃูู (ุงูุฃูุฑุจ)
- ุงููุชูุฌุฉ: `next_forecast_date`, `next_predicted_lo`, `next_predicted_hi`

---

### **ุงูุฎุทูุฉ 4: ุฌูุจ ุงููุคุดุฑุงุช ุงููููุฉ**
```sql
LEFT JOIN public.technical_indicators ti 
ON s.symbol = ti.stock_symbol 
AND ti.date = latest_historical_date
```

**ูุง ุชูุนูู:**
- ุชุฑุจุท ุฌุฏูู `technical_indicators` ูุน ุงูุณูู
- ุชุฃุฎุฐ ุงููุคุดุฑุงุช ุงูุฎุงุตุฉ ุจู **ุขุฎุฑ ููู ุนูู** ููุท
- ุงููุชูุฌุฉ: `rsi`, `macd`, `macd_signal`, `sma20`, `sma50`

---

### **ุงูุฎุทูุฉ 5: ุฌูุจ ุงูููุท (Pattern)**
```sql
LEFT JOIN LATERAL (
    SELECT cp_inner.pattern_name, cp_inner.bullish
    FROM public.candle_patterns cp_inner
    WHERE cp_inner.stock_symbol = s.symbol 
      AND cp_inner.date = latest_historical_date
    ORDER BY cp_inner.confidence DESC NULLS LAST
    LIMIT 1
) cp ON true
```

**ูุง ุชูุนูู:**
- ุชุจุญุซ ูู `candle_patterns` ุนู ููุท ุงูุดูุนุฉ
- ุชุฃุฎุฐ ุงูููุท ุฐู **ุฃุนูู ุซูุฉ (confidence)**
- ุฅุฐุง ูุงู ููุงู ุนุฏุฉ ุฃููุงุท ูู ููุณ ุงููููุ ุชุฃุฎุฐ ุงูุฃูุซุฑ ุซูุฉ ููุท
- ุงููุชูุฌุฉ: `pattern_name`, `bullish` (ุตุงุนุฏ ุฃู ูุงุจุท)

---

### **ุงูุฎุทูุฉ 6: ุฌูุจ ุงููุทุงู ุงูุณุนุฑู ุงููุนูู (ุงูุฃูู!)**

ุงูุฏุงูุฉ ุชุณุชุฎุฏู **ูุธุงู ุฃููููุงุช ูุชุนุฏุฏ ุงููุตุงุฏุฑ**:

#### **ุงููุตุฏุฑ ุงูุฃูู: `forecast_check_history`**
```sql
LEFT JOIN LATERAL (
    SELECT fch_inner.actual_low, fch_inner.actual_high, fch_inner.forecast_date
    FROM public.forecast_check_history fch_inner
    WHERE fch_inner.stock_symbol = s.symbol
    ORDER BY 
        -- ุงูุฃููููุฉ 1: ุชุทุงุจู ุฏููู ูุน ุขุฎุฑ ููู ุนูู
        CASE WHEN fch_inner.forecast_date = latest_historical_date THEN 0 ELSE 1 END,
        -- ุงูุฃููููุฉ 2: ุขุฎุฑ ุชุงุฑูุฎ ูุชุงุญ
        fch_inner.forecast_date DESC
    LIMIT 1
) fch ON true
```

**ูุง ุชูุนูู:**
- ุชุจุญุซ ูู `forecast_check_history` (ุณุฌู ุชูููู ุงูุชููุนุงุช ุงูุชุงุฑูุฎู)
- **ุงูุฃููููุฉ 1:** ุจูุงูุงุช ูุชุงุฑูุฎ ุขุฎุฑ ููู ุนูู ุจุงูุถุจุท
- **ุงูุฃููููุฉ 2:** ุขุฎุฑ ุชุงุฑูุฎ ูุชุงุญ ุฅุฐุง ูู ุชูุฌุฏ ุจูุงูุงุช ููุชุงุฑูุฎ ุงููุญุฏุฏ
- ูุฐุง ููู ุฌุฏุงู ููุญุตูู ุนูู ุจูุงูุงุช ุชูุงุฑูุฎ ูุญุฏุฏุฉ (ูุซู 31/10/2025)

---

#### **ุงููุตุฏุฑ ุงูุซุงูู: `forecast_check_latest`** (ุจุฏูู)
```sql
LEFT JOIN public.forecast_check_latest fcl 
ON s.symbol = fcl.stock_symbol 
AND fch.forecast_date IS NULL
```

**ูุง ุชูุนูู:**
- ุฅุฐุง ูู ุชุฌุฏ ุจูุงูุงุช ูู `forecast_check_history`
- ุชุณุชุฎุฏู `forecast_check_latest` (ุฃุญุฏุซ ูุชุงุฆุฌ ุงูุชูููู)
- ุงูุดุฑุท: `fch.forecast_date IS NULL` = ูุง ุชูุฌุฏ ุจูุงูุงุช ูู history

---

#### **ุงููุตุฏุฑ ุงูุซุงูุซ: `historical_data`** (ุงูุจุฏูู ุงูุฃุฎูุฑ)
```sql
LEFT JOIN public.historical_data hd 
ON s.symbol = hd.stock_symbol 
AND hd.date = latest_historical_date
AND fch.forecast_date IS NULL
AND fcl.stock_symbol IS NULL
```

**ูุง ุชูุนูู:**
- ุฅุฐุง ูู ุชุฌุฏ ุจูุงูุงุช ูู ุฃู ูู ุงููุตุฏุฑูู ุงูุณุงุจููู
- ุชุณุชุฎุฏู `historical_data` (ุงูุจูุงูุงุช ุงูุชุงุฑูุฎูุฉ ุงูุฎุงู)
- ุงูุดุฑุท: ููุท ุฅุฐุง ูุดู ุงููุตุฏุฑุงู ุงูุณุงุจูุงู

---

### **ุงูุฎุทูุฉ 7: ุฏูุฌ ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู COALESCE**
```sql
COALESCE(
    fch.actual_low::real,    -- ุงููุตุฏุฑ ุงูุฃูู
    fcl.actual_low::real,    -- ุงููุตุฏุฑ ุงูุซุงูู
    hd.low::real             -- ุงููุตุฏุฑ ุงูุซุงูุซ
) AS actual_low
```

**ูุง ุชูุนูู:**
- `COALESCE` = ุฎุฐ ุฃูู ูููุฉ ุบูุฑ NULL
- **ุงูุฃููููุฉ:** `forecast_check_history` โ `forecast_check_latest` โ `historical_data`
- ููุณ ุงูุดูุก ูู `actual_high`

---

### **ุงูุฎุทูุฉ 8: ุชุฑุชูุจ ุงููุชุงุฆุฌ**
```sql
ORDER BY s.symbol
```
- ุชุฑุชูุจ ุงููุชุงุฆุฌ ุญุณุจ **ุฑูุฒ ุงูุณูู** (ุฃุจุฌุฏูุงู)

---

## ๐ ูุซุงู ุนููู

ูููุชุฑุถ ุฃู ูุฏููุง ุณูู "AAPL":

1. **ุชุญุฏูุฏ ุขุฎุฑ ููู ุนูู:** 2025-10-31
2. **ุงูุจุญุซ ุนู ุงูุชููุน ุงููุงุฏู:** ุฃูู ุชููุน ุจุนุฏ 2025-10-31
3. **ุฌูุจ ุงููุคุดุฑุงุช:** RSIุ MACD ูู 2025-10-31
4. **ุฌูุจ ุงูููุท:** ููุท ุงูุดูุนุฉ ุงูุฃูุซุฑ ุซูุฉ ูู 2025-10-31
5. **ุฌูุจ ุงููุทุงู ุงููุนูู:**
   - ุฃููุงู: ุงูุจุญุซ ูู `forecast_check_history` ุนู 2025-10-31
   - ุฅุฐุง ูู ุชุฌุฏ: ุงูุจุญุซ ูู `forecast_check_latest`
   - ุฅุฐุง ูู ุชุฌุฏ: ุงูุจุญุซ ูู `historical_data` ุนู 2025-10-31
6. **ุฅุฑุฌุงุน ุงููุชูุฌุฉ:** ุณุทุฑ ูุงุญุฏ ูุญุชูู ุนูู ูู ุงูุจูุงูุงุช

---

## โก ููุงุฐุง ูุฐู ุงูุทุฑููุฉ ูููุฏุฉุ

1. **ุงุณุชุนูุงู ูุงุญุฏ ุจุฏูุงู ูู ุนุฏุฉ:** ุฃุณุฑุน ูุฃูุซุฑ ููุงุกุฉ
2. **ูุธุงู ุฃููููุงุช ุฐูู:** ูุถูู ุงูุญุตูู ุนูู ุฃุฏู ุจูุงูุงุช ูุชุงุญุฉ
3. **ูุฑููุฉ:** ุฅุฐุง ูู ุชูุฌุฏ ุจูุงูุงุช ูู ูุตุฏุฑุ ุชุณุชุฎุฏู ุงูุจุฏูู
4. **ูุญุณููุฉ:** ุงุณุชุฎุฏุงู `LEFT JOIN LATERAL` ูุชูููู ุนุฏุฏ ุงูุงุณุชุนูุงูุงุช

---

## ๐ ุงููุฑู ุจูู ุงููุตุงุฏุฑ

| ุงููุตุฏุฑ | ุงูุงุณุชุฎุฏุงู | ูุชู ููุณุชุฎุฏู |
|--------|----------|-------------|
| `forecast_check_history` | ุจูุงูุงุช ุชูุงุฑูุฎ ูุญุฏุฏุฉ | ุฃููููุฉ: ุชุงุฑูุฎ ุขุฎุฑ ููู ุนูู ุจุงูุถุจุท |
| `forecast_check_latest` | ุฃุญุฏุซ ูุชุงุฆุฌ ุงูุชูููู | ุฅุฐุง ูู ุชูุฌุฏ ูู history |
| `historical_data` | ุจูุงูุงุช ุชุงุฑูุฎูุฉ ุฎุงู | ุจุฏูู ุฃุฎูุฑ |

---

## ๐ ููุฎุต ุณุฑูุน

**ุงูุฏุงูุฉ ุชุนูู ูุงูุชุงูู:**
1. โ ุชุฌุฏ ุขุฎุฑ ููู ุนูู
2. โ ููู ุณูู ุชุงุจุน (`is_tracked = true`)
3. โ ุชุฌูุน: ูุนูููุงุช ุงูุณูู + ุงูุชููุน ุงููุงุฏู + ุงููุคุดุฑุงุช + ุงูููุท + ุงููุทุงู ุงููุนูู
4. โ ุชุณุชุฎุฏู ูุธุงู ุฃููููุงุช ุฐูู ูุฌูุจ ุงููุทุงู ุงููุนูู
5. โ ุชุฑุฌุน ูู ุดูุก ูุฑุชุจ ุญุณุจ ุฑูุฒ ุงูุณูู

**ุงููุชูุฌุฉ:** ุฌุฏูู ูุงูู ุฌุงูุฒ ููุนุฑุถ ูู ุตูุญุฉ "ุงูุงุชุฌุงู ุงููุงุฏู"! ๐ฏ

