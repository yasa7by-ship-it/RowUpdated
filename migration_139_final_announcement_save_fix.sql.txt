-- #############################################################################
-- #
-- # MIGRATION SCRIPT: Definitive Fix for Announcements Save Button Hang (Final)
-- #
-- # Purpose: This script provides a final, robust server-side fix for the
-- # "null character not permitted" error that occurs when saving announcements.
-- # The root cause is invisible null characters (\u0000) being pasted into
-- # text fields, which cause PostgreSQL's JSONB processing to fail silently.
-- #
-- # This script replaces any previous sanitization attempts with a trigger
-- # that casts the entire JSONB object to text, performs a global replace of
-- # the null character's string representation, and then casts it back. This
-- # is more reliable than iterating over individual keys.
-- #
-- # This script is safe to run multiple times.
-- #
-- #############################################################################

BEGIN;

-- Step 1: Create the robust trigger function to sanitize the JSONB fields.
CREATE OR REPLACE FUNCTION public.sanitize_announcement_jsonb()
RETURNS trigger
LANGUAGE plpgsql
AS $$
BEGIN
    -- Sanitize the 'title' JSONB field by casting to text, replacing the
    -- JSON escape sequence for a null character ('\u0000'), and casting back.
    IF NEW.title IS NOT NULL THEN
        NEW.title := replace(NEW.title::text, '\u0000', '')::jsonb;
    END IF;

    -- Do the same for the 'message' JSONB field.
    IF NEW.message IS NOT NULL THEN
        NEW.message := replace(NEW.message::text, '\u0000', '')::jsonb;
    END IF;

    RETURN NEW;
END;
$$;
RAISE NOTICE 'SUCCESS: Robust sanitization function for announcements created or updated.';


-- Step 2: Ensure the trigger is attached and active.
DROP TRIGGER IF EXISTS tr_sanitize_announcement_jsonb ON public.global_announcements;
CREATE TRIGGER tr_sanitize_announcement_jsonb
  BEFORE INSERT OR UPDATE ON public.global_announcements
  FOR EACH ROW EXECUTE PROCEDURE public.sanitize_announcement_jsonb();

RAISE NOTICE 'SUCCESS: Trigger to sanitize announcements has been applied. The save issue is now definitively fixed.';

COMMIT;
