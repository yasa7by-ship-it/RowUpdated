-- #############################################################################
-- #
-- # MIGRATION SCRIPT: Add Stock Details Page System
-- #
-- # Purpose: This script introduces the backend infrastructure for the new
-- # Stock Details page.
-- #
-- # It performs two key actions:
-- # 1. Creates a new RPC function `get_stock_details_page_data` to efficiently
-- #    fetch all required data for a given stock in a single call.
-- # 2. Adds all necessary UI translations for the new page.
-- #
-- # This script is safe to run multiple times.
-- #
-- #############################################################################

BEGIN;

-- Step 1: Create the RPC function to fetch all data for the details page.
CREATE OR REPLACE FUNCTION public.get_stock_details_page_data(p_symbol TEXT)
RETURNS json
LANGUAGE sql
STABLE
AS $$
SELECT json_build_object(
    'details', (
        SELECT row_to_json(s)
        FROM public.stocks s
        WHERE s.symbol = p_symbol
    ),
    'next_forecast', (
        SELECT row_to_json(f)
        FROM public.forecasts f
        WHERE f.stock_symbol = p_symbol
        ORDER BY f.forecast_date DESC
        LIMIT 1
    ),
    'historical_data', (
        SELECT COALESCE(json_agg(h ORDER BY h.date ASC), '[]'::json) -- Order ASC for charting
        FROM (
            SELECT * FROM public.historical_data
            WHERE stock_symbol = p_symbol
            ORDER BY date DESC
            LIMIT 90
        ) h
    ),
    'latest_indicators', (
        SELECT row_to_json(ti)
        FROM public.technical_indicators ti
        WHERE ti.stock_symbol = p_symbol
        ORDER BY ti.date DESC
        LIMIT 1
    ),
    'forecast_history', (
        SELECT COALESCE(json_agg(fch ORDER BY fch.forecast_date DESC), '[]'::json)
        FROM (
            SELECT * FROM public.forecast_check_history
            WHERE stock_symbol = p_symbol
            ORDER BY forecast_date DESC
            LIMIT 10
        ) fch
    ),
    'recent_patterns', (
         SELECT COALESCE(json_agg(cp ORDER BY cp.date DESC), '[]'::json)
        FROM (
            SELECT * FROM public.candle_patterns
            WHERE stock_symbol = p_symbol
            ORDER BY date DESC
            LIMIT 5
        ) cp
    )
);
$$;
RAISE NOTICE 'SUCCESS: RPC function "get_stock_details_page_data" created or updated.';


-- Step 2: Add all necessary UI translations.
-- Temporarily disable RLS to update system data
ALTER TABLE public.translations DISABLE ROW LEVEL SECURITY;

INSERT INTO public.translations (lang_id, key, value) VALUES
('en', 'stock_details', 'Stock Details'),
('ar', 'stock_details', 'تفاصيل السهم'),
('en', 'back_to_analysis', 'Back to Analysis List'),
('ar', 'back_to_analysis', 'الرجوع إلى قائمة التحليل'),
('en', 'next_day_forecast', 'Next Day Forecast'),
('ar', 'next_day_forecast', 'توقع اليوم التالي'),
('en', 'no_forecast_available', 'No forecast available.'),
('ar', 'no_forecast_available', 'لا يوجد توقع متاح.'),
('en', 'historical_performance_90d', 'Historical Performance (90-Day)'),
('ar', 'historical_performance_90d', 'الأداء التاريخي (آخر 90 يومًا)'),
('en', 'technical_indicators_tab', 'Technical Indicators'),
('ar', 'technical_indicators_tab', 'المؤشرات الفنية'),
('en', 'forecast_history_tab', 'Forecast History'),
('ar', 'forecast_history_tab', 'سجل التوقعات'),
('en', 'candle_patterns_tab', 'Recent Patterns'),
('ar', 'candle_patterns_tab', 'الأنماط الأخيرة'),
('en', 'outcome', 'Outcome'),
('ar', 'outcome', 'النتيجة'),
('en', 'pattern', 'Pattern'),
('ar', 'pattern', 'النمط'),
('en', 'sentiment', 'Sentiment'),
('ar', 'sentiment', 'المؤشر'),
('en', 'bullish', 'Bullish'),
('ar', 'bullish', 'صاعد'),
('en', 'bearish', 'Bearish'),
('ar', 'bearish', 'هابط')
ON CONFLICT (lang_id, key) 
DO UPDATE SET value = EXCLUDED.value;

RAISE NOTICE 'SUCCESS: Translations for the Stock Details page have been added.';

-- Re-enable RLS
ALTER TABLE public.translations ENABLE ROW LEVEL SECURITY;

COMMIT;
