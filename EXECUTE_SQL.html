<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ†ÙÙŠØ° SQL Script - FIX_get_latest_ranges_from_history</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 10px;
        }
        .sql-box {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 20px 0;
            direction: ltr;
            text-align: left;
        }
        .button {
            background: #2563eb;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            text-decoration: none;
            display: inline-block;
        }
        .button:hover {
            background: #1d4ed8;
        }
        .button-copy {
            background: #10b981;
        }
        .button-copy:hover {
            background: #059669;
        }
        .steps {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-right: 4px solid #2563eb;
        }
        .step {
            margin: 15px 0;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }
        .step-number {
            background: #2563eb;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            font-weight: bold;
        }
        .alert {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ ØªÙ†ÙÙŠØ° SQL Script: FIX_get_latest_ranges_from_history</h1>
        
        <div class="alert">
            <strong>âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙŠØ¬Ø¨ ØªÙ†ÙÙŠØ° SQL Script ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Supabase SQL Editor. Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ†ÙÙŠØ°Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
        </div>

        <div class="steps">
            <h2>ğŸ“‹ Ø§Ù„Ø®Ø·ÙˆØ§Øª:</h2>
            <div class="step">
                <span class="step-number">1</span>
                <strong>Ø§ÙØªØ­ Supabase Dashboard:</strong>
                <a href="https://supabase.com/dashboard" target="_blank" class="button">ÙØªØ­ Supabase Dashboard</a>
            </div>
            <div class="step">
                <span class="step-number">2</span>
                <strong>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ SQL Editor:</strong>
                <a href="https://supabase.com/dashboard/project/bojrgkiqsahuwufbkacm/sql" target="_blank" class="button">ÙØªØ­ SQL Editor</a>
            </div>
            <div class="step">
                <span class="step-number">3</span>
                <strong>Ø§Ù†Ø³Ø® SQL Script:</strong>
                <button class="button button-copy" onclick="copySQL()">Ù†Ø³Ø® SQL Script</button>
            </div>
            <div class="step">
                <span class="step-number">4</span>
                <strong>Ø§Ù„ØµÙ‚ ÙÙŠ SQL Editor ÙˆØ§Ø¶ØºØ· Run:</strong>
                Ø§Ø³ØªØ®Ø¯Ù… Ctrl+V Ù„Ù„ØµÙ‚ØŒ Ø«Ù… Ø§Ø¶ØºØ· Run Ø£Ùˆ Ctrl+Enter
            </div>
        </div>

        <h2>ğŸ“„ Ù…Ø­ØªÙˆÙ‰ SQL Script:</h2>
        <div class="sql-box" id="sqlContent">
-- ============================================
-- Ø¥ØµÙ„Ø§Ø­ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„ÙØ¹Ù„ÙŠ ÙˆØ§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù…Ù† forecast_check_history
-- ============================================

BEGIN;

-- Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ØªØ¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Ù†Ø·Ø§Ù‚ Ù„ÙƒÙ„ Ø³Ù‡Ù… Ù…Ù† forecast_check_history
CREATE OR REPLACE FUNCTION public.get_latest_ranges_from_history()
RETURNS TABLE (
  stock_symbol TEXT,
  stock_name TEXT,
  forecast_date DATE,
  actual_low DOUBLE PRECISION,
  actual_high DOUBLE PRECISION,
  predicted_lo DOUBLE PRECISION,
  predicted_hi DOUBLE PRECISION
)
LANGUAGE plpgsql
STABLE
AS $$
BEGIN
  RETURN QUERY
  WITH latest_forecasts AS (
    -- Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« ØªØ§Ø±ÙŠØ® Ù„ÙƒÙ„ Ø³Ù‡Ù…
    SELECT 
      fch.stock_symbol,
      MAX(fch.forecast_date) AS latest_date
    FROM public.forecast_check_history fch
    WHERE fch.actual_low IS NOT NULL 
      AND fch.actual_high IS NOT NULL
      AND fch.predicted_lo IS NOT NULL
      AND fch.predicted_hi IS NOT NULL
    GROUP BY fch.stock_symbol
  )
  SELECT DISTINCT ON (fch.stock_symbol)
    fch.stock_symbol,
    COALESCE(s.name, fch.stock_symbol) AS stock_name,
    fch.forecast_date,
    fch.actual_low,
    fch.actual_high,
    fch.predicted_lo,
    fch.predicted_hi
  FROM public.forecast_check_history fch
  JOIN latest_forecasts lf 
    ON fch.stock_symbol = lf.stock_symbol 
    AND fch.forecast_date = lf.latest_date
  LEFT JOIN public.stocks s 
    ON s.symbol = fch.stock_symbol
  WHERE fch.actual_low IS NOT NULL 
    AND fch.actual_high IS NOT NULL
    AND fch.predicted_lo IS NOT NULL
    AND fch.predicted_hi IS NOT NULL
  ORDER BY fch.stock_symbol, fch.forecast_date DESC, fch.created_at DESC;
END;
$$;

COMMENT ON FUNCTION public.get_latest_ranges_from_history IS 'Returns the latest actual and forecast ranges for each stock from forecast_check_history';

COMMIT;
        </div>

        <div style="margin-top: 20px;">
            <button class="button button-copy" onclick="copySQL()">ğŸ“‹ Ù†Ø³Ø® SQL Script</button>
            <a href="https://supabase.com/dashboard/project/bojrgkiqsahuwufbkacm/sql" target="_blank" class="button">ğŸš€ ÙØªØ­ SQL Editor</a>
        </div>

        <div class="steps" style="margin-top: 30px;">
            <h2>âœ… Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°:</h2>
            <div class="step">
                <span class="step-number">1</span>
                ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨ØªØ´ØºÙŠÙ„:
                <div class="sql-box" style="margin-top: 10px; font-size: 12px;">
SELECT * FROM public.get_latest_ranges_from_history() LIMIT 10;
                </div>
            </div>
            <div class="step">
                <span class="step-number">2</span>
                Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© "Ø¯Ù‚Ø© Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª" ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
            </div>
            <div class="step">
                <span class="step-number">3</span>
                ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¸Ù‡Ø± ÙÙŠ Ø¹Ù…ÙˆØ¯ÙŠ "Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„ÙØ¹Ù„ÙŠ" Ùˆ"Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹"
            </div>
        </div>
    </div>

    <script>
        function copySQL() {
            const sqlContent = document.getElementById('sqlContent').textContent;
            navigator.clipboard.writeText(sqlContent).then(() => {
                alert('âœ… ØªÙ… Ù†Ø³Ø® SQL Script Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„ØµÙ‚Ù‡ ÙÙŠ Supabase SQL Editor');
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = sqlContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('âœ… ØªÙ… Ù†Ø³Ø® SQL Script Ø¨Ù†Ø¬Ø§Ø­!');
            });
        }
    </script>
</body>
</html>

