# مواصفات المشروع: لوحة تحكم آمنة ومنصة تحليل أسهم
_تم التحديث بتاريخ: 2024-08-01_

هذا المستند هو المصدر الوحيد للمعلومات الصحيحة لوظائف المشروع، صلاحيات المستخدمين، وهيكل قاعدة البيانات. تم إنشاؤه بناءً على تحليل كامل لكود المصدر للتطبيق ومخططات قاعدة البيانات.

---

## 1. نظرة عامة على المشروع

المشروع هو تطبيق ويب آمن قائم على الأدوار، مبني باستخدام React و Supabase. وظائفه الأساسية تنقسم إلى محورين رئيسيين:
1.  **منصة تحليل الأسهم**: توفير توقعات وتحليلات لأسعار الأسهم في الأسواق الأمريكية بطريقة احترافية وجذابة بصريًا للمستخدمين المسجلين.
2.  **لوحة تحكم إدارية**: العمل كلوحة تحكم شاملة للمسؤولين لإدارة المستخدمين، الأدوار، محتوى الموقع، إعدادات النظام، وسجل الأنشطة.

يتميز التطبيق بواجهة مستخدم نظيفة ومتجاوبة، ونظام صلاحيات قوي، وبنية خلفية تعتمد على دوال PostgreSQL (RPC) للوصول الآمن والفعال للبيانات.

---

## 2. المبادئ الأساسية وقواعد العمل (Core Principles & Business Logic)

هذه هي القواعد الأساسية التي تحكم سلوك التطبيق ويجب عدم انتهاكها.

1.  **تسجيل المستخدم وتوجيهه**: عند التسجيل بنجاح، يتم تعيين دور 'User' للمستخدم الجديد ويتم تسجيل دخوله تلقائيًا. الصفحة الأساسية للمستخدم العادي 'User' هي **تحليل الأسهم (`stock_analysis`)**. إذا حاول الوصول إلى صفحة مقيدة (مثل لوحة التحكم)، يتم إعادة توجيهه إلى `stock_analysis`. إذا لم يكن لديه أي صلاحيات على الإطلاق، يتم إرساله إلى الصفحة الرئيسية (`landing`).

2.  **التحكم في الوصول إلى لوحة التحكم**: لوحة التحكم الرئيسية (`dashboard`) هي أداة إدارية. يمكن الوصول إليها **فقط** من قبل المستخدمين الذين يمتلك دورهم صلاحية `view:dashboard` (مثل 'Admin'). لا يمكن للمستخدمين العاديين الوصول إليها.

3.  **التنقل عبر الشعار والعنوان**: النقر على شعار الموقع أو عنوان الموقع في الشريط العلوي سيوجه المستخدم **دائمًا** إلى **الصفحة الرئيسية (`landing`)**.

4.  **تعيين الدور الافتراضي**: أي مستخدم جديد يقوم بالتسجيل يتم تعيين دور 'User' له تلقائيًا. **أول مستخدم** يتم إنشاؤه في النظام على الإطلاق يتم تعيين دور 'Admin' له تلقائيًا. يتم التعامل مع هذا المنطق بواسطة مُحفِّز قاعدة البيانات `handle_new_user`.

5.  **لا يوجد تأكيد للبريد الإلكتروني**: تم تعطيل خطوة تأكيد البريد الإلكتروني. يتم تأكيد جميع المستخدمين الجدد تلقائيًا ويمكنهم تسجيل الدخول فورًا بعد التسجيل، مما يسهل عملية الانضمام. يتم التعامل مع هذا أيضًا بواسطة المُحفِّز `handle_new_user`.

6.  **استمرارية الجلسة (Remember Me)**: يحتوي نموذج تسجيل الدخول في الشريط العلوي على خيار "تذكرني". هذا الخيار يتحكم في مكان تخزين رمز الجلسة:
    -   **محدد**: يتم تخزين الجلسة في `localStorage`، مما يحافظ على تسجيل دخول المستخدم حتى بعد إغلاق المتصفح.
    -   **غير محدد**: يتم تخزين الجلسة في `sessionStorage`، مما يؤدي إلى تسجيل الخروج عند إغلاق المتصفح.

7.  **التقييم التلقائي للتوقعات**: يقوم النظام بتقييم أداء التوقعات بشكل تلقائي. عند إدخال دفعة جديدة من التوقعات، يقوم مُحفِّز قاعدة البيانات (`trigger_forecast_evaluation`) بالتحقق مما إذا كانت الدفعة مكتملة. إذا كانت كذلك، فإنه يستدعي تلقائيًا الدالة `evaluate_and_save_forecasts` التي تقارن التوقعات بالبيانات التاريخية الفعلية وتحفظ النتائج.

---

## 3. أدوار وصلاحيات المستخدمين (User Roles & Permissions)

يستخدم النظام نموذج التحكم في الوصول المستند إلى الأدوار (RBAC). يتم تعيين الصلاحيات للأدوار، ويتم تعيين الأدوار للمستخدمين.

| صلاحية الإجراء (`action`)             | الوصف                                                                    | دور المسؤول (Admin) | دور المستخدم (User) |
| ------------------------------------- | ------------------------------------------------------------------------ | :------------------: | :-----------------: |
| `view:dashboard`                      | يمكنه عرض لوحة التحكم الرئيسية والإحصائيات.                              |          ✅          |          ❌           |
| `manage:users`                        | يمكنه عرض قائمة المستخدمين، إضافة مستخدمين جدد، وتغيير أدوار المستخدمين.  |          ✅          |          ❌           |
| `manage:roles`                        | يمكنه عرض قائمة الأدوار وتغيير صلاحيات الأدوار.                           |          ✅          |          ❌           |
| `manage:settings`                     | يمكنه تحديث إعدادات الموقع العامة (الشعار، محتوى الصفحة الرئيسية، إلخ).    |          ✅          |          ❌           |
| `manage:announcements`                | يمكنه إنشاء، تعديل، وحذف الإعلانات العامة.                               |          ✅          |          ❌           |
| `view:system_documentation`           | يمكنه عرض توثيق قاعدة البيانات والنظام الذي يتم إنشاؤه تلقائيًا.          |          ✅          |          ❌           |
| `view:stock_analysis`                 | يمكنه عرض لوحة معلومات تحليل الأسهم وأداء التوقعات.                      |          ✅          |          ✅           |
| `manage:stocks`                       | يمكنه إضافة، تحديث، وتتبع الأسهم في النظام.                              |          ✅          |          ❌           |
| `manage:translations`                 | يمكنه تعديل نصوص واجهة المستخدم لجميع اللغات.                            |          ✅          |          ❌           |
| `view:activity_log`                   | يمكنه عرض سجل أنشطة النظام.                                              |          ✅          |          ❌           |

---

## 4. مواصفات واجهة المستخدم: الصفحات والمكونات (UI Specification: Pages & Components)

### 4.1. الهيكل العام
- **`App.tsx`**: الموجه الرئيسي للتطبيق. يدير حالة الصفحة الحالية ويفرض الصلاحيات على مستوى عالٍ، ويعيد توجيه المستخدمين إذا لم يكن لديهم إذن. يحدد عنوان المستند ديناميكيًا.
- **`Layout.tsx`**: الغلاف الرئيسي للصفحة. يتضمن `Header` و `AnnouncementsBanner` ويضمن أن المحتوى يملأ الشاشة بشكل صحيح.

### 4.2. الصفحات الرئيسية
| الصفحة / المكون                | الصلاحية المطلوبة             | الوصف                                                                                                                                                                                                                                                                                                                                                                                         |
| ------------------------------ | ----------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **الصفحة الرئيسية (Landing Page)** | _عام_                        | نقطة الدخول العامة. تعرض مقالًا رئيسيًا وبطاقة تسجيل دخول (`LoginCard`) للمستخدمين غير المسجلين.                                                                                                                                                                                                                                                                                                |
| **لوحة التحكم (Dashboard)**      | `view:dashboard`              | تعرض إحصائيات الموقع (عدد المستخدمين/الأدوار) وتوفر نموذجًا لإدارة إعدادات الموقع العامة (`site_title`, `site_logo`, محتوى الصفحة الرئيسية، ووصف صفحة تحليل الأسهم).                                                                                                                                                                                                                                           |
| **إدارة المستخدمين**           | `manage:users`                | تعرض جدولاً مقسمًا لجميع المستخدمين. تسمح بإنشاء مستخدمين جدد، تعديل المستخدمين الحاليين (الاسم، الدور، وكلمة المرور)، وتفعيل الحسابات يدويًا.                                                                                                                                                                                                                                                                |
| **إدارة الأدوار**               | `manage:roles`                | تعرض قائمة بالأدوار وقائمة اختيار للصلاحيات. تسمح للمسؤولين بتعيين أو إلغاء صلاحيات لكل دور.                                                                                                                                                                                                                                                                                                    |
| **إدارة الإعلانات**             | `manage:announcements`        | تسمح بإنشاء، تعديل، وحذف الإعلانات العامة التي تظهر كإشعارات للمستخدمين.                                                                                                                                                                                                                                                                                                                          |
| **توثيق النظام**               | `view:system_documentation`   | تنشئ وتعرض توثيقًا حيًا لمخطط قاعدة البيانات، بما في ذلك الجداول، الدوال، وسياسات RLS.                                                                                                                                                                                                                                                                                                            |
| **آخر يوم عمل (Stock Analysis)** | `view:stock_analysis`         | **الصفحة الأساسية للمستخدمين العاديين.** تعرض نتائج التوقعات اليومية لآخر يوم عمل. الميزات تشمل: <ul><li>رأس صفحة يحتوي على عنوان رئيسي، ووصف قابل للتعديل، وعرض بارز للتاريخ.</li><li>بطاقات إحصائيات ملخصة: مقياس دائري كبير لـ **نسبة النجاح**، وبطاقات أصغر لـ **إجمالي التوقعات**، **التوقعات الصحيحة**، و **التوقعات الخاطئة**.</li><li>عناصر تحكم للبحث برمز السهم/الاسم والتصفية حسب النتيجة (الكل/صحيح/خطأ).</li><li>جدول مفصل ومقسم يعرض **الرمز**، **معلومات آخر إغلاق**، **النطاق الفعلي (أعلى/أدنى)**، **النطاق المتوقع (أعلى/أدنى)**، و **نتيجة التوقع** (صحيح/خطأ).</li><li>النقر على صف في الجدول يؤدي إلى الانتقال لصفحة تفاصيل السهم.</li></ul> |
| **إدارة الأسهم**               | `manage:stocks`               | تسمح بإضافة، تعديل، وإدارة قائمة الأسهم التي يتتبعها النظام، مع ميزات التصفية والفرز والتقسيم.                                                                                                                                                                                                                                                                                                          |
| **إدارة الترجمات**             | `manage:translations`         | توفر واجهة مقسمة لتعديل جميع نصوص واجهة المستخدم (`key`, `value_en`, `value_ar`) المخزنة في قاعدة البيانات.                                                                                                                                                                                                                                                                                       |
| **تفاصيل السهم (Stock Details)** | `view:stock_analysis`         | صفحة تفصيلية مرتبطة من صفحة "آخر يوم عمل"، تعرض تحليلاً معمقًا لسهم واحد (رسم بياني 90 يومًا، توقع اليوم التالي، سجل التوقعات، المؤشرات الفنية، وأنماط الشموع).                                                                                                                                                                                                                                                                            |
| **سجل الأنشطة (Activity Log)**   | `view:activity_log`           | تعرض سجلاً مقسمًا ومفلتراً لجميع الإجراءات التي يتم تتبعها للمستخدم والنظام، |