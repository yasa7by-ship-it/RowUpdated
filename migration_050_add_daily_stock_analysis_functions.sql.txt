-- #############################################################################
-- #
-- # MIGRATION SCRIPT: Add Daily Stock Analysis Functions
-- #
-- # Purpose: This script creates a suite of new RPC functions to fetch
-- # forecast data and analysis specifically for the latest available day.
-- # This supports a redesigned, more focused "Stock Analysis" page.
-- #
-- # This script is safe to run multiple times.
-- #
-- #############################################################################

BEGIN;

-- Function 1: Get the most recent date for which forecasts exist.
CREATE OR REPLACE FUNCTION public.get_latest_forecast_date()
RETURNS date
LANGUAGE sql STABLE AS $$
  SELECT max(forecast_date) FROM public.forecasts;
$$;
RAISE NOTICE 'SUCCESS: RPC function "get_latest_forecast_date" created or updated.';


-- Function 2: Get high-level summary statistics for a specific date.
CREATE OR REPLACE FUNCTION public.get_daily_analysis_summary(p_date date)
RETURNS json
LANGUAGE sql STABLE AS $$
WITH daily_metrics AS (
    SELECT
        -- Use the pre-calculated hit_range for consistency
        afm.hit_range,
        afm.predicted_price,
        afm.actual_close
    FROM public.audit_forecast_metrics afm
    WHERE afm.forecast_date = p_date AND afm.actual_close IS NOT NULL
)
SELECT json_build_object(
    'forecast_date', p_date,
    'total_forecasts', (SELECT count(*) FROM daily_metrics),
    'hits', (SELECT count(*) FROM daily_metrics WHERE hit_range = true),
    'misses', (SELECT count(*) FROM daily_metrics WHERE hit_range = false),
    'hit_rate', (SELECT avg(CASE WHEN hit_range = true THEN 1 ELSE 0 END) FROM daily_metrics),
    'mape', (SELECT avg(abs(predicted_price - actual_close) / actual_close) FROM daily_metrics WHERE actual_close > 0)
);
$$;
RAISE NOTICE 'SUCCESS: RPC function "get_daily_analysis_summary" created or updated.';


-- Function 3: Get the detailed list of all forecast results for a specific date.
CREATE OR REPLACE FUNCTION public.get_daily_forecast_results(p_date date)
RETURNS TABLE (
    stock_symbol text,
    stock_name text,
    predicted_price real,
    predicted_lo real,
    predicted_hi real,
    actual_close real,
    actual_low real,
    actual_high real,
    is_hit boolean
)
LANGUAGE sql STABLE AS $$
SELECT
    afm.stock_symbol,
    s.name as stock_name,
    afm.predicted_price::real,
    afm.predicted_lo::real,
    afm.predicted_hi::real,
    afm.actual_close::real,
    hd.low as actual_low,
    hd.high as actual_high,
    -- Use the pre-calculated hit_range from the audit table for consistency
    afm.hit_range as is_hit
FROM
    public.audit_forecast_metrics afm
JOIN
    public.stocks s ON afm.stock_symbol = s.symbol
-- Use LEFT JOIN on historical_data in case it's missing, but actual_close exists in audit
LEFT JOIN
    public.historical_data hd ON afm.stock_symbol = hd.stock_symbol AND afm.forecast_date = hd.date
WHERE
    afm.forecast_date = p_date
ORDER BY
    afm.stock_symbol;
$$;
RAISE NOTICE 'SUCCESS: RPC function "get_daily_forecast_results" created or updated.';

COMMIT;
