-- #############################################################################
-- #
-- # MIGRATION SCRIPT: Add Admin Password Update Function
-- #
-- # Purpose: This script adds a secure RPC function that allows an authorized
-- # admin to change another user's password directly. This is required for
-- # the "Edit User" modal functionality.
-- #
-- # This script is safe to run multiple times.
-- #
-- #############################################################################

BEGIN;

CREATE OR REPLACE FUNCTION public.admin_update_user_password(user_id_to_update uuid, new_password text)
RETURNS void
LANGUAGE plpgsql
-- SECURITY DEFINER is necessary to modify the auth.users table.
SECURITY DEFINER
-- Set search path to ensure `has_permission` and `pgcrypto` functions are found.
SET search_path = public, extensions, auth
AS $$
BEGIN
  -- Security Check: Only allow users with 'manage:users' permission to run this.
  IF NOT public.has_permission('manage:users') THEN
    RAISE EXCEPTION 'Insufficient permissions: You need the "manage:users" permission to perform this action.';
  END IF;

  -- Validation: Ensure password meets minimum length.
  IF char_length(new_password) < 6 THEN
    RAISE EXCEPTION 'Password is too short. Minimum 6 characters required.';
  END IF;

  -- Perform the privileged action: Update the user's password in the auth schema.
  -- This requires the pgcrypto extension to be enabled.
  UPDATE auth.users
  SET encrypted_password = crypt(new_password, gen_salt('bf'))
  WHERE id = user_id_to_update;

END;
$$;

RAISE NOTICE 'SUCCESS: RPC function "admin_update_user_password" created or updated.';

COMMIT;
