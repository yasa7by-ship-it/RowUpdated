--- START OF FILE metadata.json ---
{
  "name": "Secure Admin Dashboard",
  "description": "A secure, role-based admin dashboard built from the ground up with React and Supabase. Features clean architecture, a robust permission system, and a professional user interface.",
  "requestFramePermissions": []
}
--- END OF FILE metadata.json ---
--- START OF FILE index.html ---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MRowDir</title>

    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#4338ca" />

    <!-- Apple PWA specific tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="MRowDir">
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    
    <script>
      // FOUC-prevention script to apply theme on initial load
      if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
      };
    </script>
    
    <script type="importmap">
{
  "imports": {
    "@supabase/supabase-js": "https://aistudiocdn.com/@supabase/supabase-js@^2.76.1",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@supabase/gotrue-js": "https://aistudiocdn.com/@supabase/gotrue-js@^2.78.0",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.28.0"
  }
}
</script>
  </head>
  <body class="bg-gray-50 dark:bg-gray-900">
    <div id="root"></div>
    <script type="module" src="/index.tsx"></script>

    <!-- PWA Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js').then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, err => {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script>
  </body>
</html>
--- END OF FILE index.html ---
--- START OF FILE index.tsx ---
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import { ThemeProvider } from './contexts/ThemeContext';
import { LanguageProvider } from './contexts/LanguageContext';
import { AppSettingsProvider } from './contexts/AppSettingsContext';
import { AuthProvider } from './contexts/AuthContext';
import { AnnouncementsProvider } from './contexts/AnnouncementsContext';
import { FavoritesProvider } from './contexts/FavoritesContext';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
} 

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <ThemeProvider>
      <AppSettingsProvider>
        <AuthProvider>
          <FavoritesProvider>
            <LanguageProvider>
              <AnnouncementsProvider>
                <App />
              </AnnouncementsProvider>
            </LanguageProvider>
          </FavoritesProvider>
        </AuthProvider>
      </AppSettingsProvider>
    </ThemeProvider>
  </React.StrictMode>
);
--- END OF FILE index.tsx ---
--- START OF FILE App.tsx ---
import React, { useState, useEffect } from 'react';
import Layout from './components/Layout';
import Dashboard from './components/pages/Dashboard';
import UserManagement from './components/pages/UserManagement';
import RoleManagement from './components/pages/RoleManagement';
import AnnouncementsManagement from './components/pages/AnnouncementsManagement';
import SystemDocumentation from './components/pages/SystemDocumentation';
import StockAnalysis from './components/pages/StockAnalysis';
import DailyWatchlist from './components/pages/DailyWatchlist';
import StockManagement from './components/pages/StockManagement';
import StockDetails from './components/pages/StockDetails';
import TranslationManagement from './components/pages/TranslationManagement';
import ActivityLog from './components/pages/ActivityLog';
import UserNotes from './components/pages/UserNotes'; // New
import UserNotesManagement from './components/pages/UserNotesManagement'; // New
import LandingPage from './components/pages/LandingPage';
import AccessDenied from './components/AccessDenied';
import { useLanguage } from './contexts/LanguageContext';
import { useAuth } from './contexts/AuthContext';
import type { PageName, PageState } from './types';

const App: React.FC = () => {
  const { session, loading, hasPermission, profile } = useAuth();
  const [currentPage, setCurrentPage] = useState<PageState>('landing');
  const { direction, t, language } = useLanguage();

  useEffect(() => {
    document.documentElement.dir = direction;
    document.documentElement.lang = language;
  }, [direction, language]);
  
  const currentPageName = typeof currentPage === 'string' ? currentPage : currentPage.page;
  
  // Effect to set the page title dynamically
  useEffect(() => {
    const pageTitleKeyMap: { [key in PageName]: string } = {
      landing: 'site_title',
      dashboard: 'dashboard',
      users: 'user_management',
      roles: 'role_management',
      announcements: 'announcement_management',
      system_documentation: 'system_documentation',
      stock_analysis: 'stock_analysis',
      daily_watchlist: 'daily_watchlist',
      stock_management: 'stock_management',
      translations: 'translation_management',
      stock_details: 'stock_details',
      activity_log: 'activity_log',
      user_notes: 'user_notes', // New
      user_notes_management: 'manage_user_notes', // New
    };
    const titleKey = pageTitleKeyMap[currentPageName];
    document.title = (currentPageName === 'landing' || !session) 
        ? t(titleKey)
        : `${t(titleKey)} | ${t('site_title')}`;
  }, [currentPageName, t, language, session]);

  // Effect to dynamically update PWA manifest and title
  useEffect(() => {
    const siteTitle = t('site_title');
    // Don't run if translation isn't ready or it's the default key
    if (!siteTitle || siteTitle === 'site_title') return;

    // Update apple-mobile-web-app-title meta tag
    const appleTitleTag = document.querySelector('meta[name="apple-mobile-web-app-title"]');
    if (appleTitleTag) {
      appleTitleTag.setAttribute('content', siteTitle);
    }
    
    // Create a dynamic manifest
    const manifest = {
      "short_name": siteTitle,
      "name": siteTitle,
      "description": "Professional and visually engaging stock price predictions for the U.S. markets.",
      "icons": [
        { "src": "/favicon.ico", "sizes": "64x64 32x32 24x24 16x16", "type": "image/x-icon" },
        { "src": "/icons/icon-192.png", "type": "image/png", "sizes": "192x192" },
        { "src": "/icons/icon-512.png", "type": "image/png", "sizes": "512x512" }
      ],
      "start_url": "/",
      "display": "standalone",
      "scope": "/",
      "theme_color": "#4338ca",
      "background_color": "#ffffff"
    };

    const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
    const manifestUrl = URL.createObjectURL(manifestBlob);

    // Update the manifest link tag
    const manifestLink = document.querySelector('link[rel="manifest"]');
    if (manifestLink) {
      manifestLink.setAttribute('href', manifestUrl);
    }

  }, [t, language]);

  // Effect to handle page access control and redirection
  useEffect(() => {
    if (loading || (session && !profile)) return; // Wait until authentication and profile loading is complete

    if (!session) {
      // If user is not logged in, they can only be on the landing page.
      if (currentPageName !== 'landing') {
        setCurrentPage('landing');
      }
      return;
    }

    // If user is logged in, check permissions for the current page.
    const pagePermissions: Record<PageName, string | null> = {
        landing: null, // Always allowed
        dashboard: 'view:dashboard',
        users: 'manage:users',
        roles: 'manage:roles',
        announcements: 'manage:announcements',
        system_documentation: 'view:system_documentation',
        stock_analysis: 'view:stock_analysis',
        daily_watchlist: 'view:daily_watchlist',
        stock_management: 'manage:stocks',
        translations: 'manage:translations',
        stock_details: 'view:stock_analysis', // Re-use stock_analysis permission
        activity_log: 'view:activity_log',
        user_notes: 'submit:user_notes', // Use dedicated permission
        user_notes_management: 'manage:user_notes', // Admin-only
    };
    
    const requiredPermission = pagePermissions[currentPageName];
    
    // If user is on a protected page but lacks permission, redirect them.
    if (requiredPermission && !hasPermission(requiredPermission)) {
        // Try redirecting to dashboard first. If they can't view that, send to landing.
        if (hasPermission('view:dashboard')) {
            setCurrentPage('dashboard');
        } else if (hasPermission('view:stock_analysis')) {
            setCurrentPage('stock_analysis'); // Redirect standard users to their default page
        } else {
            setCurrentPage('landing');
        }
    }
  }, [currentPageName, session, profile, hasPermission, loading]);
  
  if (loading || (session && !profile)) {
     return <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">{t('loading')}...</div>;
  }
  
  // The main layout is now always rendered. Header/Sidebar handle auth state.
  const renderPage = () => {
    const pageName = typeof currentPage === 'string' ? currentPage : currentPage.page;
    switch (pageName) {
      case 'users':
        return hasPermission('manage:users') ? <UserManagement /> : <AccessDenied />;
      case 'roles':
        return hasPermission('manage:roles') ? <RoleManagement /> : <AccessDenied />;
      case 'announcements':
        return hasPermission('manage:announcements') ? <AnnouncementsManagement /> : <AccessDenied />;
      case 'system_documentation':
        return hasPermission('view:system_documentation') ? <SystemDocumentation /> : <AccessDenied />;
      case 'stock_analysis':
        return hasPermission('view:stock_analysis') ? <StockAnalysis setPage={setCurrentPage} /> : <AccessDenied />;
      case 'daily_watchlist': 
        return hasPermission('view:daily_watchlist') ? <DailyWatchlist setPage={setCurrentPage} /> : <AccessDenied />;
      case 'stock_management':
        return hasPermission('manage:stocks') ? <StockManagement /> : <AccessDenied />;
      case 'translations':
        return hasPermission('manage:translations') ? <TranslationManagement /> : <AccessDenied />;
      case 'activity_log':
        return hasPermission('view:activity_log') ? <ActivityLog /> : <AccessDenied />;
      case 'user_notes': // New
        return hasPermission('submit:user_notes') ? <UserNotes /> : <AccessDenied />;
      case 'user_notes_management': // New
        return hasPermission('manage:user_notes') ? <UserNotesManagement /> : <AccessDenied />;
      case 'stock_details':
        if (typeof currentPage === 'object' && hasPermission('view:stock_analysis')) {
          return <StockDetails symbol={currentPage.symbol} setPage={setCurrentPage} />;
        }
        return <AccessDenied />;
      case 'dashboard':
        return hasPermission('view:dashboard') ? <Dashboard /> : <AccessDenied />;
      case 'landing':
      default:
        // The landing page should be accessible to everyone.
        return <LandingPage />;
    }
  };
  
  return (
    <Layout profile={profile} setPage={setCurrentPage} currentPage={currentPageName}>
      {renderPage()}
    </Layout>
  );
};

export default App;
--- END OF FILE App.tsx ---
--- START OF FILE types.ts ---
import { Type } from '@google/genai';

export interface Profile {
  id: string;
  full_name: string | null;
  email: string | null;
  role_id: string | null;
  email_confirmed_at: string | null;
  preferred_language: Language;
  // This nested structure is what we fetch from Supabase
  roles: {
    name: string;
    permissions: {
      action: string;
    }[];
  } | null;
}

export interface Role {
  id: string;
  name: string;
  description: string | null;
}

export interface Permission {
  id: string;
  action: string;
  description: string | null;
}

export interface RolePermission {
    role_id: string;
    permission_id: string;
}

export type AnnouncementType = 'info' | 'warning' | 'success' | 'error';

export interface GlobalAnnouncement {
    id: number;
    title: { [key: string]: string }; // For JSONB: { en: 'Title', ar: 'عنوان' }
    message: { [key: string]: string }; // For JSONB
    type: AnnouncementType;
    start_date: string; // ISO 8601 string
    end_date: string;   // ISO 8601 string
    is_enabled: boolean;
    created_at: string;
}

// FIX: Added the missing Advertisement interface to resolve import errors.
export interface Advertisement {
    id: number;
    title: { [key: string]: string }; // For JSONB: { en: 'Title', ar: 'عنوان' }
    advertiser_name: { [key: string]: string } | null; // For JSONB
    image_url: string | null;
    target_url: string | null;
    placement: string;
    start_date: string; // ISO 8601 string
    end_date: string;   // ISO 8601 string
    is_enabled: boolean;
    created_at: string;
}

export type Language = 'en' | 'ar';
export type Theme = 'light' | 'dark';

export type Translations = {
  [key: string]: string;
};

export type AppSettings = {
  [key: string]: string;
};

// --- App Navigation Types ---
export type PageName = 'landing' | 'dashboard' | 'users' | 'roles' | 'announcements' | 'system_documentation' | 'stock_analysis' | 'daily_watchlist' | 'stock_management' | 'translations' | 'stock_details' | 'activity_log' | 'user_notes' | 'user_notes_management';
export type PageState = PageName | { page: 'stock_details'; symbol: string };


// --- System Documentation Types ---

export interface ColumnDocumentation {
    name: string;
    type: string;
    nullable: 'YES' | 'NO';
    default: string | null;
    description: string | null;
}

export interface TableDocumentation {
    name: string;
    description: string | null;
    columns: ColumnDocumentation[];
}

export interface FunctionDocumentation {
    name: string;
    definition: string;
}

export interface PolicyDocumentation {
    table: string;
    name: string;
    command: 'SELECT' | 'INSERT' | 'UPDATE' | 'DELETE' | 'ALL';
    definition: string | null;
    with_check: string | null;
}

export interface DatabaseDocumentation {
    tables: TableDocumentation[];
    functions: FunctionDocumentation[];
    policies: PolicyDocumentation[];
}

// --- Stock Analysis Types ---
export interface DailyChecklistItem {
  stock_symbol: string;
  stock_name: string;
  last_updated: string | null;
  price: number | null;
  actual_low: number;
  actual_high: number;
  predicted_lo: number;
  predicted_hi: number;
  is_hit: boolean;
  forecast_date: string;
}

export interface DailyWatchlistItem {
  // Stock info
  symbol: string;
  stock_name: string;
  last_price: number | null;
  daily_change: number | null;
  daily_change_percent: number | null;
  
  // Next upcoming forecast
  next_forecast_date: string | null;
  next_predicted_lo: number | null;
  next_predicted_hi: number | null;
  
  // Latest technical indicators
  indicator_date: string | null;
  rsi: number | null;
  macd: number | null;
  macd_signal: number | null;
  sma20: number | null;
  sma50: number | null;

  // Latest candle pattern
  pattern_name: string | null;
  bullish: boolean | null;
}


// --- NEW Stock Management Type ---
export interface Stock {
  symbol: string;
  name: string;
  is_tracked: boolean;
  price?: number | null;
  change?: number | null;
  change_percent?: number | null;
  volume?: number | null;
  market_cap?: number | null;
  last_updated?: string | null;
}


// --- OLD / UNUSED TYPES ---
export interface StockListItem {
    symbol: string;
    name: string;
}

export interface StockDetails {
    symbol: string;
    name: string;
    price: number;
    change: number;
    change_percent: number;
    volume: number;
    market_cap: number;
    last_updated: string;
    is_tracked: boolean;
}

export interface HistoricalData {
    id: number;
    stock_symbol: string;
    date: string;
    open: number;
    high: number;
    low: number;
    close: number;
    volume: number;
}

export interface TechnicalIndicators {
    id: number;
    stock_symbol: string;
    date: string;
    rsi: number | null;
    macd: number | null;
    macd_signal: number | null;
    macd_histogram: number | null;
    sma20: number | null;
    sma50: number | null;
    sma200: number | null;
    ema12: number | null;
    ema26: number | null;
    boll_upper: number | null;
    boll_middle: number | null;
    boll_lower: number | null;
    stochastic_k: number | null;
    stochastic_d: number | null;
    williams_r: number | null;
    volatility_20: number | null;
    atr14: number | null;
    macd_cross: number | null;
    rsi_zone: number | null;
}

export interface CandlePattern {
    id: number;
    stock_symbol: string;
    date: string;
    pattern_name: string;
    bullish: boolean;
    confidence: number;
}

export interface Forecast {
    id: number;
    stock_symbol: string;
    forecast_date: string;
    predicted_price: number;
    predicted_lo: number;
    predicted_hi: number;
    confidence: number;
}

export interface ForecastHistory {
    run_id: number;
    stock_symbol: string;
    forecast_date: string;
    predicted_price: number;
    actual_close: number;
    hit_range: boolean;
}

export interface StockDeepDive {
    details: StockDetails;
    historical_data: HistoricalData[];
    technical_indicators: TechnicalIndicators[];
    candle_patterns: CandlePattern[];
    latest_forecast: Forecast | null;
    forecast_history: ForecastHistory[];
}

// --- Stock Details Page Types ---

export interface ForecastCheckHistoryItem {
    stock_symbol: string;
    forecast_date: string;
    predicted_price: number | null;
    predicted_lo: number;
    predicted_hi: number;
    actual_low: number;
    actual_high: number;
    actual_close: number | null;
    hit_range: boolean;
    abs_error: number | null;
    pct_error: number | null;
    confidence: number | null;
    created_at: string;
}

export interface StockDetailsPageData {
    details: Stock | null;
    next_forecast: Forecast | null;
    historical_data: HistoricalData[];
    latest_indicators: TechnicalIndicators | null;
    forecast_history: ForecastCheckHistoryItem[];
    recent_patterns: CandlePattern[];
}

// --- NEW Activity Log Type ---
export interface ActivityLogItem {
  id: number;
  created_at: string;
  user_full_name: string | null;
  user_email: string | null;
  action: string;
  ip_address: string | null;
  details: any; // JSONB
  total_count: number;
}

// --- NEW User Notes Types ---
export interface UserNote {
  id: number;
  created_at: string;
  user_id: string;
  note_content: string;
  user_full_name: string | null; // From JOIN
  user_email: string | null; // From JOIN
  total_count: number; // For pagination
}
--- END OF FILE types.ts ---
--- START OF FILE services/supabaseClient.ts ---
import { createClient } from '@supabase/supabase-js';

// --- Hybrid Storage for Session Persistence ---
const getStorage = (): Storage => {
    try {
        const persist = window.localStorage.getItem('session-persistence') === 'true';
        return persist ? window.localStorage : window.sessionStorage;
    } catch (e) {
        // Fallback for non-browser env
        const memoryStorage = new Map<string, string>();
        return {
            getItem: (key: string): string | null => memoryStorage.get(key) ?? null,
            // FIX: Wrapped arrow function body in curly braces to prevent implicitly returning the Map instance, which conflicts with the 'void' return type.
            setItem: (key: string, value: string): void => { memoryStorage.set(key, value); },
            // FIX: Wrapped arrow function body in curly braces to prevent implicitly returning a boolean, which conflicts with the 'void' return type.
            removeItem: (key: string): void => { memoryStorage.delete(key); },
            get length(): number { return memoryStorage.size; },
            clear: (): void => memoryStorage.clear(),
            key: (index: number): string | null => Array.from(memoryStorage.keys())[index] ?? null,
        };
    }
};

const hybridStorage = {
    getItem: (key: string) => {
        return getStorage().getItem(key);
    },
    setItem: (key: string, value: string) => {
        getStorage().setItem(key, value);
    },
    removeItem: (key: string) => {
        getStorage().removeItem(key);
    },
};

export const setSessionPersistence = (persist: boolean) => {
    try {
        window.localStorage.setItem('session-persistence', String(persist));
    } catch (e) {
        console.error("Could not set session persistence:", e);
    }
};
// --- End of Hybrid Storage ---

const supabaseUrl = "https://bojrgkiqsahuwufbkacm.supabase.co";
const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvanJna2lxc2FodXd1ZmJrYWNtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MDc5OTUsImV4cCI6MjA3NzA4Mzk5NX0.xnPnpbttZDkkNMkHYSGkA0UP-DCc7s70aa9X1KGGwQY";

if (!supabaseUrl || !supabaseAnonKey) {
    throw new Error("Supabase URL and Anon Key must be provided.");
}

export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
    auth: {
        storage: hybridStorage,
    }
});
--- END OF FILE services/supabaseClient.ts ---
--- START OF FILE contexts/ThemeContext.tsx ---
import React, { createContext, useState, useEffect, useContext, ReactNode } from 'react';
import type { Theme } from '../types';

interface ThemeContextType {
  theme: Theme;
  setTheme: (theme: Theme) => void;
}

const ThemeContext = createContext<ThemeContextType | undefined>(undefined);

export const ThemeProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  // Initialize state from localStorage or system preference
  const [theme, setThemeState] = useState<Theme>(() => {
    if (typeof window !== 'undefined' && localStorage.getItem('theme')) {
      return localStorage.getItem('theme') as Theme;
    }
    if (typeof window !== 'undefined' && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      return 'dark';
    }
    return 'light';
  });

  // Effect to apply the theme class to the <html> element
  useEffect(() => {
    const root = window.document.documentElement;
    root.classList.remove('light', 'dark');
    root.classList.add(theme);
    localStorage.setItem('theme', theme);
  }, [theme]);

  return (
    <ThemeContext.Provider value={{ theme, setTheme: setThemeState }}>
      {children}
    </ThemeContext.Provider>
  );
};

export const useTheme = (): ThemeContextType => {
  const context = useContext(ThemeContext);
  if (context === undefined) {
    throw new Error('useTheme must be used within a ThemeProvider');
  }
  return context;
};
--- END OF FILE contexts/ThemeContext.tsx ---
--- START OF FILE contexts/LanguageContext.tsx ---
import React, { createContext, useState, useEffect, useContext, ReactNode, useCallback, useRef } from 'react';
import type { Language, Translations } from '../types';
import { supabase } from '../services/supabaseClient';
import { useAuth } from './AuthContext';

type LanguageDirection = 'ltr' | 'rtl';

interface LanguageContextType {
  language: Language;
  setLanguage: (language: Language) => void;
  t: (key: string) => string;
  direction: LanguageDirection;
  refetchTranslations: () => void;
}

const LanguageContext = createContext<LanguageContextType | undefined>(undefined);

// --- Caching State ---
let translationsCache: Translations | null = null;
// ---------------------

export const LanguageProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const { session, profile, refetchProfile } = useAuth();
  
  const [language, setLanguageState] = useState<Language>(
    (localStorage.getItem('language') as Language) || 'en'
  );
  const [translations, setTranslations] = useState<Translations>(translationsCache || {});
  const [loading, setLoading] = useState(!translationsCache);

  // This ref tracks the language that a fetch was initiated for to prevent race conditions.
  const fetchController = useRef({ lang: language });

  // Effect to load user's preferred language upon login
  useEffect(() => {
    if (profile?.preferred_language && profile.preferred_language !== language) {
        translationsCache = null;
        setTranslations({});
        setLanguageState(profile.preferred_language as Language);
    }
  }, [profile, language]);

  const fetchTranslations = useCallback(async (lang: Language, forceRefetch = false) => {
    // When a fetch starts, update the controller to signify this is the "current" fetch.
    fetchController.current.lang = lang;
    
    if (translationsCache && !forceRefetch) {
      return;
    }
    
    if (forceRefetch) {
      translationsCache = null;
    }

    setLoading(true);
    const { data, error } = await supabase.rpc('get_translations', { p_lang_code: lang });

    // After the await, check if the language we fetched for is still the desired language.
    // If not, it means a new language change happened, and this data is stale. Discard it.
    if (fetchController.current.lang !== lang) {
        setLoading(false); // Another fetch is likely running, but we should clear this loading state.
        return; // Abort setting state with stale data.
    }

    if (error) {
      console.error('Error fetching translations:', error);
    } else {
        const newTranslations = (data || []).reduce((acc: Translations, row) => {
          acc[row.key] = row.value;
          return acc;
        }, {});
        translationsCache = newTranslations;
        setTranslations(newTranslations);
    }
    setLoading(false);
  }, []); // Keep empty deps, setters are stable & ref doesn't need to be a dependency.

  useEffect(() => {
    if (session && !profile) return;
    fetchTranslations(language);
  }, [language, fetchTranslations, session, profile]);

  const setLanguage = async (newLanguage: Language) => {
    if (newLanguage === language) return;
    
    // Clear cache and state before changing language
    translationsCache = null;
    setTranslations({});
    setLanguageState(newLanguage);
    localStorage.setItem('language', newLanguage);

    if (session && profile) {
        const { error } = await supabase
            .from('profiles')
            .update({ preferred_language: newLanguage })
            .eq('id', profile.id);

        if (error) {
            console.error('Error saving language preference:', error);
        } else {
            // After successfully saving, refetch the profile to keep the context in sync.
            refetchProfile();
        }
    }
  };

  const t = (key: string): string => {
    return translations[key] || key;
  };
  
  const direction: LanguageDirection = language === 'ar' ? 'rtl' : 'ltr';

  const refetchTranslations = useCallback(() => {
    fetchTranslations(language, true); // Force refetch
  }, [language, fetchTranslations]);

  const value = { language, setLanguage, t, direction, refetchTranslations };
  
  const showLoader = loading && Object.keys(translations).length === 0;

  return (
    <LanguageContext.Provider value={value}>
      {!showLoader ? children : <div className="min-h-screen flex items-center justify-center">Loading Language...</div>}
    </LanguageContext.Provider>
  );
};

export const useLanguage = (): LanguageContextType => {
  const context = useContext(LanguageContext);
  if (context === undefined) {
    throw new Error('useLanguage must be used within a LanguageProvider');
  }
  return context;
};
--- END OF FILE contexts/LanguageContext.tsx ---
--- START OF FILE contexts/AppSettingsContext.tsx ---
import React, { createContext, useState, useEffect, useContext, ReactNode, useCallback } from 'react';
import { supabase } from '../services/supabaseClient';
import type { AppSettings } from '../types';

interface AppSettingsContextType {
  settings: AppSettings;
  loading: boolean;
  updateSetting: (key: string, value: string) => Promise<void>;
  refetchSettings: () => void;
}

const AppSettingsContext = createContext<AppSettingsContextType | undefined>(undefined);

// --- Caching State ---
let settingsCache: AppSettings | null = null;
// ---------------------

export const AppSettingsProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [settings, setSettings] = useState<AppSettings>(settingsCache || {});
  const [loading, setLoading] = useState(!settingsCache);

  const fetchSettings = useCallback(async (forceRefetch = false) => {
    if (settingsCache && !forceRefetch) {
      if(loading) setLoading(false);
      return;
    }
    
    if (forceRefetch) {
        settingsCache = null;
    }
    
    setLoading(true);
    const { data, error } = await supabase.rpc('get_all_app_settings');

    if (error) {
      console.error('Error fetching app settings:', error.message || JSON.stringify(error));
      setSettings({});
    } else {
      const newSettings = (data || []).reduce((acc: AppSettings, row) => {
        if (row.key) acc[row.key] = row.value || '';
        return acc;
      }, {});
      settingsCache = newSettings;
      setSettings(newSettings);
    }
    setLoading(false);
  }, [loading]);

  useEffect(() => {
    fetchSettings();
  }, []);

  const updateSetting = async (key: string, value: string) => {
    const { error } = await supabase
      .from('app_settings')
      .upsert({ key, value }, { onConflict: 'key' });

    if (error) {
        console.error(`Error updating setting ${key}:`, error);
        throw error;
    } else {
        // Update local state and cache
        const newSettings = { ...settings, [key]: value };
        setSettings(newSettings);
        settingsCache = newSettings;
    }
  };
  
  const refetchSettings = useCallback(() => {
    fetchSettings(true); // Force refetch
  }, [fetchSettings]);

  const value = { settings, loading, updateSetting, refetchSettings };

  return (
    <AppSettingsContext.Provider value={value}>
      {!loading ? children : <div className="min-h-screen flex items-center justify-center">Loading Settings...</div>}
    </AppSettingsContext.Provider>
  );
};

export const useAppSettings = (): AppSettingsContextType => {
  const context = useContext(AppSettingsContext);
  if (context === undefined) {
    throw new Error('useAppSettings must be used within an AppSettingsProvider');
  }
  return context;
};
--- END OF FILE contexts/AppSettingsContext.tsx ---
--- START OF FILE contexts/AuthContext.tsx ---
import React, { createContext, useState, useEffect, useContext, ReactNode, useCallback, useMemo, useRef } from 'react';
import type { Session, User } from '@supabase/supabase-js';
import { supabase } from '../services/supabaseClient';
import type { Profile } from '../types';

interface AuthContextType {
  session: Session | null;
  profile: Profile | null;
  loading: boolean;
  hasPermission: (action: string) => boolean;
  refetchProfile: () => void;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

const delay = (ms: number) => new Promise(res => setTimeout(res, ms));

// --- Caching ---
const getProfileCacheKey = (userId: string) => `user-profile-${userId}`;

const saveProfileToCache = (profile: Profile) => {
  try {
    const key = getProfileCacheKey(profile.id);
    localStorage.setItem(key, JSON.stringify(profile));
  } catch (e) {
    console.error("Failed to save profile to cache", e);
  }
};

const loadProfileFromCache = (user: User): Profile | null => {
  try {
    const key = getProfileCacheKey(user.id);
    const cachedProfileString = localStorage.getItem(key);
    if (cachedProfileString) {
      const cachedProfile: Profile = JSON.parse(cachedProfileString);
      if (cachedProfile && cachedProfile.id === user.id) {
        console.log("Loaded profile from cache.");
        return cachedProfile;
      }
    }
  } catch (e) {
    console.error("Failed to load profile from cache", e);
  }
  return null;
};

const clearProfileCache = (user: User | null) => {
  if (user) {
    try {
      const key = getProfileCacheKey(user.id);
      localStorage.removeItem(key);
    } catch (e) {
      console.error("Failed to clear profile cache", e);
    }
  }
};
// --- End Caching ---

export const AuthProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [session, setSession] = useState<Session | null>(null);
  const [profile, setProfile] = useState<Profile | null>(null);
  const [permissions, setPermissions] = useState<Set<string>>(new Set());
  const [loading, setLoading] = useState(true);
  const sessionRef = useRef<Session | null>(null);

  const setProfileState = (newProfile: Profile | null) => {
    if (newProfile) {
      const permissionActions = newProfile.roles?.permissions?.map(p => p.action) ?? [];
      setProfile(newProfile);
      setPermissions(new Set(permissionActions));
    } else {
      setProfile(null);
      setPermissions(new Set());
    }
  };

  const fetchProfileAndPermissions = useCallback(async (user: User, signal?: AbortSignal): Promise<boolean> => {
    let profileData: Profile | null = null;
    let attempts = 0;
    const maxAttempts = 3;

    while (attempts < maxAttempts && !profileData) {
      attempts++;
      const { data, error } = await supabase
        .rpc('get_user_profile_and_permissions', { p_user_id: user.id })
        .abortSignal(signal)
        .single();

      if (signal?.aborted) {
        console.log("Profile fetch aborted.");
        return false;
      }

      if (!error && data) {
        profileData = data as Profile;
      } else {
        console.error(`Profile fetch attempt ${attempts} failed:`, error?.message || 'No profile data returned');
        if (attempts < maxAttempts) {
          await delay(500 * Math.pow(2, attempts - 1));
        }
      }
    }

    if (profileData) {
      setProfileState(profileData);
      saveProfileToCache(profileData);
      return true;
    } else {
      return false;
    }
  }, []);

  useEffect(() => {
    setLoading(true);
    const controller = new AbortController();

    const { data: { subscription } } = supabase.auth.onAuthStateChange(async (_event, newSession) => {
      const previousSession = sessionRef.current;
      sessionRef.current = newSession;

      if (controller.signal.aborted) {
        return;
      }
      
      if (!newSession) {
        if (previousSession?.user) {
          clearProfileCache(previousSession.user);
        }
        setSession(null);
        setProfileState(null);
        setLoading(false);
        return;
      }
      
      setSession(newSession);

      const cachedProfile = loadProfileFromCache(newSession.user);
      if (cachedProfile) {
        setProfileState(cachedProfile);
        setLoading(false);
        
        fetchProfileAndPermissions(newSession.user, controller.signal);
      } else {
        setLoading(true);
        const success = await fetchProfileAndPermissions(newSession.user, controller.signal);
        if (!success && !controller.signal.aborted) {
          console.error("Initial profile fetch failed with no cache. Forcing sign-out.");
          await supabase.auth.signOut();
        }
        setLoading(false);
      }
    });

    const handleVisibilityChange = async () => {
        if (document.visibilityState === 'visible') {
            // Calling getSession() will automatically attempt to refresh the token if it's expired.
            // The onAuthStateChange listener above will handle any changes to the session state
            // (e.g., if the refresh fails and the user is logged out). This is safer than
            // refreshSession() which can error if no refresh token is present.
            await supabase.auth.getSession();
        }
    };
    
    document.addEventListener('visibilitychange', handleVisibilityChange);

    return () => {
      controller.abort();
      subscription?.unsubscribe();
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, [fetchProfileAndPermissions]);
  
  const refetchProfile = useCallback(async () => {
    if (session?.user) {
      setLoading(true);
      try {
        await fetchProfileAndPermissions(session.user);
      } catch(e) {
        console.error("Manual profile refetch failed.", e);
      } finally {
        setLoading(false);
      }
    }
  }, [session, fetchProfileAndPermissions]);

  const hasPermission = useCallback((action: string): boolean => {
    return permissions.has(action);
  }, [permissions]);

  const value = useMemo(() => ({ session, profile, loading, hasPermission, refetchProfile }), 
    [session, profile, loading, hasPermission, refetchProfile]);

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
};

export const useAuth = (): AuthContextType => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};
--- END OF FILE contexts/AuthContext.tsx ---
--- START OF FILE contexts/AnnouncementsContext.tsx ---
import React, { createContext, useState, useEffect, useContext, ReactNode, useCallback } from 'react';
import { supabase } from '../services/supabaseClient';
import type { GlobalAnnouncement } from '../types';

interface AnnouncementsContextType {
  announcements: GlobalAnnouncement[];
  loading: boolean;
  refetchAnnouncements: () => void;
}

const AnnouncementsContext = createContext<AnnouncementsContextType | undefined>(undefined);

// --- Caching State ---
let announcementsCache: GlobalAnnouncement[] | null = null;
// ---------------------

export const AnnouncementsProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [announcements, setAnnouncements] = useState<GlobalAnnouncement[]>(announcementsCache || []);
  const [loading, setLoading] = useState(!announcementsCache);

  const fetchActiveAnnouncements = useCallback(async (forceRefetch = false) => {
    // Polling should not block UI with a loader
    if (!forceRefetch) {
      setLoading(false); 
    } else {
      setLoading(true);
      announcementsCache = null;
    }
    
    const { data, error } = await supabase.rpc('get_active_announcements');

    if (error) {
      console.error('Error fetching announcements:', error);
      setAnnouncements([]);
      announcementsCache = [];
    } else {
      const newAnnouncements = data || [];
      setAnnouncements(newAnnouncements);
      announcementsCache = newAnnouncements;
    }
    setLoading(false);
  }, []);

  useEffect(() => {
    // Initial fetch
    if (!announcementsCache) {
      fetchActiveAnnouncements(true);
    }
    
    // Set up a poller to refetch announcements periodically in the background
    const interval = setInterval(() => fetchActiveAnnouncements(false), 5 * 60 * 1000); // every 5 minutes
    
    return () => clearInterval(interval);
  }, [fetchActiveAnnouncements]);

  const refetchAnnouncements = useCallback(() => {
    fetchActiveAnnouncements(true); // Force a refetch
  }, [fetchActiveAnnouncements]);

  const value = { announcements, loading, refetchAnnouncements };

  return (
    <AnnouncementsContext.Provider value={value}>
      {children}
    </AnnouncementsContext.Provider>
  );
};

export const useAnnouncements = (): AnnouncementsContextType => {
  const context = useContext(AnnouncementsContext);
  if (context === undefined) {
    throw new Error('useAnnouncements must be used within an AnnouncementsProvider');
  }
  return context;
};
--- END OF FILE contexts/AnnouncementsContext.tsx ---
--- START OF FILE contexts/FavoritesContext.tsx ---
import React, { createContext, useState, useEffect, useContext, ReactNode, useCallback } from 'react';
import { supabase } from '../services/supabaseClient';
import { useAuth } from './AuthContext';

interface FavoritesContextType {
  favoriteSymbols: Set<string>;
  isFavorite: (symbol: string) => boolean;
  toggleFavorite: (symbol: string) => Promise<void>;
  refetchFavorites: () => void;
  loading: boolean;
}

const FavoritesContext = createContext<FavoritesContextType | undefined>(undefined);

export const FavoritesProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const { session } = useAuth();
  const [favoriteSymbols, setFavoriteSymbols] = useState<Set<string>>(new Set());
  const [loading, setLoading] = useState(true);

  const fetchFavorites = useCallback(async () => {
    if (!session) {
      setFavoriteSymbols(new Set());
      setLoading(false);
      return;
    }

    setLoading(true);
    const { data, error } = await supabase.rpc('get_user_favorite_stocks');
    if (error) {
      console.error("Error fetching favorites:", error);
    } else {
      setFavoriteSymbols(new Set(data.map((item: any) => item.stock_symbol)));
    }
    setLoading(false);
  }, [session]);

  useEffect(() => {
    fetchFavorites();
  }, [fetchFavorites]);
  
  const isFavorite = (symbol: string) => favoriteSymbols.has(symbol);

  const toggleFavorite = async (symbol: string) => {
    if (!session) return;
    const originalFavorites = new Set(favoriteSymbols);
    
    // Optimistic update
    setFavoriteSymbols(prev => {
      const newFavorites = new Set(prev);
      if (newFavorites.has(symbol)) {
        newFavorites.delete(symbol);
      } else {
        newFavorites.add(symbol);
      }
      return newFavorites;
    });

    // RPC call
    const { error } = await supabase.rpc('toggle_favorite_stock', { p_symbol: symbol });
    
    if (error) {
      console.error("Error toggling favorite:", error);
      // Revert on error
      setFavoriteSymbols(originalFavorites);
    }
  };
  
  const value = { favoriteSymbols, isFavorite, toggleFavorite, refetchFavorites: fetchFavorites, loading };

  return <FavoritesContext.Provider value={value}>{children}</FavoritesContext.Provider>;
};

export const useFavorites = (): FavoritesContextType => {
  const context = useContext(FavoritesContext);
  if (context === undefined) {
    throw new Error('useFavorites must be used within a FavoritesProvider');
  }
  return context;
};
--- END OF FILE contexts/FavoritesContext.tsx ---
--- START OF FILE components/Layout.tsx ---
import React, { ReactNode } from 'react';
import Header from './Header';
import AnnouncementsBanner from './AnnouncementsBanner';
import AddToHomeScreenPrompt from './AddToHomeScreenPrompt'; // Import the new component
import type { Profile, PageName, PageState } from '../types';

interface LayoutProps {
  profile: Profile | null;
  children: ReactNode;
  setPage: (page: PageState) => void;
  currentPage: PageName;
}

const Layout: React.FC<LayoutProps> = ({ profile, children, setPage, currentPage }) => {
  // definitive fix to eliminate all unwanted white space below content. 
  // Restructured the main layout to use flex-grow, ensuring the content area only takes the height it needs, 
  // while allowing other pages to fill the viewport correctly. 
  // Also synchronized the background color with the main HTML body for a seamless appearance. This permanently resolves the layout issue.
  return (
    <div className="flex flex-col min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
      <Header profile={profile} setPage={setPage} currentPage={currentPage} />
      <AnnouncementsBanner />
      <main className="flex-grow">
        <div className="container mx-auto px-6 py-8">
          {children}
        </div>
      </main>
      <AddToHomeScreenPrompt /> {/* Add the component here */}
    </div>
  );
};

export default Layout;
--- END OF FILE components/Layout.tsx ---
--- START OF FILE components/Header.tsx ---
import React, { useState, useEffect, useRef } from 'react';
import { supabase, setSessionPersistence } from '../services/supabaseClient';
import { useTheme } from '../contexts/ThemeContext';
import { useLanguage } from '../contexts/LanguageContext';
import { useAuth } from '../contexts/AuthContext';
import { useAppSettings } from '../contexts/AppSettingsContext';
import {
  SunIcon, MoonIcon, ArrowRightOnRectangleIcon, SpinnerIcon, SearchChartIcon,
  ChartPieIcon, UsersIcon, ShieldCheckIcon, MegaphoneIcon, DocumentTextIcon, ChartBarIcon,
  BuildingOfficeIcon, Cog6ToothIcon, ChevronDownIcon, LanguageIcon, ExclamationTriangleIcon, InformationCircleIcon,
  ClipboardListIcon, EyeIcon, PencilSquareIcon, Bars3Icon, XMarkIcon, GoogleIcon,
  EnvelopeIcon, UserPlusIcon
} from './icons';
import type { Profile, PageName, PageState } from '../types';
import SignUpModal from './SignUpModal';

// Helper function moved outside the main component to prevent re-declaration on every render.
const getInitials = (name?: string | null, email?: string | null) => {
  if (name?.trim()) {
      const parts = name.trim().split(' ');
      if (parts.length > 1) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      return parts[0][0].toUpperCase();
  }
  return email ? email.charAt(0).toUpperCase() : '?';
};

// --- Logged In View Component ---
const LoggedInView: React.FC<{
  profile: Profile | null;
  isProfileOpen: boolean;
  setProfileOpen: (value: boolean) => void;
  profileMenuRef: React.RefObject<HTMLDivElement>;
  isSigningOut: boolean;
  handleSignOut: () => Promise<void>;
}> = ({ profile, isProfileOpen, setProfileOpen, profileMenuRef, isSigningOut, handleSignOut }) => {
  const { t } = useLanguage();
  const displayName = profile?.full_name?.trim() ? profile.full_name : profile?.email;
  
  return (
     <div className="relative" ref={profileMenuRef}>
        <button onClick={() => setProfileOpen(!isProfileOpen)} className="flex items-center space-x-2 rtl:space-x-reverse p-1 rounded-md hover:bg-indigo-700">
        <span className="hidden sm:inline text-sm font-medium text-white px-2 truncate max-w-[150px]">{displayName}</span>
        <div className="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold shrink-0">
            {getInitials(profile?.full_name, profile?.email)}
        </div>
        </button>

        {isProfileOpen && (
        <div className="absolute right-0 rtl:left-0 rtl:right-auto mt-2 w-64 bg-white dark:bg-gray-800 rounded-md shadow-lg border dark:border-gray-700 z-10">
            <div className="p-4 border-b dark:border-gray-700 text-start">
            <p className="font-semibold text-gray-800 dark:text-gray-200 truncate">{displayName}</p>
            <p className="text-sm text-gray-500 dark:text-gray-400 truncate">{profile?.roles?.name ? t(`role_${profile.roles.name}`) : t('no_role')}</p>
            </div>
            <ul className="py-1">
            <li><button 
                onClick={handleSignOut} 
                className="w-full text-start flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-75"
                disabled={isSigningOut}
            >
                {isSigningOut ? (
                    <>
                        <SpinnerIcon className="w-5 h-5 mr-3 rtl:ml-3 rtl:mr-0" />
                        {t('signing_out')}...
                    </>
                ) : (
                    <>
                        <ArrowRightOnRectangleIcon className="w-5 h-5 mr-3 rtl:ml-3 rtl:mr-0" />
                        {t('sign_out')}
                    </>
                )}
            </button></li>
            </ul>
        </div>
        )}
    </div>
  );
};

// --- Logged Out View Component (Restored) ---
const LoggedOutView: React.FC<{ setPage: (page: PageState) => void; setSignUpModalOpen: (isOpen: boolean) => void; }> = ({ setPage, setSignUpModalOpen }) => {
  const { t } = useLanguage();
  const [rememberMe, setRememberMe] = useState(() => localStorage.getItem('session-persistence') === 'true');
  const [email, setEmail] = useState(() => {
      const isRemembered = localStorage.getItem('session-persistence') === 'true';
      return (isRemembered && localStorage.getItem('rememberedEmail')) || '';
  });
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [notification, setNotification] = useState<{ type: 'info' | 'error', message: string } | null>(null);

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setNotification(null);
    try {
      setSessionPersistence(rememberMe);
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) throw error;
      
      if (rememberMe) {
        localStorage.setItem('rememberedEmail', email);
      } else {
        localStorage.removeItem('rememberedEmail');
      }
    } catch (err: any) {
      const errorMessage = (err.message || '').toLowerCase();
      if (errorMessage.includes('email not confirmed') || errorMessage.includes('invalid refresh token')) {
          setNotification({ type: 'info', message: t('email_not_confirmed_message') });
      } else {
          setNotification({ type: 'error', message: t('login_failed') });
      }
      setTimeout(() => setNotification(null), 5000);
    } finally {
      setLoading(false);
    }
  };
  
   const signInWithGoogle = async () => {
        setLoading(true);
        const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
        });
        if (error) {
            setNotification({ type: 'error', message: t('google_sign_in_failed') + `: ${error.message}` });
            setLoading(false);
        }
        // On success, Supabase redirects.
    };

  return (
    <div className="relative">
      {/* --- Unified View for Desktop & Mobile --- */}
      <div className="flex items-center space-x-2 rtl:space-x-reverse">
        <button
            type="button"
            onClick={signInWithGoogle}
            disabled={loading}
            title={t('sign_in_with_google')}
            aria-label={t('sign_in_with_google')}
            className="h-9 w-9 flex items-center justify-center border border-transparent rounded-md shadow-sm text-white bg-[#4285F4] hover:bg-[#357ae8] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
        >
            <GoogleIcon className="w-5 h-5" />
        </button>

        <details className="relative group">
            <summary
                title={t('login_with_email')}
                aria-label={t('login_with_email')}
                className="h-9 w-9 list-none bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center justify-center cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500">
                <EnvelopeIcon className="w-5 h-5" />
            </summary>
            <div className="absolute top-full right-0 rtl:right-auto rtl:left-0 mt-2 p-6 bg-white dark:bg-gray-800 rounded-lg shadow-xl w-[340px] z-10 border dark:border-gray-700 group-open:animate-fade-in-down">
                <form onSubmit={handleLogin} className="flex flex-col space-y-4">
                    <div className="flex flex-col">
                        <label htmlFor="header-email" className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{t('email_or_phone')}</label>
                        <input
                            id="header-email"
                            type="email"
                            autoComplete="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            className="h-10 w-full px-3 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                        />
                    </div>
                     <div className="flex flex-col">
                        <label htmlFor="header-password" className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{t('password')}</label>
                        <input
                            id="header-password"
                            type="password"
                            autoComplete="current-password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className="h-10 w-full px-3 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                        />
                    </div>
                    <div className="flex items-center justify-between">
                        <div className="flex items-center">
                            <input
                                id="header-remember-me"
                                type="checkbox"
                                checked={rememberMe}
                                onChange={(e) => setRememberMe(e.target.checked)}
                                className="h-4 w-4 rounded border-gray-400 text-blue-600 focus:ring-blue-500 dark:border-gray-500 dark:bg-gray-600 dark:ring-offset-gray-800"
                            />
                            <label htmlFor="header-remember-me" className="ml-2 rtl:ml-0 rtl:mr-2 text-sm text-gray-700 dark:text-gray-300">
                                {t('remember_me')}
                            </label>
                        </div>
                    </div>
                    <button
                        type="submit"
                        disabled={loading}
                        className="h-10 px-6 bg-blue-600 text-white text-sm font-bold rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"
                    >
                        {loading ? <SpinnerIcon className="w-5 h-5" /> : t('login')}
                    </button>
                </form>
            </div>
        </details>
        
        <button
            type="button"
            onClick={() => setSignUpModalOpen(true)}
            title={t('sign_up')}
            aria-label={t('sign_up')}
            className="h-9 w-9 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center justify-center"
            >
            <UserPlusIcon className="w-5 h-5" />
        </button>
      </div>
      
      {notification && (
          <div className={`absolute top-full mt-2 right-0 rtl:right-auto rtl:left-0 p-4 rounded-lg shadow-lg w-auto min-w-[300px] z-10 flex items-center gap-3 ${
              notification.type === 'info'
                  ? 'bg-blue-100 dark:bg-blue-900/40 border border-blue-200 dark:border-blue-800/50'
                  : 'bg-red-100 dark:bg-red-900/40 border border-red-200 dark:border-red-800/50'
          }`}>
              {notification.type === 'info' ? (
                  <InformationCircleIcon className="w-6 h-6 text-blue-500 dark:text-blue-400 shrink-0" />
              ) : (
                  <ExclamationTriangleIcon className="w-6 h-6 text-red-500 dark:text-red-400 shrink-0" />
              )}
              <p className={`text-base font-medium ${
                  notification.type === 'info' ? 'text-blue-800 dark:text-blue-200' : 'text-red-800 dark:text-red-200'
              }`}>
                  {notification.message}
              </p>
          </div>
      )}
    </div>
  );
};


// --- Main Header Component ---
const Header: React.FC<{
  profile: Profile | null;
  setPage: (page: PageState) => void;
  currentPage: PageName;
}> = ({ profile, setPage, currentPage }) => {
  const { theme, setTheme } = useTheme();
  const { language, setLanguage, t } = useLanguage();
  const { hasPermission } = useAuth();
  const { settings } = useAppSettings();
  
  const [isSignUpModalOpen, setSignUpModalOpen] = useState(false);
  const [isProfileOpen, setProfileOpen] = useState(false);
  const [isLanguageOpen, setLanguageOpen] = useState(false);
  const [isSiteMgmtOpen, setSiteMgmtOpen] = useState(false);
  const [isSigningOut, setIsSigningOut] = useState(false);
  const [isMobileMenuOpen, setMobileMenuOpen] = useState(false);
  
  const profileMenuRef = useRef<HTMLDivElement>(null);
  const languageMenuRef = useRef<HTMLDivElement>(null);
  const siteMgmtMenuRef = useRef<HTMLDivElement>(null);
  
  const handleSignOut = async () => {
    setIsSigningOut(true);
    const { error } = await supabase.auth.signOut();

    if (error) {
        console.error('Error signing out:', error);
        // On error, reset state and close menu
        setIsSigningOut(false);
        setProfileOpen(false);
    } else {
        // A full page reload is the most robust way to ensure all state,
        // including context and cached data, is completely cleared on sign-out.
        // This is especially reliable for OAuth sessions where state listeners might not fire immediately.
        window.location.reload();
    }
  };

  // Close mobile menu on resize to desktop
  useEffect(() => {
    const handleResize = () => {
        if (window.innerWidth >= 768) { // 768px is tailwind's 'md' breakpoint
            setMobileMenuOpen(false);
        }
    };
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (profileMenuRef.current && !profileMenuRef.current.contains(event.target as Node)) {
        setProfileOpen(false);
      }
      if (languageMenuRef.current && !languageMenuRef.current.contains(event.target as Node)) {
        setLanguageOpen(false);
      }
       if (siteMgmtMenuRef.current && !siteMgmtMenuRef.current.contains(event.target as Node)) {
        setSiteMgmtOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);
  
  // FIX: Added `isVisuallyDistinct` to all navLink objects to ensure a consistent shape and prevent destructuring errors.
  const navLinks = [
    { page: 'daily_watchlist', label: t('daily_watchlist'), Icon: EyeIcon, permission: 'view:daily_watchlist', isVisuallyDistinct: false },
    { page: 'stock_analysis', label: t('stock_analysis'), Icon: ChartBarIcon, permission: 'view:stock_analysis', isVisuallyDistinct: false },
    { page: 'user_notes', label: t('user_notes'), Icon: PencilSquareIcon, permission: 'submit:user_notes', isVisuallyDistinct: true }, // New Link
  ] as const;
  
  const siteManagementLinks = [
      { page: 'dashboard', label: t('dashboard'), Icon: ChartPieIcon, permission: 'view:dashboard' },
      { page: 'users', label: t('user_management'), Icon: UsersIcon, permission: 'manage:users' },
      { page: 'roles', label: t('role_management'), Icon: ShieldCheckIcon, permission: 'manage:roles' },
      { page: 'announcements', label: t('announcement_management'), Icon: MegaphoneIcon, permission: 'manage:announcements' },
      { page: 'user_notes_management', label: t('manage_user_notes'), Icon: PencilSquareIcon, permission: 'manage:user_notes'}, // New
      { page: 'stock_management', label: t('stock_management'), Icon: BuildingOfficeIcon, permission: 'manage:stocks' },
      { page: 'translations', label: t('translation_management'), Icon: LanguageIcon, permission: 'manage:translations'},
      { page: 'system_documentation', label: t('system_documentation'), Icon: DocumentTextIcon, permission: 'view:system_documentation' },
      { page: 'activity_log', label: t('activity_log'), Icon: ClipboardListIcon, permission: 'view:activity_log' },
  ] as const;
  
  const canViewSiteManagement = siteManagementLinks.some(link => hasPermission(link.permission));

  return (
    <>
        {isSignUpModalOpen && (
            <SignUpModal
                onClose={() => setSignUpModalOpen(false)}
                onSuccess={() => setSignUpModalOpen(false)}
            />
        )}
        <header className="bg-indigo-800 dark:bg-gray-800 shadow-md p-2 md:p-4 flex justify-between items-center z-20">
        <div className="flex items-center space-x-4 rtl:space-x-reverse">
            <a href="#" onClick={(e) => { e.preventDefault(); setPage('landing'); }} className="flex items-center space-x-2 rtl:space-x-reverse">
                <span className="inline-block w-8 h-8 text-white" dangerouslySetInnerHTML={{ __html: settings.site_logo || '' }} />
                <span className="text-white font-bold text-xl">{t('site_title')}</span>
            </a>
            
            {/* Main navigation for logged-in users */}
            {profile && (
                <nav className="hidden md:flex items-center space-x-1 rtl:space-x-reverse bg-indigo-900/50 dark:bg-gray-900/50 p-1 rounded-lg">
                    {navLinks.filter(link => hasPermission(link.permission)).map(({ page, label, Icon, isVisuallyDistinct }) => (
                        <a key={page} href="#" onClick={(e) => { e.preventDefault(); setPage(page); }}
                            className={`flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-md transition-all duration-200 ${
                                isVisuallyDistinct
                                ? (currentPage === page ? 'bg-amber-400 text-black shadow-inner' : 'bg-amber-300 dark:bg-amber-500 text-black hover:bg-amber-400 dark:hover:bg-amber-600')
                                : (currentPage === page ? 'bg-white dark:bg-gray-700 text-indigo-700 dark:text-white' : 'text-indigo-200 hover:bg-indigo-700 hover:text-white')
                            }`}>
                            <Icon className="w-5 h-5" />
                            {label}
                        </a>
                    ))}
                    
                    {/* Site Management Dropdown */}
                    {canViewSiteManagement && (
                        <div className="relative" ref={siteMgmtMenuRef}>
                            <button onClick={() => setSiteMgmtOpen(!isSiteMgmtOpen)}
                            className="flex items-center px-3 py-1.5 text-sm font-medium rounded-md transition-colors text-indigo-200 hover:bg-indigo-700 hover:text-white">
                                {t('site_management')}
                                <ChevronDownIcon className="w-4 h-4 ml-1 rtl:mr-1" />
                            </button>
                            {isSiteMgmtOpen && (
                                <div className="absolute ltr:left-0 rtl:right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-md shadow-lg border dark:border-gray-700 z-10">
                                    <ul className="py-1">
                                        {siteManagementLinks.filter(link => hasPermission(link.permission)).map(({ page, label, Icon }) => (
                                            <li key={page}>
                                                <a href="#" onClick={(e) => { e.preventDefault(); setPage(page); setSiteMgmtOpen(false); }} className="w-full text-start flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                                    <Icon className="w-5 h-5 mr-3 rtl:ml-3" />
                                                    {label}
                                                </a>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            )}
                        </div>
                    )}
                </nav>
            )}
        </div>

        <div className="flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse rtl:md:space-x-reverse">
            {profile ? (
            <LoggedInView
                profile={profile}
                isProfileOpen={isProfileOpen}
                setProfileOpen={setProfileOpen}
                profileMenuRef={profileMenuRef}
                isSigningOut={isSigningOut}
                handleSignOut={handleSignOut}
            />
            ) : (
                <LoggedOutView setPage={setPage} setSignUpModalOpen={setSignUpModalOpen} />
            )}
            
             {/* Desktop-only controls */}
            <div className="hidden md:flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse rtl:md:space-x-reverse">
                {/* Theme Toggle */}
                <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className="p-2 rounded-full hover:bg-indigo-700 text-white" aria-label={theme === 'dark' ? t('light_theme') : t('dark_theme')}>
                    {theme === 'dark' ? <SunIcon /> : <MoonIcon />}
                </button>

                {/* Language Selector */}
                <div className="relative" ref={languageMenuRef}>
                    <button onClick={() => setLanguageOpen(!isLanguageOpen)} className="p-2 rounded-full hover:bg-indigo-700 text-white" aria-label={t('select_language')}>
                        <LanguageIcon />
                    </button>
                    {isLanguageOpen && (
                        <div className="absolute right-0 rtl:left-0 rtl:right-auto mt-2 w-32 bg-white dark:bg-gray-800 rounded-md shadow-lg border dark:border-gray-700 z-10">
                            <ul className="py-1">
                                <li><button onClick={() => { setLanguage('en'); setLanguageOpen(false); }} className="w-full text-start px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">English</button></li>
                                <li><button onClick={() => { setLanguage('ar'); setLanguageOpen(false); }} className="w-full text-start px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">العربية</button></li>
                            </ul>
                        </div>
                    )}
                </div>
            </div>

             {/* Mobile-only Hamburger Menu Button */}
            {profile && (
                <div className="md:hidden">
                    <button onClick={() => setMobileMenuOpen(!isMobileMenuOpen)} className="p-2 rounded-full hover:bg-indigo-700 text-white" aria-label={t('toggle_navigation')}>
                        {isMobileMenuOpen ? <XMarkIcon className="w-6 h-6"/> : <Bars3Icon className="w-6 h-6"/>}
                    </button>
                </div>
            )}
        </div>
        </header>

        {/* Mobile Menu Panel */}
        {isMobileMenuOpen && profile && (
            <div className="md:hidden absolute top-[56px] left-0 right-0 bg-indigo-900 dark:bg-gray-800 shadow-lg z-10 p-4 border-t border-indigo-700 dark:border-gray-700">
                <nav className="flex flex-col space-y-1">
                    {navLinks.filter(link => hasPermission(link.permission)).map(({ page, label, Icon, isVisuallyDistinct }) => (
                         <a key={page} href="#" onClick={(e) => { e.preventDefault(); setPage(page); setMobileMenuOpen(false); }}
                            className={`flex items-center gap-3 p-3 text-base font-medium rounded-md ${
                                isVisuallyDistinct
                                ? (currentPage === page ? 'bg-amber-400 text-black' : 'bg-amber-300/80 dark:bg-amber-500/80 text-black hover:bg-amber-400')
                                : (currentPage === page ? 'bg-white dark:bg-gray-700 text-indigo-700 dark:text-white' : 'text-indigo-200 hover:bg-indigo-700 hover:text-white')
                            }`}>
                            <Icon className="w-6 h-6" />
                            {label}
                        </a>
                    ))}
                    
                    {canViewSiteManagement && (
                        <>
                            <hr className="border-indigo-700 dark:border-gray-600 my-2" />
                            <h3 className="px-3 pt-2 pb-1 text-xs font-semibold text-indigo-300 dark:text-gray-400 uppercase tracking-wider">{t('site_management')}</h3>
                             {siteManagementLinks.filter(link => hasPermission(link.permission)).map(({ page, label, Icon }) => (
                                <a key={page} href="#" onClick={(e) => { e.preventDefault(); setPage(page); setMobileMenuOpen(false); }}
                                    className={`flex items-center gap-3 p-3 text-base font-medium rounded-md ${currentPage === page ? 'bg-white dark:bg-gray-700 text-indigo-700 dark:text-white' : 'text-indigo-200 hover:bg-indigo-700 hover:text-white'}`}>
                                    <Icon className="w-6 h-6" />
                                    {label}
                                </a>
                            ))}
                        </>
                    )}

                    {/* Controls */}
                    <hr className="border-indigo-700 dark:border-gray-600 my-2" />
                    <div className="px-3 py-2 flex justify-between items-center text-indigo-200">
                        <span>{t('theme')}</span>
                        <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className="p-2 rounded-full hover:bg-indigo-700" aria-label={theme === 'dark' ? t('light_theme') : t('dark_theme')}>
                            {theme === 'dark' ? <SunIcon /> : <MoonIcon />}
                        </button>
                    </div>
                     <div className="px-3 py-2 flex justify-between items-center text-indigo-200">
                        <span>{t('language')}</span>
                        <div className="flex gap-2">
                            {/* FIX: Removed erroneous function calls on the `language` string variable. The `language` variable is a string, not a function. */}
                            <button onClick={() => { setLanguage('en'); setMobileMenuOpen(false); }} className={`px-3 py-1 text-sm font-bold rounded ${language === 'en' ? 'bg-white text-indigo-700' : 'bg-indigo-800 hover:bg-indigo-700'}`}>EN</button>
                            <button onClick={() => { setLanguage('ar'); setMobileMenuOpen(false); }} className={`px-3 py-1 text-sm font-bold rounded ${language === 'ar' ? 'bg-white text-indigo-700' : 'bg-indigo-800 hover:bg-indigo-700'}`}>AR</button>
                        </div>
                    </div>
                </nav>
            </div>
        )}
        <style>{`
            @keyframes fade-in-down {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade-in-down {
                animation: fade-in-down 0.2s ease-out forwards;
            }
        `}</style>
    </>
  );
};

export default Header;
--- END OF FILE components/Header.tsx ---
--- START OF FILE components/Sidebar.tsx ---
import React from 'react';
import { useLanguage } from '../contexts/LanguageContext';
import { useAppSettings } from '../contexts/AppSettingsContext';
import { useAuth } from '../contexts/AuthContext';
// FIX: Removed unused and non-existent MsftIcon import.
import { ChartPieIcon, UsersIcon, ShieldCheckIcon, MegaphoneIcon, DocumentTextIcon, ChartBarIcon } from './icons';

interface SidebarProps {
  setPage: (page: 'dashboard' | 'users' | 'roles' | 'landing' | 'announcements' | 'system_documentation' | 'stock_analysis') => void;
  currentPage: 'dashboard' | 'users' | 'roles' | 'landing' | 'announcements' | 'system_documentation' | 'stock_analysis';
}

const NavLink: React.FC<{ icon: React.ReactNode; label: string; isActive: boolean; onClick: () => void; }> = ({ icon, label, isActive, onClick }) => {
  const { direction } = useLanguage();
  const activeBarClass = direction === 'rtl' ? 'right-0 rounded-l-md' : 'left-0 rounded-r-md';

  return (
    <div className="relative">
      <a href="#" onClick={(e) => { e.preventDefault(); onClick(); }}
        className={`flex items-center w-full px-4 py-2.5 text-sm font-medium rounded-md transition-colors duration-200 ${ isActive ? 'bg-blue-50 text-blue-600 dark:bg-blue-900/50 dark:text-white' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700'}`}>
        <span className="w-6 h-6 shrink-0">{icon}</span>
        <span className="mx-3">{label}</span>
      </a>
      {isActive && <span className={`absolute top-1/2 -translate-y-1/2 h-2/3 w-1 bg-blue-600 ${activeBarClass}`}></span>}
    </div>
  );
};

const Sidebar: React.FC<SidebarProps> = ({ setPage, currentPage }) => {
  const { t } = useLanguage();
  const { settings } = useAppSettings();
  const { hasPermission, session } = useAuth();

  if (!session) {
    return null; // Don't render sidebar if not logged in
  }

  return (
    <aside className="hidden md:flex flex-col w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 shrink-0">
      <nav className="flex-1 px-4 py-4 space-y-2 mt-16">
        {hasPermission('view:stock_analysis') && (
            <NavLink icon={<ChartBarIcon />} label={t('stock_analysis')} isActive={currentPage === 'stock_analysis'} onClick={() => setPage('stock_analysis')} />
        )}
        {hasPermission('manage:users') && (
            <NavLink icon={<UsersIcon />} label={t('user_management')} isActive={currentPage === 'users'} onClick={() => setPage('users')} />
        )}
        {hasPermission('manage:roles') && (
            <NavLink icon={<ShieldCheckIcon />} label={t('role_management')} isActive={currentPage === 'roles'} onClick={() => setPage('roles')} />
        )}
        {hasPermission('manage:announcements') && (
            <NavLink icon={<MegaphoneIcon />} label={t('announcements')} isActive={currentPage === 'announcements'} onClick={() => setPage('announcements')} />
        )}
        {hasPermission('view:system_documentation') && (
            <NavLink icon={<DocumentTextIcon />} label={t('system_documentation')} isActive={currentPage === 'system_documentation'} onClick={() => setPage('system_documentation')} />
        )}
        {hasPermission('view:dashboard') && (
            <NavLink icon={<ChartPieIcon />} label={t('dashboard')} isActive={currentPage === 'dashboard'} onClick={() => setPage('dashboard')} />
        )}
      </nav>
    </aside>
  );
};

export default Sidebar;
--- END OF FILE components/Sidebar.tsx ---
--- START OF FILE components/icons.tsx ---
import React from 'react';

const iconProps = {
  width: "24",
  height: "24",
  fill: "none",
  viewBox: "0 0 24 24",
  strokeWidth: "1.5",
  stroke: "currentColor",
  className: "w-6 h-6"
};

const solidIconProps = {
  width: "24",
  height: "24",
  viewBox: "0 0 24 24",
  fill: "currentColor",
  className: "w-6 h-6"
};

// FIX: Updated all icons to accept an optional `className` prop to allow for flexible styling.
export const SunIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>;
export const MoonIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25c0 5.385 4.365 9.75 9.75 9.75 2.572 0 4.92-.99 6.697-2.648z" /></svg>;
export const UserCircleIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" /></svg>;
export const ArrowRightOnRectangleIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>;
export const ArrowRightEndOnRectangleIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" /></svg>;
export const Cog6ToothIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-.962a8.958 8.958 0 017.486 7.486c.045.55-.422 1.02-.962 1.11-.244.038-.478.062-.71.082a9.006 9.006 0 01-1.07 1.07c.02.232.044.466.082.71.09.542-.368 1.065-.962 1.11a8.958 8.958 0 01-7.486-7.486c-.045-.55.422-1.02.962-1.11.244-.038.478-.062.71-.082a9.007 9.007 0 011.07-1.07c-.02-.232-.044-.466-.082-.71zM15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>;
export const ChartPieIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M10.5 6a7.5 7.5 0 100 12 7.5 7.5 0 000-12zm0 0v6m0 0h6m-6 0l-5.25 5.25" /></svg>;
export const UsersIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.663v.005zM18 8.25a4.125 4.125 0 11-8.25 0 4.125 4.125 0 018.25 0z" /></svg>;
export const ShieldCheckIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751A11.953 11.953 0 0112 2.75z" /></svg>;
export const SearchChartIcon: React.FC<{className?: string}> = ({className}) => (
    <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none">
        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" fill="currentColor"/>
        <path d="M9.5 7.5L8 9h3L9.5 7.5z" fill="#34D399"/>
        <path d="M9.5 11.5L8 10h3l-1.5 1.5z" fill="#EF4444"/>
    </svg>
);
export const PlusIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>;
export const CheckIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} width="20" height="20" className={className || "w-5 h-5 text-blue-600"}><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>;
export const SparklesIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.562L16.25 22.5l-.648-1.938a2.25 2.25 0 01-1.476-1.476L12 18.75l1.938-.648a2.25 2.25 0 011.476-1.476L17.5 15l.648 1.938a2.25 2.25 0 011.476 1.476L21.5 18.75l-1.938.648a2.25 2.25 0 01-1.476 1.476z" /></svg>;
export const PencilIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>;
export const CheckBadgeIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
export const XMarkIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>;
export const SpinnerIcon: React.FC<{className?: string}> = ({className}) => (
    <svg className={`animate-spin ${className || 'h-5 w-5 text-white'}`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
);

// FIX: Added all missing icon components to resolve import errors across the application.
export const MegaphoneIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 016-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C11.176 10.658 7.69 15.08 3 17.502" /></svg>;
export const DocumentTextIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>;
export const ChartBarIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>;
export const BuildingOfficeIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h1.5m-1.5 3h1.5m-1.5 3h1.5m3-6h1.5m-1.5 3h1.5m-1.5 3h1.5M9 21v-3.375c0-.621.504-1.125 1.125-1.125h3.75c.621 0 1.125.504 1.125 1.125V21" /></svg>;
export const ChevronDownIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>;
export const LanguageIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A11.953 11.953 0 0112 13.5c-2.998 0-5.74-1.1-7.843-2.918" /></svg>;
export const ExclamationTriangleIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126z" /></svg>;
export const InformationCircleIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg>;
export const ClipboardListIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>;
export const EyeIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.432 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>;
export const PlayIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" /></svg>;
export const CheckCircleIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
export const XCircleIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
export const TrashIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>;
export const CalendarDaysIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18" /></svg>;
export const ArrowLeftIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg>;
export const ArrowUpIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M12 19.5v-15m0 0l-6.75 6.75M12 4.5l6.75 6.75" /></svg>;
export const ArrowDownIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m0 0l6.75-6.75M12 19.5l-6.75-6.75" /></svg>;
export const StarIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" /></svg>;
export const PencilSquareIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>;
export const Bars3Icon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>;
export const ArrowUpOnSquareIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15M12 15V4.5m0 0l-3 3m3-3l3 3" /></svg>;
export const EnvelopeIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" /></svg>;
export const UserPlusIcon: React.FC<{className?: string}> = ({className}) => <svg {...iconProps} className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z" /></svg>;
export const GoogleIcon: React.FC<{className?: string}> = ({className}) => (
    <svg className={className || "w-5 h-5"} viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
        <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12
        c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24
        c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/>
        <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657
        C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/>
        <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36
        c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/>
        <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574
        l6.19,5.238C39.99,36.623,44,30.651,44,24C44,22.659,43.862,21.35,43.611,20.083z"/>
    </svg>
);
--- END OF FILE components/icons.tsx ---
--- START OF FILE components/AccessDenied.tsx ---
import React from 'react';
import { useLanguage } from '../contexts/LanguageContext';

const AccessDenied: React.FC = () => {
    const { t } = useLanguage();
    return (
        <div className="flex flex-col items-center justify-center text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-md h-full">
            <h1 className="text-2xl font-bold text-red-600 dark:text-red-400">{t('access_denied')}</h1>
            <p className="mt-2 text-gray-600 dark:text-gray-400">{t('no_permission_message')}</p>
        </div>
    );
};

export default AccessDenied;
--- END OF FILE components/AccessDenied.tsx ---
--- START OF FILE components/SignUpModal.tsx ---
import React, { useState } from 'react';
import { useLanguage } from '../../contexts/LanguageContext';
import { supabase } from '../services/supabaseClient';
import { GoogleIcon, XMarkIcon, SpinnerIcon } from './icons';

interface SignUpModalProps {
  onClose: () => void;
  onSuccess: () => void;
}

const SignUpModal: React.FC<SignUpModalProps> = ({ onClose, onSuccess }) => {
  const { t } = useLanguage();
  const [loading, setLoading] = useState(false);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [fullName, setFullName] = useState('');
  const [error, setError] = useState<string | null>(null);

  const handleSignUp = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);

    if (password !== confirmPassword) {
      setError(t('passwords_do_not_match'));
      return;
    }
    
    setLoading(true);
    try {
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            full_name: fullName,
          },
        },
      });
      
      if (error) {
        throw error;
      }

      if (data.user && !data.session) {
        setLoading(false);
        setError(t('user_already_registered'));
        return;
      }

      onSuccess();
      onClose();
    } catch (err: any) {
      console.error('Sign up error:', err);
      if (err.message && err.message.toLowerCase().includes('user already registered')) {
          setError(t('user_already_registered'));
      } else {
          setError(t('signup_failed'));
      }
    } finally {
      setLoading(false);
    }
  };
  
  const signInWithGoogle = async () => {
        setLoading(true);
        const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
        });
        if (error) {
            setError(t('google_sign_in_failed') + `: ${error.message}`);
            setLoading(false);
        }
        // On success, Supabase redirects.
    };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" onClick={onClose}>
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md" onClick={e => e.stopPropagation()}>
        <div className="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <h2 className="text-xl font-semibold text-gray-900 dark:text-white">{t('create_account')}</h2>
            <button type="button" onClick={onClose} className="p-1 rounded-full text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">
              <XMarkIcon className="w-6 h-6" />
            </button>
        </div>
        <div className="p-6">
            <button
                type="button"
                onClick={signInWithGoogle}
                disabled={loading}
                className="w-full h-12 px-4 flex items-center justify-center border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 transition-colors"
            >
                <GoogleIcon className="w-5 h-5 mr-3 rtl:ml-3 rtl:mr-0" />
                {t('sign_up_with_google')}
            </button>
            <div className="relative my-4">
                <div className="absolute inset-0 flex items-center" aria-hidden="true">
                    <div className="w-full border-t border-gray-300 dark:border-gray-600" />
                </div>
                <div className="relative flex justify-center text-sm">
                    <span className="bg-white dark:bg-gray-800 px-2 text-gray-500 dark:text-gray-400">{t('or_separator')}</span>
                </div>
            </div>
            <form onSubmit={handleSignUp} className="space-y-4">
                {error && <div className="p-3 bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 rounded-md text-sm">{error}</div>}
                <div>
                  <label htmlFor="signUpFullName" className="text-sm font-medium text-gray-700 dark:text-gray-300">{t('full_name')}</label>
                  <input id="signUpFullName" type="text" value={fullName} onChange={(e) => setFullName(e.target.value)}
                         className="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                         placeholder={t('full_name')} required />
                </div>
                <div>
                  <label htmlFor="signUpEmail" className="text-sm font-medium text-gray-700 dark:text-gray-300">{t('email')}</label>
                  <input id="signUpEmail" type="email" value={email} onChange={(e) => setEmail(e.target.value)}
                         className="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                         placeholder="your@email.com" required />
                </div>
                <div>
                  <label htmlFor="signUpPassword" className="text-sm font-medium text-gray-700 dark:text-gray-300">{t('password')}</label>
                  <input id="signUpPassword" type="password" value={password} onChange={(e) => setPassword(e.target.value)} minLength={6}
                         className="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                         placeholder="••••••••" required />
                </div>
                <div>
                  <label htmlFor="confirmPassword" className="text-sm font-medium text-gray-700 dark:text-gray-300">{t('confirm_password')}</label>
                  <input id="confirmPassword" type="password" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} minLength={6}
                         className="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                         placeholder="••••••••" required />
                </div>
                 <div className="pt-2 flex justify-end items-center space-x-3 rtl:space-x-reverse">
                    <button type="button" onClick={onClose} className="py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">{t('cancel')}</button>
                    <button type="submit" disabled={loading} className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 flex items-center">
                      {loading && <SpinnerIcon className="w-4 h-4 mr-2 rtl:mr-0 rtl:ml-2" />}
                      {loading ? t('loading') : t('sign_up')}
                    </button>
                  </div>
            </form>
        </div>
      </div>
    </div>
  );
};

export default SignUpModal;
--- END OF FILE components/SignUpModal.tsx ---
--- START OF FILE components/LoginCard.tsx ---
import React, { useState, useEffect } from 'react';
import { supabase, setSessionPersistence } from '../services/supabaseClient';
import { useLanguage } from '../../contexts/LanguageContext';
import { GoogleIcon, SpinnerIcon } from './icons';
import SignUpModal from './SignUpModal';

const LoginCard: React.FC = () => {
    const { t } = useLanguage();
    const [loading, setLoading] = useState(false);
    
    const [rememberMe, setRememberMe] = useState(() => localStorage.getItem('session-persistence') === 'true');
    const [email, setEmail] = useState(() => {
        const isRemembered = localStorage.getItem('session-persistence') === 'true';
        return (isRemembered && localStorage.getItem('rememberedEmail')) || '';
    });

    const [password, setPassword] = useState('');
    const [notification, setNotification] = useState<{ type: 'info' | 'error', message: string } | null>(null);
    const [isSignUpModalOpen, setSignUpModalOpen] = useState(false);

    const handleLogin = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setNotification(null);
        try {
          setSessionPersistence(rememberMe);

          const { error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;

          if (rememberMe) {
            localStorage.setItem('rememberedEmail', email);
          } else {
            localStorage.removeItem('rememberedEmail');
          }

          setPassword('');
        } catch (error: any) {
           const errorMessage = (error.message || '').toLowerCase();
           if (errorMessage.includes('email not confirmed') || errorMessage.includes('invalid refresh token')) {
              setNotification({ type: 'info', message: t('email_not_confirmed_message') });
          } else {
              setNotification({ type: 'error', message: error.error_description || error.message || t('login_failed') });
          }
          setTimeout(() => setNotification(null), 5000);
        } finally {
          setLoading(false);
        }
    };
    
    const signInWithGoogle = async () => {
        setLoading(true);
        const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
        });
        if (error) {
            setNotification({ type: 'error', message: t('google_sign_in_failed') + `: ${error.message}` });
            setLoading(false);
        }
        // On success, Supabase redirects.
    };

    return (
        <>
            {isSignUpModalOpen && <SignUpModal onClose={() => setSignUpModalOpen(false)} onSuccess={() => setNotification({ type: 'info', message: t('signup_success') })} />}
            <div className="w-full max-w-sm bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 border border-gray-200 dark:border-gray-700">
                <h2 className="text-2xl font-bold text-center text-gray-900 dark:text-white mb-2">{t('site_title')}</h2>
                <p className="text-center text-sm text-gray-500 dark:text-gray-400 mb-6">{t('landing_page_description')}</p>
                {notification && (
                    <div className={`mb-4 p-3 text-sm rounded-md text-center ${
                        notification.type === 'info'
                            ? 'bg-blue-50 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300'
                            : 'bg-red-50 text-red-800 dark:bg-red-900/30 dark:text-red-300'
                    }`}>
                        {notification.message}
                    </div>
                )}
                <form onSubmit={handleLogin} className="space-y-4">
                    <div>
                        <label htmlFor="email" className="sr-only">{t('email')}</label>
                        <input type="email" id="email" autoComplete="email" value={email} onChange={e => setEmail(e.target.value)} placeholder={t('email')}
                               className="w-full h-12 px-4 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required />
                    </div>
                    <div>
                        <label htmlFor="password" className="sr-only">{t('password')}</label>
                        <input type="password" id="password" autoComplete="current-password" value={password} onChange={e => setPassword(e.target.value)} placeholder="••••••••"
                               className="w-full h-12 px-4 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required />
                    </div>
                     <div className="flex items-center justify-between">
                        <div className="flex items-center">
                          <input id="remember-me" name="remember-me" type="checkbox" checked={rememberMe} onChange={(e) => setRememberMe(e.target.checked)}
                                 className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500" />
                          <label htmlFor="remember-me" className="ml-2 rtl:mr-2 rtl:ml-0 block text-sm text-gray-700 dark:text-gray-300">
                            {t('remember_me')}
                          </label>
                        </div>
                    </div>
                    <button type="submit" disabled={loading}
                            className="w-full h-12 px-4 flex items-center justify-center border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 transition-colors">
                        {loading ? <SpinnerIcon className="w-5 h-5" /> : t('login')}
                    </button>
                </form>

                <div className="relative my-6">
                    <div className="absolute inset-0 flex items-center" aria-hidden="true">
                        <div className="w-full border-t border-gray-300 dark:border-gray-600" />
                    </div>
                    <div className="relative flex justify-center text-sm">
                        <span className="bg-white dark:bg-gray-800 px-2 text-gray-500 dark:text-gray-400">{t('or_separator')}</span>
                    </div>
                </div>
                
                <div>
                    <button
                        type="button"
                        onClick={signInWithGoogle}
                        disabled={loading}
                        className="w-full h-12 px-4 flex items-center justify-center border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 transition-colors"
                    >
                        <GoogleIcon className="w-5 h-5 mr-3" />
                        {t('sign_in_with_google')}
                    </button>
                </div>
                
                <p className="mt-6 text-center text-sm">
                    <button onClick={() => setSignUpModalOpen(true)} className="font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400">
                        {t('create_new_account')}
                    </button>
                </p>
            </div>
        </>
    );
};

export default LoginCard;
--- END OF FILE components/LoginCard.tsx ---
--- START OF FILE components/AddToHomeScreenPrompt.tsx ---
import React, { useState, useEffect } from 'react';
import { useLanguage } from '../contexts/LanguageContext';
import { ArrowUpOnSquareIcon, PlusIcon, XMarkIcon } from './icons';

const AddToHomeScreenPrompt: React.FC = () => {
    const { t } = useLanguage();
    const [isVisible, setIsVisible] = useState(false);
    const [platform, setPlatform] = useState<'ios' | 'android' | 'other'>('other');

    useEffect(() => {
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
        const dismissed = sessionStorage.getItem('dismissedA2HSPrompt');
        
        if (isStandalone || dismissed) {
            return;
        }

        const userAgent = window.navigator.userAgent.toLowerCase();
        const isIOS = /iphone|ipad|ipod/.test(userAgent);
        const isAndroid = /android/.test(userAgent);
        
        if (isIOS) {
            setPlatform('ios');
            setIsVisible(true);
        } else if (isAndroid) {
            setPlatform('android');
            setIsVisible(true);
        }

    }, []);

    const handleDismiss = () => {
        sessionStorage.setItem('dismissedA2HSPrompt', 'true');
        setIsVisible(false);
    };

    if (!isVisible) {
        return null;
    }

    const iosInstructions = (
        <div className="flex items-center gap-2 sm:gap-3 flex-wrap justify-center">
            <span className="text-base">{t('a2hs_ios_prompt_1')}</span>
            <ArrowUpOnSquareIcon className="w-6 h-6 shrink-0" />
            <span className="text-base">{t('a2hs_ios_prompt_2')}</span>
            <PlusIcon className="w-6 h-6 shrink-0" />
            <span className="font-semibold text-base">{`"${t('add_to_home_screen')}"`}</span>
        </div>
    );

    const androidInstructions = (
        <div className="flex items-center gap-3">
             <span className="text-base">{t('a2hs_android_prompt')}</span>
        </div>
    );

    return (
        <div className="fixed bottom-0 left-0 right-0 z-50 p-4 animate-fade-in-up" dir={t('direction')}>
            <div className="container mx-auto">
                <div className="bg-gray-800 dark:bg-gray-900 text-white p-4 rounded-lg shadow-2xl flex items-center justify-between gap-4">
                    <div className="flex-grow">
                        {platform === 'ios' ? iosInstructions : androidInstructions}
                    </div>
                    <button 
                        onClick={handleDismiss} 
                        className="p-2 rounded-full hover:bg-white/10 shrink-0"
                        aria-label={t('close')}
                    >
                        <XMarkIcon className="w-6 h-6" />
                    </button>
                </div>
            </div>
            <style>{`
                @keyframes fade-in-up {
                    from { opacity: 0; transform: translateY(20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .animate-fade-in-up {
                    animation: fade-in-up 0.5s ease-out forwards;
                }
            `}</style>
        </div>
    );
};

export default AddToHomeScreenPrompt;
--- END OF FILE components/AddToHomeScreenPrompt.tsx ---
--- START OF FILE components/AnnouncementsBanner.tsx ---
import React, { useState, useMemo } from 'react';
import { useAnnouncements } from '../contexts/AnnouncementsContext';
import { useLanguage } from '../contexts/LanguageContext';
import type { AnnouncementType } from '../types';
import { InformationCircleIcon, ExclamationTriangleIcon, CheckCircleIcon, XCircleIcon, XMarkIcon } from './icons';

const AnnouncementCard: React.FC<{
  title: string;
  message: string;
  type: AnnouncementType;
  onDismiss: () => void;
}> = ({ title, message, type, onDismiss }) => {
  const styles = useMemo(() => {
    switch (type) {
      case 'success':
        return {
          bg: 'bg-green-50 dark:bg-green-900/30',
          text: 'text-green-800 dark:text-green-200',
          iconColor: 'text-green-500',
          icon: <CheckCircleIcon className="w-5 h-5" />,
        };
      case 'warning':
        return {
          bg: 'bg-yellow-50 dark:bg-yellow-900/30',
          text: 'text-yellow-800 dark:text-yellow-200',
          iconColor: 'text-yellow-500',
          icon: <ExclamationTriangleIcon className="w-5 h-5" />,
        };
      case 'error':
        return {
          bg: 'bg-red-50 dark:bg-red-900/30',
          text: 'text-red-800 dark:text-red-200',
          iconColor: 'text-red-500',
          icon: <XCircleIcon className="w-5 h-5" />,
        };
      case 'info':
      default:
        return {
          bg: 'bg-blue-50 dark:bg-blue-900/30',
          text: 'text-blue-800 dark:text-blue-200',
          iconColor: 'text-blue-500',
          icon: <InformationCircleIcon className="w-5 h-5" />,
        };
    }
  }, [type]);

  return (
    <div className={`p-4 rounded-md ${styles.bg} ${styles.text}`}>
      <div className="flex">
        <div className={`shrink-0 ${styles.iconColor}`}>{styles.icon}</div>
        <div className="ml-3 rtl:mr-3 rtl:ml-0 flex-1 md:flex md:justify-between">
          <div>
            <p className="text-sm font-medium">{title}</p>
            <p className="mt-1 text-sm">{message}</p>
          </div>
          <div className="mt-2 md:mt-0 md:ml-6 rtl:md:mr-6 rtl:md:ml-0">
             <button onClick={onDismiss} className={`p-1 rounded-full hover:bg-black/10 focus:outline-none focus:ring-2 focus:ring-offset-2 ${styles.iconColor} ${styles.bg}`}>
                <XMarkIcon className="w-5 h-5" />
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

const AnnouncementsBanner: React.FC = () => {
  const { announcements, loading } = useAnnouncements();
  const { language } = useLanguage();
  const [dismissedIds, setDismissedIds] = useState<number[]>(() => {
    // Restore dismissed IDs from sessionStorage
    const saved = sessionStorage.getItem('dismissedAnnouncements');
    return saved ? JSON.parse(saved) : [];
  });

  const handleDismiss = (id: number) => {
    const newDismissedIds = [...dismissedIds, id];
    setDismissedIds(newDismissedIds);
    sessionStorage.setItem('dismissedAnnouncements', JSON.stringify(newDismissedIds));
  };
  
  const visibleAnnouncements = announcements.filter(a => !dismissedIds.includes(a.id));

  if (loading || visibleAnnouncements.length === 0) {
    return null;
  }

  return (
    <div className="p-4 space-y-4">
      {visibleAnnouncements.map((announcement) => (
        <AnnouncementCard
          key={announcement.id}
          title={announcement.title[language] || announcement.title['en']}
          message={announcement.message[language] || announcement.message['en']}
          type={announcement.type}
          onDismiss={() => handleDismiss(announcement.id)}
        />
      ))}
    </div>
  );
};

export default AnnouncementsBanner;
--- END OF FILE components/AnnouncementsBanner.tsx ---
--- START OF FILE components/pages/LandingPage.tsx ---
import React, { useMemo } from 'react';
import { useLanguage } from '../../contexts/LanguageContext';
import { useAppSettings } from '../../contexts/AppSettingsContext';
import { useAuth } from '../../contexts/AuthContext';
// FIX: Replaced missing MsftIcon with SearchChartIcon for consistency with the header logo.
import { SearchChartIcon } from '../icons';

const DynamicIcon: React.FC<{ svgString: string | undefined }> = ({ svgString }) => {
    if (!svgString) return <SearchChartIcon className="w-12 h-12 text-gray-500" />;
    return <span className="inline-block w-12 h-12" dangerouslySetInnerHTML={{ __html: svgString }} />;
};

const LandingPage: React.FC = () => {
  const { t, language } = useLanguage();
  const { settings } = useAppSettings();
  const { session } = useAuth();

  const { articleTitle, articleBody } = useMemo(() => {
    let titleEn = '', titleAr = '', bodyEn = '', bodyAr = '';

    // --- Title Loading Logic with backward compatibility ---
    if (settings.landing_article_title) { // Prefer new JSON format
        try {
            const titleContent = JSON.parse(settings.landing_article_title);
            titleEn = titleContent.en || '';
            titleAr = titleContent.ar || '';
        } catch (e) { 
            console.error("Could not parse landing page title JSON", e); 
            // Fallback in case JSON is malformed, check for old keys
            titleEn = settings.landing_article_title_en || '';
            titleAr = settings.landing_article_title_ar || '';
        }
    } else { // Fallback to old separate keys if new key doesn't exist
        titleEn = settings.landing_article_title_en || '';
        titleAr = settings.landing_article_title_ar || '';
    }

    // --- Body Loading Logic with backward compatibility ---
    if (settings.landing_article_body) { // Prefer new JSON format
        try {
            const bodyContent = JSON.parse(settings.landing_article_body);
            bodyEn = bodyContent.en || '';
            bodyAr = bodyContent.ar || '';
        } catch (e) { 
            console.error("Could not parse landing page body JSON", e); 
            // Fallback in case JSON is malformed
            bodyEn = settings.landing_article_body_en || '';
            bodyAr = settings.landing_article_body_ar || '';
        }
    } else { // Fallback to old separate keys
        bodyEn = settings.landing_article_body_en || '';
        bodyAr = settings.landing_article_body_ar || '';
    }
    
    // Select the correct language for display
    const finalTitle = language === 'ar' ? (titleAr || titleEn) : titleEn;
    const finalBody = language === 'ar' ? (bodyAr || bodyEn) : bodyEn;

    return { articleTitle: finalTitle, articleBody: finalBody };
  }, [settings, language]);
  
  return (
    <div className="h-full flex items-center justify-center">
        <div className="max-w-3xl text-center bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md">
            <div className="inline-block mb-6">
                <DynamicIcon svgString={settings.site_logo} />
            </div>
            <h1 className="text-4xl lg:text-5xl font-bold mb-4 text-gray-800 dark:text-white">
                {t('site_title')}
            </h1>
            <p className="text-lg text-gray-600 dark:text-gray-400 mb-8">
                {session ? t('welcome_message') : t('landing_page_description')}
            </p>
            {articleTitle && articleBody && (
                <div className="text-left rtl:text-right p-6 bg-gray-50 dark:bg-gray-900/50 rounded-lg border dark:border-gray-200 dark:border-gray-700">
                   <h2 className="text-2xl font-semibold mb-3 text-gray-800 dark:text-white">
                      {articleTitle}
                   </h2>
                   <div className="prose dark:prose-invert text-gray-600 dark:text-gray-400 max-w-none">
                      {articleBody.split('\n').map((line: string, index: number) => <p key={index}>{line}</p>)}
                   </div>
                </div>
            )}
        </div>
    </div>
  );
};

export default LandingPage;
--- END OF FILE components/pages/LandingPage.tsx ---
--- START OF FILE components/pages/Dashboard.tsx ---
import React, { useState, useEffect, useCallback } from 'react';
import { supabase } from '../../services/supabaseClient';
import { useLanguage } from '../../contexts/LanguageContext';
import { useAppSettings } from '../../contexts/AppSettingsContext';
import { useAuth } from '../../contexts/AuthContext';
import { UsersIcon, ShieldCheckIcon, Cog6ToothIcon, PlayIcon, SpinnerIcon } from '../icons';
import ProcessResultModal from './ProcessResultModal';

const StatCard: React.FC<{ title: string; value: number | string; icon: React.ReactNode }> = ({ title, value, icon }) => (
  <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center">
    <div className="p-3 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 mr-4 rtl:mr-0 rtl:ml-4">
      {icon}
    </div>
    <div>
      <p className="text-sm font-medium text-gray-500 dark:text-gray-400">{title}</p>
      <p className="text-2xl font-bold text-gray-900 dark:text-white">{value}</p>
    </div>
  </div>
);

const SiteSettings: React.FC = () => {
    const { t, refetchTranslations } = useLanguage();
    const { settings, updateSetting, refetchSettings } = useAppSettings();
    const { hasPermission } = useAuth();
    
    // Site settings state
    const [siteTitleEn, setSiteTitleEn] = useState('');
    const [siteTitleAr, setSiteTitleAr] = useState('');
    const [siteLogo, setSiteLogo] = useState('');
    
    // Landing page content state
    const [articleTitleEn, setArticleTitleEn] = useState('');
    const [articleTitleAr, setArticleTitleAr] = useState('');
    const [articleBodyEn, setArticleBodyEn] = useState('');
    const [articleBodyAr, setArticleBodyAr] = useState('');
    const [articleTab, setArticleTab] = useState<'en' | 'ar'>('en');

    // NEW state for stock analysis page
    const [stockAnalysisDescEn, setStockAnalysisDescEn] = useState('');
    const [stockAnalysisDescAr, setStockAnalysisDescAr] = useState('');
    const [showDisclaimer, setShowDisclaimer] = useState(true);
    
    const [isSaving, setIsSaving] = useState(false);
    const [saveStatus, setSaveStatus] = useState<'idle' | 'success' | 'error'>('idle');

    // Effect for fetching data that does not depend on settings, runs only on mount.
    useEffect(() => {
        const controller = new AbortController();
        const fetchTitles = async () => {
            try {
                 const { data, error } = await supabase.rpc('get_translations_for_key', { p_key: 'site_title' }).abortSignal(controller.signal);
                if (error) throw error;
                if (data) {
                    setSiteTitleEn(data.find(d => d.lang_id === 'en')?.value || '');
                    setSiteTitleAr(data.find(d => d.lang_id === 'ar')?.value || '');
                }
            } catch (error: any) {
                if (error.name !== 'AbortError') {
                    // Log the error for debugging, but don't show it to the user.
                    console.error('Error fetching site titles:', error.message || error);
                }
            }
        };
        fetchTitles();

        return () => {
            controller.abort();
        };
    }, []); // Empty dependency array ensures this runs only once.

    // Effect for setting state from the settings context.
    useEffect(() => {
        setSiteLogo(settings.site_logo || '');
        
        let titleEn = '', titleAr = '', bodyEn = '', bodyAr = '';

        if (settings.landing_article_title) {
            try {
                const titleContent = JSON.parse(settings.landing_article_title);
                titleEn = titleContent.en || '';
                titleAr = titleContent.ar || '';
            } catch (e) { 
                console.error("Could not parse landing page title JSON", e); 
                titleEn = settings.landing_article_title_en || '';
                titleAr = settings.landing_article_title_ar || '';
            }
        } else {
            titleEn = settings.landing_article_title_en || '';
            titleAr = settings.landing_article_title_ar || '';
        }

        if (settings.landing_article_body) {
            try {
                const bodyContent = JSON.parse(settings.landing_article_body);
                bodyEn = bodyContent.en || '';
                bodyAr = bodyContent.ar || '';
            } catch (e) { 
                console.error("Could not parse landing page body JSON", e); 
                bodyEn = settings.landing_article_body_en || '';
                bodyAr = settings.landing_article_body_ar || '';
            }
        } else {
            bodyEn = settings.landing_article_body_en || '';
            bodyAr = settings.landing_article_body_ar || '';
        }

        setArticleTitleEn(titleEn);
        setArticleTitleAr(titleAr);
        setArticleBodyEn(bodyEn);
        setArticleBodyAr(bodyAr);
        
        setStockAnalysisDescEn(settings.stock_analysis_page_description_en || '');
        setStockAnalysisDescAr(settings.stock_analysis_page_description_ar || '');
        setShowDisclaimer(settings.show_educational_disclaimer !== 'false');
    }, [settings]);


    const handleSave = async () => {
        setIsSaving(true);
        setSaveStatus('idle');
        try {
            await Promise.all([
                supabase.from('translations').upsert({ lang_id: 'en', key: 'site_title', value: siteTitleEn }, { onConflict: 'lang_id,key' }),
                supabase.from('translations').upsert({ lang_id: 'ar', key: 'site_title', value: siteTitleAr }, { onConflict: 'lang_id,key' }),
                updateSetting('site_logo', siteLogo),
                updateSetting('landing_article_title', JSON.stringify({ en: articleTitleEn, ar: articleTitleAr })),
                updateSetting('landing_article_body', JSON.stringify({ en: articleBodyEn, ar: articleBodyAr })),
                updateSetting('stock_analysis_page_description_en', stockAnalysisDescEn),
                updateSetting('stock_analysis_page_description_ar', stockAnalysisDescAr),
                updateSetting('show_educational_disclaimer', String(showDisclaimer)),
            ]);
            setSaveStatus('success');
            refetchTranslations();
            refetchSettings();
        } catch (error) {
            setSaveStatus('error');
            console.error("Failed to save settings", error);
        } finally {
            setIsSaving(false);
            setTimeout(() => setSaveStatus('idle'), 3000);
        }
    };
    
    if (!hasPermission('manage:settings')) return null;

    return (
        <div className="mt-8">
            <h2 className="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4">{t('site_settings')}</h2>
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <fieldset>
                  <legend className="text-lg font-medium text-gray-900 dark:text-white">{t('general_settings')}</legend>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                      <div>
                          <label htmlFor="site_title_en" className="block text-sm font-medium text-gray-700 dark:text-gray-300">{t('site_title_en')}</label>
                          <input type="text" id="site_title_en" value={siteTitleEn} onChange={(e) => setSiteTitleEn(e.target.value)}
                                 className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                      </div>
                       <div>
                          <label htmlFor="site_title_ar" className="block text-sm font-medium text-gray-700 dark:text-gray-300">{t('site_title_ar')}</label>
                          <input type="text" id="site_title_ar" dir="rtl" value={siteTitleAr} onChange={(e) => setSiteTitleAr(e.target.value)}
                                 className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                      </div>
                      <div className="md:col-span-2">
                          <label htmlFor="site_logo" className="block text-sm font-medium text-gray-700 dark:text-gray-300">{t('site_logo')}</label>
                          <textarea id="site_logo" rows={4} value={siteLogo} onChange={(e) => setSiteLogo(e.target.value)}
                                    className="mt-1 block w-full font-mono text-sm px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder='<svg>...</svg>' />
                      </div>
                  </div>
                </fieldset>

                <hr className="my-8 border-gray-200 dark:border-gray-700" />
                
                <fieldset>
                    <legend className="text-lg font-medium text-gray-900 dark:text-white">{t('landing_page_content')}</legend>
                    
                    <div className="border-b border-gray-200 dark:border-gray-700 mt-4">
                        <nav className="-mb-px flex space-x-4 rtl:space-x-reverse" aria-label="Tabs">
                            <button
                                type="button"
                                onClick={() => setArticleTab('en')}
                                className={`whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${
                                    articleTab === 'en'
                                    ? 'border-blue-500 text-blue-600 dark:text-blue-400'
                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-600'
                                }`}
                                aria-current={articleTab === 'en' ? 'page' : undefined}
                            >
                                {t('lang_english')}
                            </button>
                            <button
                                type="button"
                                onClick={() => setArticleTab('ar')}
                                className={`whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${
                                    articleTab === 'ar'
                                    ? 'border-blue-500 text-blue-600 dark:text-blue-400'
                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-600'
                                }`}
                                aria-current={articleTab === 'ar' ? 'page' : undefined}
                            >
                                {t('lang_arabic')}
                            </button>
                        </nav>
                    </div>

                    <div className="mt-6">
                        {articleTab === 'en' && (
                            <div className="space-y-6 animate-fade-in">
                                <div>
                                    <label htmlFor="article_title_en" className="block text-sm font-medium text-gray-700 dark:text-gray-300">{t('article_title_en')}</label>
                                    <input type="text" id="article_title_en" value={articleTitleEn} onChange={(e) => setArticleTitleEn(e.target.value)}
                                           className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                                </div>
                                <div>
                                    <label htmlFor="article_body_en" className="block text-sm font-medium text-gray-700 dark:text-gray-300">{t('article_body_en')}</label>
                                    <textarea id="article_body_en" rows={5} value={articleBodyEn} onChange={(e) => setArticleBodyEn(e.target.value)}
                                              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                                </div>
                            </div>
                        )}
                        {articleTab === 'ar' && (
                             <div className="space-y-6 animate-fade-in">
                                <div>
                                   <label htmlFor="article_title_ar" className="block text-sm font-medium text-gray-700 dark:text-gray-300">{t('article_title_ar')}</label>
                                   <input type="text" id="article_title_ar" dir="rtl" value={articleTitleAr} onChange={(e) => setArticleTitleAr(e.target.value)}
                                          className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                                </div>
                                <div>
                                   <label htmlFor="article_body_ar" className="block text-sm font-medium text-gray-700 dark:text-gray-300">{t('article_body_ar')}</label>
                                   <textarea id="article_body_ar" rows={5} dir="rtl" value={articleBodyAr} onChange={(e) => setArticleBodyAr(e.target.value)}
                                             className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                                </div>
                            </div>
                        )}
                    </div>
                </fieldset>

                <hr className="my-8 border-gray-200 dark:border-gray-700" />
                <fieldset>
                    <legend className="text-lg font-medium text-gray-900 dark:text-white">{t('stock_analysis_page_settings')}</legend>
                    <div className="space-y-6 mt-4">
                        <div>
                            <label htmlFor="stock_analysis_desc_en" className="block text-sm font-medium text-gray-700 dark:text-gray-300">{t('stock_analysis_page_desc_en')}</label>
                            <textarea id="stock_analysis_desc_en" rows={3} value={stockAnalysisDescEn} onChange={(e) => setStockAnalysisDescEn(e.target.value)}
                                      className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                        </div>
                        <div>
                            <label htmlFor="stock_analysis_desc_ar" className="block text-sm font-medium text-gray-700 dark:text-gray-300">{t('stock_analysis_page_desc_ar')}</label>
                            <textarea id="stock_analysis_desc_ar" rows={3} dir="rtl" value={stockAnalysisDescAr} onChange={(e) => setStockAnalysisDescAr(e.target.value)}
                                      className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">{t('show_educational_disclaimer_label')}</label>
                            <div className="mt-2 flex items-center">
                                <label className="relative inline-flex items-center cursor-pointer">
                                  <input type="checkbox" className="sr-only peer" checked={showDisclaimer} onChange={(e) => setShowDisclaimer(e.target.checked)} />
                                  <div className="w-11 h-6 bg-gray-200 dark:bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] rtl:after:left-auto rtl:after:right-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                             <p className="mt-1 text-xs text-gray-500 dark:text-gray-400">{t('show_educational_disclaimer_desc')}</p>
                        </div>
                    </div>
                </fieldset>


                <div className="mt-8 flex items-center justify-end space-x-4 rtl:space-x-reverse">
                    {saveStatus === 'success' && <p className="text-sm text-green-600 dark:text-green-400">{t('save_success')}</p>}
                    {saveStatus === 'error' && <p className="text-sm text-red-600 dark:text-red-400">{t('save_error')}</p>}
                    <button onClick={handleSave} disabled={isSaving} 
                        className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
                    >
                        {isSaving ? t('saving') : t('save')}
                    </button>
                </div>
            </div>
            <style>{`
                @keyframes fade-in {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .animate-fade-in {
                    animation: fade-in 0.3s ease-out forwards;
                }
            `}</style>
        </div>
    );
};

const ManualTriggers: React.FC = () => {
    const { t } = useLanguage();
    const { hasPermission } = useAuth();
    
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [modalContent, setModalContent] = useState<{ title: string; isLoading: boolean; result: string | number | null; error: string | null; }>({ title: '', isLoading: false, result: null, error: null });

    const handleEvaluateForecasts = async () => {
        setModalContent({ title: t('run_forecast_evaluation'), isLoading: true, result: null, error: null });
        setIsModalOpen(true);
        const { error } = await supabase.rpc('evaluate_and_save_forecasts');
        if (error) {
            setModalContent(prev => ({ ...prev, isLoading: false, error: error.message }));
        } else {
            setModalContent(prev => ({ ...prev, isLoading: false, result: 'PROCESS_STARTED' }));
        }
    };

    const closeModal = () => {
        setIsModalOpen(false);
        setTimeout(() => setModalContent({ title: '', isLoading: false, result: null, error: null }), 300);
    };
    
    if (!hasPermission('manage:settings')) return null;

    return (
        <>
            <ProcessResultModal 
                isOpen={isModalOpen}
                onClose={closeModal}
                {...modalContent}
            />
            <div className="mt-8">
                <h2 className="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4 flex items-center gap-2">
                    <Cog6ToothIcon className="w-6 h-6" />
                    {t('manual_system_triggers')}
                </h2>
                <div className="grid grid-cols-1 gap-6">
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex flex-col justify-between">
                        <div>
                            <h3 className="text-lg font-medium text-gray-900 dark:text-white">{t('run_forecast_evaluation')}</h3>
                            <p className="mt-2 text-sm text-gray-600 dark:text-gray-400">{t('run_forecast_evaluation_desc')}</p>
                        </div>
                         <button onClick={handleEvaluateForecasts} disabled={modalContent.isLoading} className="mt-4 w-full sm:w-auto self-end flex items-center justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50">
                            <PlayIcon className="w-5 h-5 mr-2 rtl:ml-2" />
                            {t('run_now')}
                        </button>
                    </div>
                </div>
            </div>
        </>
    );
};


const Dashboard: React.FC = () => {
  const { t } = useLanguage();
  const [userCount, setUserCount] = useState(0);
  const [roleCount, setRoleCount] = useState(0);

  useEffect(() => {
    const controller = new AbortController();
    const fetchData = async () => {
      try {
        const { data, error } = await supabase.rpc('get_dashboard_stats').abortSignal(controller.signal).single();
        if (error) throw error;
        if (data) {
          setUserCount((data as any).user_count || 0);
          setRoleCount((data as any).role_count || 0);
        }
      } catch (error: any) {
        if (error.name !== 'AbortError') {
          console.error("Error fetching dashboard stats:", error);
        }
      }
    };
    fetchData();

    return () => {
      controller.abort();
    };
  }, []);

  return (
    <div>
      <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-2">{t('dashboard')}</h1>
      <p className="text-gray-600 dark:text-gray-400 mb-6">{t('welcome_message')}</p>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <StatCard title={t('total_users')} value={userCount} icon={<UsersIcon />} />
        <StatCard title={t('total_roles')} value={roleCount} icon={<ShieldCheckIcon />} />
      </div>
      
      <SiteSettings />
      <ManualTriggers />
    </div>
  );
};

export default Dashboard;
--- END OF FILE components/pages/Dashboard.tsx ---
--- START OF FILE manifest.json ---
{
  "short_name": "MRowDir",
  "name": "MRowDir",
  "description": "Professional and visually engaging stock price predictions for the U.S. markets.",
  "icons": [
    {
      "src": "/favicon.ico",
      "sizes": "64x64 32x32 24x24 16x16",
      "type": "image/x-icon"
    },
    {
      "src": "/icons/icon-192.png",
      "type": "image/png",
      "sizes": "192x192"
    },
    {
      "src": "/icons/icon-512.png",
      "type": "image/png",
      "sizes": "512x512"
    }
  ],
  "start_url": "/",
  "display": "standalone",
  "scope": "/",
  "theme_color": "#4338ca",
  "background_color": "#ffffff"
}
--- END OF FILE manifest.json ---
--- START OF FILE sw.js ---
const CACHE_NAME = 'mrowdir-cache-v1';
const urlsToCache = [
  '/',
  '/index.html',
  '/favicon.ico',
  '/icons/icon-192.png',
  '/icons/icon-512.png'
];

// Install event: opens a cache and adds the app shell to it.
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then((cache) => {
        console.log('Opened cache');
        return cache.addAll(urlsToCache);
      })
  );
  self.skipWaiting();
});

// Fetch event: serves assets from the cache or network.
self.addEventListener('fetch', (event) => {
  // We only want to cache GET requests.
  if (event.request.method !== 'GET') {
    return;
  }

  // For navigation requests, use a network-first strategy.
  // This ensures the user always gets the latest HTML, which is important for SPAs.
  if (event.request.mode === 'navigate') {
    event.respondWith(
      fetch(event.request).catch(() => {
        // If network fails, serve the root from cache. This enables offline access.
        return caches.match('/');
      })
    );
    return;
  }

  // For other requests (CSS, JS, images), use a cache-first strategy.
  event.respondWith(
    caches.match(event.request).then((response) => {
      return response || fetch(event.request).then((fetchResponse) => {
        return caches.open(CACHE_NAME).then((cache) => {
          // Don't cache failed requests.
          if (fetchResponse.status === 200) {
              cache.put(event.request, fetchResponse.clone());
          }
          return fetchResponse;
        });
      });
    })
  );
});


// Activate event: cleans up old caches.
self.addEventListener('activate', (event) => {
  const cacheWhitelist = [CACHE_NAME];
  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames.map((cacheName) => {
          if (cacheWhitelist.indexOf(cacheName) === -1) {
            console.log('Deleting old cache:', cacheName);
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
  return self.clients.claim();
});
--- END OF FILE sw.js ---
--- START OF FILE forecast_check_run.py.txt ---

import os
import psycopg2
from psycopg2 import sql
from psycopg2.extras import DictCursor
from dotenv import load_dotenv

# -- Settings and Database Connection --

# Load environment variables from a .env file (optional, but good practice)
load_dotenv()

# Retrieve connection info from environment variables
DB_HOST = os.getenv("DB_HOST", "your_supabase_host.supabase.co")
DB_NAME = os.getenv("DB_NAME", "postgres")
DB_USER = os.getenv("DB_USER", "postgres")
DB_PASSWORD = os.getenv("DB_PASSWORD", "your_supabase_db_password")
DB_PORT = os.getenv("DB_PORT", "5432")

def get_db_connection():
    """Create and return a database connection."""
    try:
        conn = psycopg2.connect(
            host=DB_HOST,
            dbname=DB_NAME,
            user=DB_USER,
            password=DB_PASSWORD,
            port=DB_PORT
        )
        print("Successfully connected to the database.")
        return conn
    except psycopg2.OperationalError as e:
        print(f"Database connection error: {e}")
        return None

# -- Data Fetching Functions --

def get_latest_unevaluated_forecasts_per_stock(cursor):
    """
    Fetch the single most recent forecast for each tracked stock
    that does not yet have an entry in the forecast_check_history table.
    """
    query = sql.SQL("""
        WITH latest_forecasts AS (
            SELECT DISTINCT ON (f.stock_symbol)
                f.stock_symbol,
                s.name as stock_name,
                f.forecast_date,
                f.predicted_price,
                f.predicted_lo,
                f.predicted_hi,
                f.confidence
            FROM public.forecasts f
            JOIN public.stocks s ON f.stock_symbol = s.symbol
            WHERE s.is_tracked = TRUE
            ORDER BY f.stock_symbol, f.forecast_date DESC
        )
        SELECT lf.*
        FROM latest_forecasts lf
        LEFT JOIN public.forecast_check_history h
            ON lf.stock_symbol = h.stock_symbol AND lf.forecast_date = h.forecast_date
        WHERE h.stock_symbol IS NULL;
    """)
    cursor.execute(query)
    forecasts = cursor.fetchall()
    print(f"Found {len(forecasts)} new/unevaluated latest forecasts to check.")
    return forecasts

def get_historical_prices_for_forecasts(cursor, forecasts):
    """Fetch historical price data for a list of forecasts."""
    if not forecasts:
        return {}

    # Create a list of (symbol, date) tuples for the WHERE IN clause
    symbol_date_pairs = tuple([(f['stock_symbol'], f['forecast_date']) for f in forecasts])
    
    if not symbol_date_pairs:
        return{}

    query = sql.SQL("""
        SELECT stock_symbol, date, "open", high, low, "close", volume
        FROM public.historical_data
        WHERE (stock_symbol, date) IN %s;
    """)
    
    cursor.execute(query, (symbol_date_pairs,))
    
    # Create a dictionary with a composite key for easy lookup: 'SYMBOL-YYYY-MM-DD'
    price_data = {f"{row['stock_symbol']}-{row['date']}": row for row in cursor.fetchall()}
    print(f"Found historical price data for {len(price_data)} matching stock/date pairs.")
    return price_data

# -- Processing and Saving Functions --

def evaluate_forecast(forecast, actual_price):
    """Evaluate a forecast against actual price data."""
    if not actual_price:
        return None

    predicted_lo = forecast['predicted_lo']
    predicted_hi = forecast['predicted_hi']
    actual_low = actual_price['low']
    actual_high = actual_price['high']
    actual_close = actual_price.get('close')
    predicted_price = forecast.get('predicted_price')

    # Hit logic: Does the predicted range overlap with the actual range?
    is_hit = (predicted_lo <= actual_high) and (actual_low <= predicted_hi)

    # Calculate error metrics (if data is available)
    abs_error = None
    pct_error = None
    if predicted_price is not None and actual_close is not None:
        abs_error = abs(predicted_price - actual_close)
        if actual_close > 0:
            pct_error = (abs_error / actual_close)
        else:
            pct_error = 0 # Avoid division by zero

    return {
        'stock_symbol': forecast['stock_symbol'],
        'stock_name': forecast['stock_name'],
        'forecast_date': forecast['forecast_date'],
        'predicted_price': predicted_price,
        'predicted_lo': predicted_lo,
        'predicted_hi': predicted_hi,
        'actual_low': actual_low,
        'actual_high': actual_high,
        'actual_close': actual_close,
        'is_hit': is_hit,
        'abs_error': abs_error,
        'pct_error': pct_error,
        'confidence': forecast.get('confidence')
    }

def save_results(cursor, results):
    """Save the evaluation results to all three database tables."""
    if not results:
        print("No results to save.")
        return

    # 1. Save to forecast_check_history
    history_query = sql.SQL("""
        INSERT INTO public.forecast_check_history (
            stock_symbol, forecast_date, predicted_price, predicted_lo, predicted_hi,
            actual_low, actual_high, actual_close, hit_range, abs_error, pct_error, confidence
        ) VALUES (
            %(stock_symbol)s, %(forecast_date)s, %(predicted_price)s, %(predicted_lo)s, %(predicted_hi)s,
            %(actual_low)s, %(actual_high)s, %(actual_close)s, %(is_hit)s, %(abs_error)s, %(pct_error)s, %(confidence)s
        ) ON CONFLICT (stock_symbol, forecast_date) DO UPDATE SET
            predicted_price = EXCLUDED.predicted_price,
            predicted_lo = EXCLUDED.predicted_lo,
            predicted_hi = EXCLUDED.predicted_hi,
            actual_low = EXCLUDED.actual_low,
            actual_high = EXCLUDED.actual_high,
            actual_close = EXCLUDED.actual_close,
            hit_range = EXCLUDED.hit_range,
            abs_error = EXCLUDED.abs_error,
            pct_error = EXCLUDED.pct_error,
            confidence = EXCLUDED.confidence,
            created_at = NOW();
    """)
    
    # 2. Save to forecast_check_latest
    latest_query = sql.SQL("""
        INSERT INTO public.forecast_check_latest (
            stock_symbol, forecast_date, predicted_price, predicted_lo, predicted_hi,
            actual_low, actual_high, actual_close, hit_range, abs_error, pct_error, confidence
        ) VALUES (
            %(stock_symbol)s, %(forecast_date)s, %(predicted_price)s, %(predicted_lo)s, %(predicted_hi)s,
            %(actual_low)s, %(actual_high)s, %(actual_close)s, %(is_hit)s, %(abs_error)s, %(pct_error)s, %(confidence)s
        ) ON CONFLICT (stock_symbol) DO UPDATE SET
            forecast_date = EXCLUDED.forecast_date,
            predicted_price = EXCLUDED.predicted_price,
            predicted_lo = EXCLUDED.predicted_lo,
            predicted_hi = EXCLUDED.predicted_hi,
            actual_low = EXCLUDED.actual_low,
            actual_high = EXCLUDED.actual_high,
            actual_close = EXCLUDED.actual_close,
            hit_range = EXCLUDED.hit_range,
            abs_error = EXCLUDED.abs_error,
            pct_error = EXCLUDED.pct_error,
            confidence = EXCLUDED.confidence,
            created_at = NOW();
    """)
    
    # 3. Save to Forcast_Result
    forcast_result_query = sql.SQL("""
        INSERT INTO public."Forcast_Result" (
            stock_symbol, stock_name, forecast_date, predicted_lo, predicted_hi,
            actual_low, actual_high, is_hit
        ) VALUES (
            %(stock_symbol)s, %(stock_name)s, %(forecast_date)s, %(predicted_lo)s, %(predicted_hi)s,
            %(actual_low)s, %(actual_high)s, %(is_hit)s
        ) ON CONFLICT (stock_symbol, forecast_date) DO UPDATE SET
            stock_name = EXCLUDED.stock_name,
            predicted_lo = EXCLUDED.predicted_lo,
            predicted_hi = EXCLUDED.predicted_hi,
            actual_low = EXCLUDED.actual_low,
            actual_high = EXCLUDED.actual_high,
            is_hit = EXCLUDED.is_hit,
            created_at = NOW();
    """)

    try:
        psycopg2.extras.execute_batch(cursor, history_query, results)
        psycopg2.extras.execute_batch(cursor, latest_query, results)
        psycopg2.extras.execute_batch(cursor, forcast_result_query, results)
        print(f"Successfully saved {len(results)} results to all three tables.")
    except Exception as e:
        print(f"An error occurred while saving results: {e}")
        # This will be caught by the main try/except and cause a rollback
        raise

# -- Main Execution Function --

def main():
    """Main function to run the forecast check process."""
    print("Starting forecast check process...")
    
    conn = get_db_connection()
    if not conn:
        return

    evaluated_results = []
    
    try:
        # Use a transaction block to ensure all or no data is written
        with conn:
            with conn.cursor(cursor_factory=DictCursor) as cursor:
                # 1. Get the latest unevaluated forecast for each tracked stock
                forecasts_to_check = get_latest_unevaluated_forecasts_per_stock(cursor)
                if not forecasts_to_check:
                    print("No new forecasts to evaluate. Process complete.")
                    return

                # 2. Get the required actual prices for these forecasts in a single batch
                actual_prices = get_historical_prices_for_forecasts(cursor, forecasts_to_check)

                # 3. Evaluate each forecast if its corresponding historical data was found
                for forecast in forecasts_to_check:
                    symbol = forecast['stock_symbol']
                    f_date = forecast['forecast_date']
                    lookup_key = f"{symbol}-{f_date}"
                    
                    actual_price_data = actual_prices.get(lookup_key)
                    
                    if actual_price_data:
                        result = evaluate_forecast(forecast, actual_price_data)
                        if result:
                            evaluated_results.append(result)
                    else:
                        print(f"Info: No historical price data found for {symbol} on {f_date}. This forecast will be re-checked on the next run.")

                # 4. Save results to all tables
                if evaluated_results:
                    save_results(cursor, evaluated_results)
                else:
                    print("No results were evaluated (likely due to missing historical data for the forecasts).")
    
    except Exception as e:
        print(f"An unexpected error occurred during the process: {e}")
        # The 'with conn' block handles rollback on exception automatically
    finally:
        if conn:
            conn.close()
            print("Database connection closed.")
            
    print("...Forecast check process finished.")


if __name__ == "__main__":
    main()
--- END OF FILE forecast_check_run.py.txt ---
--- START OF FILE ProSpec.txt ---
# مواصفات المشروع: لوحة تحكم آمنة ومنصة تحليل أسهم
_تم التحديث بتاريخ: 2024-08-01_

هذا المستند هو المصدر الوحيد للمعلومات الصحيحة لوظائف المشروع، صلاحيات المستخدمين، وهيكل قاعدة البيانات. تم إنشاؤه بناءً على تحليل كامل لكود المصدر للتطبيق ومخططات قاعدة البيانات.

---

## 1. نظرة عامة على المشروع

المشروع هو تطبيق ويب آمن قائم على الأدوار، مبني باستخدام React و Supabase. وظائفه الأساسية تنقسم إلى محورين رئيسيين:
1.  **منصة تحليل الأسهم**: توفير توقعات وتحليلات لأسعار الأسهم في الأسواق الأمريكية بطريقة احترافية وجذابة بصريًا للمستخدمين المسجلين.
2.  **لوحة تحكم إدارية**: العمل كلوحة تحكم شاملة للمسؤولين لإدارة المستخدمين، الأدوار، محتوى الموقع، إعدادات النظام، وسجل الأنشطة.

يتميز التطبيق بواجهة مستخدم نظيفة ومتجاوبة، ونظام صلاحيات قوي، وبنية خلفية تعتمد على دوال PostgreSQL (RPC) للوصول الآمن والفعال للبيانات.

---

## 2. المبادئ الأساسية وقواعد العمل (Core Principles & Business Logic)

هذه هي القواعد الأساسية التي تحكم سلوك التطبيق ويجب عدم انتهاكها.

1.  **تسجيل المستخدم وتوجيهه**: عند التسجيل بنجاح، يتم تعيين دور 'User' للمستخدم الجديد ويتم تسجيل دخوله تلقائيًا. الصفحة الأساسية للمستخدم العادي 'User' هي **تحليل الأسهم (`stock_analysis`)**. إذا حاول الوصول إلى صفحة مقيدة (مثل لوحة التحكم)، يتم إعادة توجيهه إلى `stock_analysis`. إذا لم يكن لديه أي صلاحيات على الإطلاق، يتم إرساله إلى الصفحة الرئيسية (`landing`).

2.  **التحكم في الوصول إلى لوحة التحكم**: لوحة التحكم الرئيسية (`dashboard`) هي أداة إدارية. يمكن الوصول إليها **فقط** من قبل المستخدمين الذين يمتلك دورهم صلاحية `view:dashboard` (مثل 'Admin'). لا يمكن للمستخدمين العاديين الوصول إليها.

3.  **التنقل عبر الشعار والعنوان**: النقر على شعار الموقع أو عنوان الموقع في الشريط العلوي سيوجه المستخدم **دائمًا** إلى **الصفحة الرئيسية (`landing`)**.

4.  **تعيين الدور الافتراضي**: أي مستخدم جديد يقوم بالتسجيل يتم تعيين دور 'User' له تلقائيًا. **أول مستخدم** يتم إنشاؤه في النظام على الإطلاق يتم تعيين دور 'Admin' له تلقائيًا. يتم التعامل مع هذا المنطق بواسطة مُحفِّز قاعدة البيانات `handle_new_user`.

5.  **لا يوجد تأكيد للبريد الإلكتروني**: تم تعطيل خطوة تأكيد البريد الإلكتروني. يتم تأكيد جميع المستخدمين الجدد تلقائيًا ويمكنهم تسجيل الدخول فورًا بعد التسجيل، مما يسهل عملية الانضمام. يتم التعامل مع هذا أيضًا بواسطة المُحفِّز `handle_new_user`.

6.  **استمرارية الجلسة (Remember Me)**: يحتوي نموذج تسجيل الدخول في الشريط العلوي على خيار "تذكرني". هذا الخيار يتحكم في مكان تخزين رمز الجلسة:
    -   **محدد**: يتم تخزين الجلسة في `localStorage`، مما يحافظ على تسجيل دخول المستخدم حتى بعد إغلاق المتصفح.
    -   **غير محدد**: يتم تخزين الجلسة في `sessionStorage`، مما يؤدي إلى تسجيل الخروج عند إغلاق المتصفح.

7.  **التقييم التلقائي للتوقعات**: يقوم النظام بتقييم أداء التوقعات بشكل تلقائي. عند إدخال دفعة جديدة من التوقعات، يقوم مُحفِّز قاعدة البيانات (`trigger_forecast_evaluation`) بالتحقق مما إذا كانت الدفعة مكتملة. إذا كانت كذلك، فإنه يستدعي تلقائيًا الدالة `evaluate_and_save_forecasts` التي تقارن التوقعات بالبيانات التاريخية الفعلية وتحفظ النتائج.

---

## 3. أدوار وصلاحيات المستخدمين (User Roles & Permissions)

يستخدم النظام نموذج التحكم في الوصول المستند إلى الأدوار (RBAC). يتم تعيين الصلاحيات للأدوار، ويتم تعيين الأدوار للمستخدمين.

| صلاحية الإجراء (`action`)             | الوصف                                                                    | دور المسؤول (Admin) | دور المستخدم (User) |
| ------------------------------------- | ------------------------------------------------------------------------ | :------------------: | :-----------------: |
| `view:dashboard`                      | يمكنه عرض لوحة التحكم الرئيسية والإحصائيات.                              |          ✅          |          ❌           |
| `manage:users`                        | يمكنه عرض قائمة المستخدمين، إضافة مستخدمين جدد، وتغيير أدوار المستخدمين.  |          ✅          |          ❌           |
| `manage:roles`                        | يمكنه عرض قائمة الأدوار وتغيير صلاحيات الأدوار.                           |          ✅          |          ❌           |
| `manage:settings`                     | يمكنه تحديث إعدادات الموقع العامة (الشعار، محتوى الصفحة الرئيسية، إلخ).    |          ✅          |          ❌           |
| `manage:announcements`                | يمكنه إنشاء، تعديل، وحذف الإعلانات العامة.                               |          ✅          |          ❌           |
| `view:system_documentation`           | يمكنه عرض توثيق قاعدة البيانات والنظام الذي يتم إنشاؤه تلقائيًا.          |          ✅          |          ❌           |
| `view:stock_analysis`                 | يمكنه عرض لوحة معلومات تحليل الأسهم وأداء التوقعات.                      |          ✅          |          ✅           |
| `manage:stocks`                       | يمكنه إضافة، تحديث، وتتبع الأسهم في النظام.                              |          ✅          |          ❌           |
| `manage:translations`                 | يمكنه تعديل نصوص واجهة المستخدم لجميع اللغات.                            |          ✅          |          ❌           |
| `view:activity_log`                   | يمكنه عرض سجل أنشطة النظام.                                              |          ✅          |          ❌           |

---

## 4. مواصفات واجهة المستخدم: الصفحات والمكونات (UI Specification: Pages & Components)

### 4.1. الهيكل العام
- **`App.tsx`**: الموجه الرئيسي للتطبيق. يدير حالة الصفحة الحالية ويفرض الصلاحيات على مستوى عالٍ، ويعيد توجيه المستخدمين إذا لم يكن لديهم إذن. يحدد عنوان المستند ديناميكيًا.
- **`Layout.tsx`**: الغلاف الرئيسي للصفحة. يتضمن `Header` و `AnnouncementsBanner` ويضمن أن المحتوى يملأ الشاشة بشكل صحيح.

### 4.2. الصفحات الرئيسية
| الصفحة / المكون                | الصلاحية المطلوبة             | الوصف                                                                                                                                                                                                                                                                                                                                                                                         |
| ------------------------------ | ----------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **الصفحة الرئيسية (Landing Page)** | _عام_                        | نقطة الدخول العامة. تعرض مقالًا رئيسيًا وبطاقة تسجيل دخول (`LoginCard`) للمستخدمين غير المسجلين.                                                                                                                                                                                                                                                                                                |
| **لوحة التحكم (Dashboard)**      | `view:dashboard`              | تعرض إحصائيات الموقع (عدد المستخدمين/الأدوار) وتوفر نموذجًا لإدارة إعدادات الموقع العامة (`site_title`, `site_logo`, محتوى الصفحة الرئيسية، ووصف صفحة تحليل الأسهم).                                                                                                                                                                                                                                           |
| **إدارة المستخدمين**           | `manage:users`                | تعرض جدولاً مقسمًا لجميع المستخدمين. تسمح بإنشاء مستخدمين جدد، تعديل المستخدمين الحاليين (الاسم، الدور، وكلمة المرور)، وتفعيل الحسابات يدويًا.                                                                                                                                                                                                                                                                |
| **إدارة الأدوار**               | `manage:roles`                | تعرض قائمة بالأدوار وقائمة اختيار للصلاحيات. تسمح للمسؤولين بتعيين أو إلغاء صلاحيات لكل دور.                                                                                                                                                                                                                                                                                                    |
| **إدارة الإعلانات**             | `manage:announcements`        | تسمح بإنشاء، تعديل، وحذف الإعلانات العامة التي تظهر كإشعارات للمستخدمين.                                                                                                                                                                                                                                                                                                                          |
| **توثيق النظام**               | `view:system_documentation`   | تنشئ وتعرض توثيقًا حيًا لمخطط قاعدة البيانات، بما في ذلك الجداول، الدوال، وسياسات RLS.                                                                                                                                                                                                                                                                                                            |
| **آخر يوم عمل (Stock Analysis)** | `view:stock_analysis`         | **الصفحة الأساسية للمستخدمين العاديين.** تعرض نتائج التوقعات اليومية لآخر يوم عمل. الميزات تشمل: <ul><li>رأس صفحة يحتوي على عنوان رئيسي، ووصف قابل للتعديل، وعرض بارز للتاريخ.</li><li>بطاقات إحصائيات ملخصة: مقياس دائري كبير لـ **نسبة النجاح**، وبطاقات أصغر لـ **إجمالي التوقعات**، **التوقعات الصحيحة**، و **التوقعات الخاطئة**.</li><li>عناصر تحكم للبحث برمز السهم/الاسم والتصفية حسب النتيجة (الكل/صحيح/خطأ).</li><li>جدول مفصل ومقسم يعرض **الرمز**، **معلومات آخر إغلاق**، **النطاق الفعلي (أعلى/أدنى)**، **النطاق المتوقع (أعلى/أدنى)**، و **نتيجة التوقع** (صحيح/خطأ).</li><li>النقر على صف في الجدول يؤدي إلى الانتقال لصفحة تفاصيل السهم.</li></ul> |
| **إدارة الأسهم**               | `manage:stocks`               | تسمح بإضافة، تعديل، وإدارة قائمة الأسهم التي يتتبعها النظام، مع ميزات التصفية والفرز والتقسيم.                                                                                                                                                                                                                                                                                                          |
| **إدارة الترجمات**             | `manage:translations`         | توفر واجهة مقسمة لتعديل جميع نصوص واجهة المستخدم (`key`, `value_en`, `value_ar`) المخزنة في قاعدة البيانات.                                                                                                                                                                                                                                                                                       |
| **تفاصيل السهم (Stock Details)** | `view:stock_analysis`         | صفحة تفصيلية مرتبطة من صفحة "آخر يوم عمل"، تعرض تحليلاً معمقًا لسهم واحد (رسم بياني 90 يومًا، توقع اليوم التالي، سجل التوقعات، المؤشرات الفنية، وأنماط الشموع).                                                                                                                                                                                                                                                                            |
| **سجل الأنشطة (Activity Log)**   | `view:activity_log`           | تعرض سجلاً مقسمًا ومفلتراً لجميع الإجراءات التي يتم تتبعها للمستخدم والنظام، |
--- END OF FILE ProSpec.txt ---
--- START OF FILE setup.sql.txt ---
-- #############################################################################
-- #
-- # Secure Admin Dashboard - Fresh Setup Script
-- # Version: 2.0 (Clean Build)
-- #
-- #############################################################################

-- -----------------------------------------------------------------------------
-- 1. EXTENSIONS & SCHEMA SETUP
-- -----------------------------------------------------------------------------
CREATE EXTENSION IF NOT EXISTS "pgcrypto" WITH SCHEMA "extensions";

-- -----------------------------------------------------------------------------
-- 2. CREATE TABLES (Order is important due to foreign keys)
-- -----------------------------------------------------------------------------
 
-- ROLES: Defines user roles like 'Admin', 'User'.
CREATE TABLE IF NOT EXISTS "public"."roles" (
    "id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    "name" text NOT NULL UNIQUE,
    "description" text,
    "created_at" timestamp with time zone DEFAULT now() NOT NULL
);
COMMENT ON TABLE public.roles IS 'Stores user roles and their descriptions.';

-- PERMISSIONS: Defines specific actions a user can take, e.g., 'manage:users'.
CREATE TABLE IF NOT EXISTS "public"."permissions" (
    "id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    "action" text NOT NULL UNIQUE,
    "description" text,
    "created_at" timestamp with time zone DEFAULT now() NOT NULL
);
COMMENT ON TABLE public.permissions IS 'Stores discrete actions that can be permitted.';

-- ROLE_PERMISSIONS: Maps permissions to roles (many-to-many relationship).
CREATE TABLE IF NOT EXISTS "public"."role_permissions" (
    "role_id" uuid NOT NULL REFERENCES public.roles(id) ON DELETE CASCADE,
    "permission_id" uuid NOT NULL REFERENCES public.permissions(id) ON DELETE CASCADE,
    PRIMARY KEY (role_id, permission_id)
);
COMMENT ON TABLE public.role_permissions IS 'Maps roles to their granted permissions.';

-- PROFILES: Stores public user data, linked to auth.users.
CREATE TABLE IF NOT EXISTS "public"."profiles" (
    "id" uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    "full_name" text,
    "email" text UNIQUE,
    "role_id" uuid REFERENCES public.roles(id) ON DELETE SET NULL,
    "updated_at" timestamp with time zone DEFAULT now() NOT NULL
);
COMMENT ON TABLE public.profiles IS 'Stores public-facing user profile information.';

-- TRANSLATIONS: For internationalization (i1n).
CREATE TABLE IF NOT EXISTS "public"."translations" (
    "id" bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "lang_id" text NOT NULL,
    "key" text NOT NULL,
    "value" text NOT NULL,
    UNIQUE (lang_id, key)
);
COMMENT ON TABLE public.translations IS 'Stores key-value translations for different languages.';

-- APP_SETTINGS: For global, non-translatable application settings.
CREATE TABLE IF NOT EXISTS "public"."app_settings" (
    "key" text PRIMARY KEY,
    "value" text
);
COMMENT ON TABLE public.app_settings IS 'Stores global application settings like a site logo.';

-- -----------------------------------------------------------------------------
-- 3. ROW LEVEL SECURITY (RLS)
-- -----------------------------------------------------------------------------

-- Enable RLS on all tables
ALTER TABLE public.roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.permissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.role_permissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.translations ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.app_settings ENABLE ROW LEVEL SECURITY;

-- Helper function to check if the current user has a specific permission.
CREATE OR REPLACE FUNCTION public.has_permission(permission_action text)
RETURNS boolean
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, auth
AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM public.profiles p
    JOIN public.role_permissions rp ON p.role_id = rp.role_id
    JOIN public.permissions perm ON rp.permission_id = perm.id
    WHERE p.id = auth.uid() AND perm.action = permission_action
  );
END;
$$;

-- PROFILES POLICIES
DROP POLICY IF EXISTS "Allow individual read/update access on profiles" ON "public"."profiles";
CREATE POLICY "Allow individual read/update access on profiles" ON "public"."profiles"
FOR ALL USING (auth.uid() = id);

DROP POLICY IF EXISTS "Allow managers read access on profiles" ON "public"."profiles";
CREATE POLICY "Allow managers read access on profiles" ON "public"."profiles"
FOR SELECT USING (public.has_permission('manage:users'));

-- ROLES, PERMISSIONS, ROLE_PERMISSIONS POLICIES
DROP POLICY IF EXISTS "Allow authenticated read access" ON "public"."roles";
CREATE POLICY "Allow authenticated read access" ON "public"."roles" FOR SELECT USING (auth.role() = 'authenticated');
DROP POLICY IF EXISTS "Allow authenticated read access" ON "public"."permissions";
CREATE POLICY "Allow authenticated read access" ON "public"."permissions" FOR SELECT USING (auth.role() = 'authenticated');
DROP POLICY IF EXISTS "Allow authenticated read access" ON "public"."role_permissions";
CREATE POLICY "Allow authenticated read access" ON "public"."role_permissions" FOR SELECT USING (auth.role() = 'authenticated');

DROP POLICY IF EXISTS "Allow managers full access" ON "public"."roles";
CREATE POLICY "Allow managers full access" ON "public"."roles" FOR ALL USING (public.has_permission('manage:roles'));
DROP POLICY IF EXISTS "Allow managers full access" ON "public"."role_permissions";
CREATE POLICY "Allow managers full access" ON "public"."role_permissions" FOR ALL USING (public.has_permission('manage:roles'));

-- TRANSLATIONS & APP_SETTINGS POLICIES
DROP POLICY IF EXISTS "Allow public read access" ON "public"."translations";
CREATE POLICY "Allow public read access" ON "public"."translations" FOR SELECT USING (true);
DROP POLICY IF EXISTS "Allow public read access" ON "public"."app_settings";
CREATE POLICY "Allow public read access" ON "public"."app_settings" FOR SELECT USING (true);

DROP POLICY IF EXISTS "Allow managers full access" ON "public"."translations";
CREATE POLICY "Allow managers full access" ON "public"."translations" FOR ALL USING (public.has_permission('manage:settings'));
DROP POLICY IF EXISTS "Allow managers full access" ON "public"."app_settings";
CREATE POLICY "Allow managers full access" ON "public"."app_settings" FOR ALL USING (public.has_permission('manage:settings'));

-- -----------------------------------------------------------------------------
-- 4. FUNCTIONS & TRIGGERS
-- -----------------------------------------------------------------------------

-- The core of the automatic setup. This trigger creates a profile for a new user.
-- CRUCIALLY, if it's the very first user, it automatically assigns them the 'Admin' role.
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = auth, public
AS $$
DECLARE
  user_count integer;
  admin_role_id uuid;
BEGIN
  -- Create the profile entry
  INSERT INTO public.profiles (id, full_name, email)
  VALUES (new.id, new.raw_user_meta_data->>'full_name', new.email);

  -- Check if this is the first user in the system
  SELECT count(*) INTO user_count FROM auth.users;

  -- If it is the first user, make them an admin.
  IF user_count = 1 THEN
    SELECT id INTO admin_role_id FROM public.roles WHERE name = 'Admin';
    IF admin_role_id IS NOT NULL THEN
      UPDATE public.profiles
      SET role_id = admin_role_id
      WHERE id = new.id;
    END IF;
  END IF;

  RETURN new;
END;
$$;

-- Trigger to call the function after a new user is created.
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

-- -----------------------------------------------------------------------------
-- 5. SEED DATA (Initial data to get started)
-- -----------------------------------------------------------------------------
BEGIN;

-- Temporarily disable RLS to insert seed data
ALTER TABLE public.roles DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.permissions DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.role_permissions DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.translations DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.app_settings DISABLE ROW LEVEL SECURITY;

-- Seed Roles (Idempotent: will not fail if roles already exist)
INSERT INTO public.roles (name, description) VALUES
('Admin', 'Has full access to all system features and settings.'),
('User', 'Standard user with basic permissions.')
ON CONFLICT (name) DO NOTHING;

-- Seed Permissions (Idempotent: will not fail if permissions already exist)
INSERT INTO public.permissions (action, description) VALUES
('manage:users', 'Can view the user list and change user roles.'),
('manage:roles', 'Can view the role list and change role permissions.'),
('view:dashboard', 'Can view the main dashboard and statistics.'),
('manage:settings', 'Can update site-wide application settings.')
ON CONFLICT (action) DO NOTHING;

-- Seed Role-Permission Mappings (Idempotent)
DO $$
DECLARE
    admin_role_id uuid;
    user_role_id uuid;
    manage_users_perm_id uuid;
    manage_roles_perm_id uuid;
    view_dashboard_perm_id uuid;
    manage_settings_perm_id uuid;
BEGIN
    -- Get IDs
    SELECT id INTO admin_role_id FROM public.roles WHERE name = 'Admin';
    SELECT id INTO user_role_id FROM public.roles WHERE name = 'User';
    SELECT id INTO manage_users_perm_id FROM public.permissions WHERE action = 'manage:users';
    SELECT id INTO manage_roles_perm_id FROM public.permissions WHERE action = 'manage:roles';
    SELECT id INTO view_dashboard_perm_id FROM public.permissions WHERE action = 'view:dashboard';
    SELECT id INTO manage_settings_perm_id FROM public.permissions WHERE action = 'manage:settings';

    -- Assign all permissions to Admin
    INSERT INTO public.role_permissions (role_id, permission_id) VALUES
    (admin_role_id, manage_users_perm_id),
    (admin_role_id, manage_roles_perm_id),
    (admin_role_id, view_dashboard_perm_id),
    (admin_role_id, manage_settings_perm_id)
    ON CONFLICT (role_id, permission_id) DO NOTHING;
    
    -- Assign basic permission to User
    INSERT INTO public.role_permissions (role_id, permission_id) VALUES
    (user_role_id, view_dashboard_perm_id)
    ON CONFLICT (role_id, permission_id) DO NOTHING;
END $$;

-- Seed App Settings (Idempotent: will update if key exists)
INSERT INTO public.app_settings (key, value) VALUES
('site_logo', '<svg width="24" height="24" viewBox="0 0 24 24"><path fill="#f25022" d="M1 1h10v10H1z"></path><path fill="#7fba00" d="M13 1h10v10H13z"></path><path fill="#00a4ef" d="M1 13h10v10H1z"></path><path fill="#ffb900" d="M13 13h10v10H13z"></path></svg>')
ON CONFLICT (key) DO UPDATE SET value = EXCLUDED.value;

-- Seed Basic Translations (Idempotent: will update if key exists)
INSERT INTO public.translations (lang_id, key, value) VALUES
('en', 'site_title', 'Admin Panel'), ('ar', 'site_title', 'لوحة التحكم'),
('en', 'dashboard', 'Dashboard'), ('ar', 'dashboard', 'لوحة التحكم'),
('en', 'user_management', 'User Management'), ('ar', 'user_management', 'إدارة المستخدمين'),
('en', 'role_management', 'Role Management'), ('ar', 'role_management', 'إدارة الصلاحيات'),
('en', 'welcome_message', 'Welcome back! Here''s an overview.'), ('ar', 'welcome_message', 'أهلاً بعودتك! هذه نظرة عامة.'),
('en', 'total_users', 'Total Users'), ('ar', 'total_users', 'إجمالي المستخدمين'),
('en', 'total_roles', 'Total Roles'), ('ar', 'total_roles', 'إجمالي الصلاحيات'),
('en', 'save', 'Save'), ('ar', 'save', 'حفظ'),
('en', 'cancel', 'Cancel'), ('ar', 'cancel', 'إلغاء'),
('en', 'email', 'Email'), ('ar', 'email', 'البريد الإلكتروني'),
('en', 'full_name', 'Full Name'), ('ar', 'full_name', 'الاسم الكامل'),
('en', 'role', 'Role'), ('ar', 'role', 'الصلاحية'),
('en', 'actions', 'Actions'), ('ar', 'actions', 'الإجراءات'),
('en', 'roles', 'Roles'), ('ar', 'roles', 'الصلاحيات'),
('en', 'permissions', 'Permissions'), ('ar', 'permissions', 'الأذونات'),
('en', 'sign_out', 'Sign Out'), ('ar', 'sign_out', 'تسجيل الخروج'),
('en', 'dark_theme', 'Dark Theme'), ('ar', 'dark_theme', 'الوضع الداكن'),
('en', 'light_theme', 'Light Theme'), ('ar', 'light_theme', 'الوضع الفاتح'),
('en', 'select_language', 'Select Language'), ('ar', 'select_language', 'اختر اللغة'),
('en', 'password', 'Password'), ('ar', 'password', 'كلمة المرور'),
('en', 'access_denied', 'Access Denied'), ('ar', 'access_denied', 'الوصول مرفوض'),
('en', 'no_permission_message', 'You do not have permission to view this page.'), ('ar', 'no_permission_message', 'ليس لديك الصلاحية لعرض هذه الصفحة.'),
('en', 'loading', 'Loading'), ('ar', 'loading', 'جاري التحميل'),
('en', 'no_role', 'No Role'), ('ar', 'no_role', 'بدون صلاحية'),
('en', 'select_role', 'Select Role'), ('ar', 'select_role', 'اختر صلاحية'),
('en', 'edit_role', 'Edit Role'), ('ar', 'edit_role', 'تعديل الصلاحية'),
('en', 'create_account', 'Create Account'), ('ar', 'create_account', 'إنشاء حساب'),
('en', 'sign_up', 'Sign Up'), ('ar', 'sign_up', 'تسجيل'),
('en', 'login', 'Login'), ('ar', 'login', 'تسجيل الدخول'),
('en', 'remember_me', 'Remember me'), ('ar', 'remember_me', 'تذكرني'),
('en', 'already_have_account', 'Already have an account? Log in'), ('ar', 'already_have_account', 'لديك حساب بالفعل؟ سجل الدخول'),
('en', 'create_new_account', 'Need an account? Sign up'), ('ar', 'create_new_account', 'تحتاج حساب؟ قم بالتسجيل'),
('en', 'signup_success', 'Account created! Please check your email to confirm.'), ('ar', 'signup_success', 'تم إنشاء الحساب! يرجى التحقق من بريدك الإلكتروني للتأكيد.'),
('en', 'site_settings', 'Site Settings'), ('ar', 'site_settings', 'إعدادات الموقع'),
('en', 'site_title_en', 'Site Title (English)'), ('ar', 'site_title_en', 'عنوان الموقع (انجليزي)'),
('en', 'site_title_ar', 'Site Title (Arabic)'), ('ar', 'site_title_ar', 'عنوان الموقع (عربي)'),
('en', 'site_logo', 'Site Logo (SVG Code)'), ('ar', 'site_logo', 'شعار الموقع (كود SVG)'),
('en', 'save_success', 'Settings saved successfully!'), ('ar', 'save_success', 'تم حفظ الإعدادات بنجاح!'),
('en', 'save_error', 'Failed to save settings.'), ('ar', 'save_error', 'فشل حفظ الإعدادات.'),
('en', 'saving', 'Saving'), ('ar', 'saving', 'جاري الحفظ'),
('en', 'n_a', 'N/A'), ('ar', 'n_a', 'غير متوفر'),
('en', 'cannot_edit_last_admin', 'Cannot change the role of the last admin.'), ('ar', 'cannot_edit_last_admin', 'لا يمكن تغيير صلاحية آخر مدير.'),
('en', 'select_role_to_manage', 'Select a role to manage its permissions.'), ('ar', 'select_role_to_manage', 'اختر صلاحية لإدارة أذوناتها.'),
('en', 'admin_role_note', 'Admin permissions cannot be changed.'), ('ar', 'admin_role_note', 'لا يمكن تغيير أذونات صلاحية المدير.'),
('en', 'add_new_user', 'Add New User'), ('ar', 'add_new_user', 'إضافة مستخدم جديد'),
('en', 'edit_user', 'Edit User'), ('ar', 'edit_user', 'تعديل المستخدم'),
('en', 'password_initial', 'Password (Initial)'), ('ar', 'password_initial', 'كلمة المرور (مبدئية)'),
('en', 'edit', 'Edit'), ('ar', 'edit', 'تعديل'),
('en', 'send_password_reset', 'Send Password Reset Email'), ('ar', 'send_password_reset', 'إرسال بريد إعادة تعيين كلمة المرور'),
('en', 'reset_password_email_sent', 'Reset email sent!'), ('ar', 'reset_password_email_sent', 'تم إرسال البريد!'),
('en', 'reset_password_email_error', 'Failed to send. Try again.'), ('ar', 'reset_password_email_error', 'فشل الإرسال. حاول مجدداً.'),
('en', 'landing_page_description', 'Welcome to your secure management portal.'), 
('ar', 'landing_page_description', 'أهلاً بك في بوابة الإدارة الآمنة.')
ON CONFLICT (lang_id, key) DO UPDATE SET value = EXCLUDED.value;

-- Re-enable RLS
ALTER TABLE public.roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.permissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.role_permissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.translations ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.app_settings ENABLE ROW LEVEL SECURITY;

COMMIT;

-- #############################################################################
-- # USER NOTES FEATURE - ADDED 2024-08-01
-- #############################################################################
BEGIN;

-- Create the user_notes table.
CREATE TABLE IF NOT EXISTS public.user_notes (
  id BIGSERIAL PRIMARY KEY,
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  note_content TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
COMMENT ON TABLE public.user_notes IS 'Stores notes and feedback submitted by users.';

-- Add the new permission to the permissions table.
INSERT INTO public.permissions (action, description)
VALUES
  ('manage:user_notes', 'Can view, manage, and export all user-submitted notes.'),
  ('submit:user_notes', 'Can access the "My Notes" page to submit feedback.')
ON CONFLICT (action) DO UPDATE SET description = EXCLUDED.description;

-- Assign the new permission to the Admin role.
DO $$
DECLARE
    admin_role_id UUID;
    user_role_id UUID;
    manage_notes_perm_id UUID;
    submit_notes_perm_id UUID;
BEGIN
    SELECT id INTO admin_role_id FROM public.roles WHERE name = 'Admin';
    SELECT id INTO user_role_id FROM public.roles WHERE name = 'User';
    SELECT id INTO manage_notes_perm_id FROM public.permissions WHERE action = 'manage:user_notes';
    SELECT id INTO submit_notes_perm_id FROM public.permissions WHERE action = 'submit:user_notes';

    -- Assign manage permission to Admin
    IF admin_role_id IS NOT NULL AND manage_notes_perm_id IS NOT NULL THEN
        INSERT INTO public.role_permissions (role_id, permission_id)
        VALUES (admin_role_id, manage_notes_perm_id)
        ON CONFLICT (role_id, permission_id) DO NOTHING;
    END IF;

    -- Assign submit permission to BOTH Admin and User by default
    IF admin_role_id IS NOT NULL AND submit_notes_perm_id IS NOT NULL THEN
        INSERT INTO public.role_permissions (role_id, permission_id)
        VALUES (admin_role_id, submit_notes_perm_id)
        ON CONFLICT (role_id, permission_id) DO NOTHING;
    END IF;

    IF user_role_id IS NOT NULL AND submit_notes_perm_id IS NOT NULL THEN
        INSERT INTO public.role_permissions (role_id, permission_id)
        VALUES (user_role_id, submit_notes_perm_id)
        ON CONFLICT (role_id, permission_id) DO NOTHING;
    END IF;

END $$;

-- Set up Row Level Security (RLS) on the new table.
ALTER TABLE public.user_notes ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Allow users to insert their own notes" ON public.user_notes;
CREATE POLICY "Allow users to insert their own notes"
    ON public.user_notes FOR INSERT
    WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "Allow managers to read all notes" ON public.user_notes;
CREATE POLICY "Allow managers to read all notes"
    ON public.user_notes FOR SELECT
    USING (public.has_permission('manage:user_notes'));

-- Create RPC functions for secure data access.
CREATE OR REPLACE FUNCTION public.submit_user_note(p_note_content TEXT)
RETURNS void
LANGUAGE plpgsql
AS $$
BEGIN
  INSERT INTO public.user_notes (user_id, note_content)
  VALUES (auth.uid(), p_note_content);
END;
$$;

CREATE OR REPLACE FUNCTION public.get_all_user_notes(page_num INT, page_size INT, search_query TEXT DEFAULT '')
RETURNS TABLE (
    id bigint,
    created_at timestamptz,
    user_id uuid,
    note_content text,
    user_full_name text,
    user_email text,
    total_count bigint
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, auth
AS $$
DECLARE
  query_offset INT;
BEGIN
  IF NOT public.has_permission('manage:user_notes') THEN
    RETURN;
  END IF;

  query_offset := (page_num - 1) * page_size;

  RETURN QUERY
  WITH filtered_notes AS (
    SELECT
      un.id,
      un.created_at,
      un.user_id,
      un.note_content,
      p.full_name AS user_full_name,
      p.email AS user_email
    FROM public.user_notes un
    JOIN public.profiles p ON un.user_id = p.id
    WHERE
      (search_query = '' OR search_query IS NULL OR p.email ILIKE '%' || search_query || '%' OR p.full_name ILIKE '%' || search_query || '%' OR un.note_content ILIKE '%' || search_query || '%')
  )
  SELECT
    fn.id,
    fn.created_at,
    fn.user_id,
    fn.note_content,
    fn.user_full_name,
    fn.user_email,
    count(*) OVER() AS total_count
  FROM filtered_notes fn
  ORDER BY fn.created_at DESC
  OFFSET query_offset
  LIMIT page_size;
END;
$$;

-- Add required UI translations.
ALTER TABLE public.translations DISABLE ROW LEVEL SECURITY;

INSERT INTO public.translations (lang_id, key, value) VALUES
('en', 'user_notes', 'My Notes'),
('ar', 'user_notes', 'ملاحظاتي'),
('en', 'manage_user_notes', 'Manage User Notes'),
('ar', 'manage_user_notes', 'إدارة ملاحظات المستخدمين'),
('en', 'perm_manage_user_notes', 'Manage User Notes'),
('ar', 'perm_manage_user_notes', 'إدارة ملاحظات المستخدمين'),
('en', 'perm_manage_user_notes_desc', 'Can view, manage, and export all user-submitted notes.'),
('ar', 'perm_manage_user_notes_desc', 'يمكنه عرض وإدارة وتصدير جميع الملاحظات المقدمة من المستخدمين.'),
('en', 'perm_submit_user_notes', 'Submit User Notes'),
('ar', 'perm_submit_user_notes', 'إرسال ملاحظات المستخدم'),
('en', 'perm_submit_user_notes_desc', 'Can access the "My Notes" page to submit feedback.'),
('ar', 'perm_submit_user_notes_desc', 'يمكنه الوصول إلى صفحة "ملاحظاتي" لإرسال الملاحظات.'),
('en', 'submit_your_notes', 'Submit Your Notes'),
('ar', 'submit_your_notes', 'أرسل ملاحظاتك'),
('en', 'write_your_notes_here', 'Write your notes here...'),
('ar', 'write_your_notes_here', 'اكتب ملاحظاتك هنا...'),
('en', 'save_and_send', 'Save and Send'),
('ar', 'save_and_send', 'حفظ وإرسال'),
('en', 'note_submitted_successfully', 'Your note has been submitted successfully. Thank you!'),
('ar', 'note_submitted_successfully', 'تم إرسال ملاحظتك بنجاح. شكراً لك!'),
('en', 'note_submission_failed', 'Failed to submit your note. Please try again.'),
('ar', 'note_submission_failed', 'فشل إرسال ملاحظتك. يرجى المحاولة مرة أخرى.'),
('en', 'note_content', 'Note Content'),
('ar', 'note_content', 'محتوى الملاحظة'),
('en', 'submitted_by', 'Submitted By'),
('ar', 'submitted_by', 'مقدمة من'),
('en', 'submission_date', 'Date'),
('ar', 'submission_date', 'التاريخ'),
('en', 'export_csv', 'Export CSV'),
('ar', 'export_csv', 'تصدير CSV'),
('en', 'print', 'Print'),
('ar', 'print', 'طباعة'),
('en', 'search_notes', 'Search by user or note content...'),
('ar', 'search_notes', 'ابحث بالمستخدم أو محتوى الملاحظة...')
ON CONFLICT (lang_id, key) 
DO UPDATE SET value = EXCLUDED.value;

ALTER TABLE public.translations ENABLE ROW LEVEL SECURITY;

COMMIT;

-- #############################################################################
-- # END OF SCRIPT
-- #############################################################################
--- END OF FILE setup.sql.txt ---
--- START OF FILE AllDataSource.txt ---
--- START OF FILE index.tsx ---
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import { ThemeProvider } from './contexts/ThemeContext';
import { LanguageProvider } from './contexts/LanguageContext';
import { AppSettingsProvider } from './contexts/AppSettingsContext';
import { AuthProvider } from './contexts/AuthContext';
import { AnnouncementsProvider } from './contexts/AnnouncementsContext';
import { FavoritesProvider } from './contexts/FavoritesContext';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
} 

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <ThemeProvider>
      <AppSettingsProvider>
        <AuthProvider>
          <FavoritesProvider>
            <LanguageProvider>
              <AnnouncementsProvider>
                <App />
              </AnnouncementsProvider>
            </LanguageProvider>
          </FavoritesProvider>
        </AuthProvider>
      </AppSettingsProvider>
    </ThemeProvider>
  </React.StrictMode>
);
--- END OF FILE index.tsx ---
--- START OF FILE metadata.json ---
{
  "name": "Secure Admin Dashboard",
  "description": "A secure, role-based admin dashboard built from the ground up with React and Supabase. Features clean architecture, a robust permission system, and a professional user interface.",
  "requestFramePermissions": []
}
--- END OF FILE metadata.json ---
--- START OF FILE index.html ---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MRowDir</title>

    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#4338ca" />

    <!-- Apple PWA specific tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="MRowDir">
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    
    <script>
      // FOUC-prevention script to apply theme on initial load
      if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
      };
    </script>
    
    <script type="importmap">
{
  "imports": {
    "@supabase/supabase-js": "https://aistudiocdn.com/@supabase/supabase-js@^2.76.1",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@supabase/gotrue-js": "https://aistudiocdn.com/@supabase/gotrue-js@^2.78.0"
  }
}
</script>
  </head>
  <body class="bg-gray-50 dark:bg-gray-900">
    <div id="root"></div>
    <script type="module" src="/index.tsx"></script>

    <!-- PWA Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js').then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, err => {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script>
  </body>
</html>
--- END OF FILE index.html ---
--- START OF FILE App.tsx ---
import React, { useState, useEffect } from 'react';
import Layout from './components/Layout';
import Dashboard from './components/pages/Dashboard';
import UserManagement from './components/pages/UserManagement';
import RoleManagement from './components/pages/RoleManagement';
import AnnouncementsManagement from './components/pages/AnnouncementsManagement';
import SystemDocumentation from './components/pages/SystemDocumentation';
import StockAnalysis from './components/pages/StockAnalysis';
import DailyWatchlist from './components/pages/DailyWatchlist';
import StockManagement from './components/pages/StockManagement';
import StockDetails from './components/pages/StockDetails';
import TranslationManagement from './components/pages/TranslationManagement';
import ActivityLog from './components/pages/ActivityLog';
import UserNotes from './components/pages/UserNotes'; // New
import UserNotesManagement from './components/pages/UserNotesManagement'; // New
import LandingPage from './components/pages/LandingPage';
import AccessDenied from './components/AccessDenied';
import { useLanguage } from './contexts/LanguageContext';
import { useAuth } from './contexts/AuthContext';
import type { PageName, PageState } from './types';

const App: React.FC = () => {
  const { session, loading, hasPermission, profile } = useAuth();
  const [currentPage, setCurrentPage] = useState<PageState>('landing');
  const { direction, t, language } = useLanguage();

  useEffect(() => {
    document.documentElement.dir = direction;
    document.documentElement.lang = language;
  }, [direction, language]);
  
  const currentPageName = typeof currentPage === 'string' ? currentPage : currentPage.page;
  
  // Effect to set the page title dynamically
  useEffect(() => {
    const pageTitleKeyMap: { [key in PageName]: string } = {
      landing: 'site_title',
      dashboard: 'dashboard',
      users: 'user_management',
      roles: 'role_management',
      announcements: 'announcement_management',
      system_documentation: 'system_documentation',
      stock_analysis: 'stock_analysis',
      daily_watchlist: 'daily_watchlist',
      stock_management: 'stock_management',
      translations: 'translation_management',
      stock_details: 'stock_details',
      activity_log: 'activity_log',
      user_notes: 'user_notes', // New
      user_notes_management: 'manage_user_notes', // New
    };
    const titleKey = pageTitleKeyMap[currentPageName];
    document.title = (currentPageName === 'landing' || !session) 
        ? t(titleKey)
        : `${t(titleKey)} | ${t('site_title')}`;
  }, [currentPageName, t, language, session]);

  // Effect to dynamically update PWA manifest and title
  useEffect(() => {
    const siteTitle = t('site_title');
    // Don't run if translation isn't ready or it's the default key
    if (!siteTitle || siteTitle === 'site_title') return;

    // Update apple-mobile-web-app-title meta tag
    const appleTitleTag = document.querySelector('meta[name="apple-mobile-web-app-title"]');
    if (appleTitleTag) {
      appleTitleTag.setAttribute('content', siteTitle);
    }
    
    // Create a dynamic manifest
    const manifest = {
      "short_name": siteTitle,
      "name": siteTitle,
      "description": "Professional and visually engaging stock price predictions for the U.S. markets.",
      "icons": [
        { "src": "/favicon.ico", "sizes": "64x64 32x32 24x24 16x16", "type": "image/x-icon" },
        { "src": "/icons/icon-192.png", "type": "image/png", "sizes": "192x192" },
        { "src": "/icons/icon-512.png", "type": "image/png", "sizes": "512x512" }
      ],
      "start_url": "/",
      "display": "standalone",
      "scope": "/",
      "theme_color": "#4338ca",
      "background_color": "#ffffff"
    };

    const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
    const manifestUrl = URL.createObjectURL(manifestBlob);

    // Update the manifest link tag
    const manifestLink = document.querySelector('link[rel="manifest"]');
    if (manifestLink) {
      manifestLink.setAttribute('href', manifestUrl);
    }

  }, [t, language]);

  // Effect to handle page access control and redirection
  useEffect(() => {
    if (loading || (session && !profile)) return; // Wait until authentication and profile loading is complete

    if (!session) {
      // If user is not logged in, they can only be on the landing page.
      if (currentPageName !== 'landing') {
        setCurrentPage('landing');
      }
      return;
    }

    // If user is logged in, check permissions for the current page.
    const pagePermissions: Record<PageName, string | null> = {
        landing: null, // Always allowed
        dashboard: 'view:dashboard',
        users: 'manage:users',
        roles: 'manage:roles',
        announcements: 'manage:announcements',
        system_documentation: 'view:system_documentation',
        stock_analysis: 'view:stock_analysis',
        daily_watchlist: 'view:daily_watchlist',
        stock_management: 'manage:stocks',
        translations: 'manage:translations',
        stock_details: 'view:stock_analysis', // Re-use stock_analysis permission
        activity_log: 'view:activity_log',
        user_notes: 'submit:user_notes', // Use dedicated permission
        user_notes_management: 'manage:user_notes', // Admin-only
    };
    
    const requiredPermission = pagePermissions[currentPageName];
    
    // If user is on a protected page but lacks permission, redirect them.
    if (requiredPermission && !hasPermission(requiredPermission)) {
        // Try redirecting to dashboard first. If they can't view that, send to landing.
        if (hasPermission('view:dashboard')) {
            setCurrentPage('dashboard');
        } else if (hasPermission('view:stock_analysis')) {
            setCurrentPage('stock_analysis'); // Redirect standard users to their default page
        } else {
            setCurrentPage('landing');
        }
    }
  }, [currentPageName, session, profile, hasPermission, loading]);
  
  if (loading || (session && !profile)) {
     return <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">{t('loading')}...</div>;
  }
  
  // The main layout is now always rendered. Header/Sidebar handle auth state.
  const renderPage = () => {
    const pageName = typeof currentPage === 'string' ? currentPage : currentPage.page;
    switch (pageName) {
      case 'users':
        return hasPermission('manage:users') ? <UserManagement /> : <AccessDenied />;
      case 'roles':
        return hasPermission('manage:roles') ? <RoleManagement /> : <AccessDenied />;
      case 'announcements':
        return hasPermission('manage:announcements') ? <AnnouncementsManagement /> : <AccessDenied />;
      case 'system_documentation':
        return hasPermission('view:system_documentation') ? <SystemDocumentation /> : <AccessDenied />;
      case 'stock_analysis':
        return hasPermission('view:stock_analysis') ? <StockAnalysis setPage={setCurrentPage} /> : <AccessDenied />;
      case 'daily_watchlist': 
        return hasPermission('view:daily_watchlist') ? <DailyWatchlist setPage={setCurrentPage} /> : <AccessDenied />;
      case 'stock_management':
        return hasPermission('manage:stocks') ? <StockManagement /> : <AccessDenied />;
      case 'translations':
        return hasPermission('manage:translations') ? <TranslationManagement /> : <AccessDenied />;
      case 'activity_log':
        return hasPermission('view:activity_log') ? <ActivityLog /> : <AccessDenied />;
      case 'user_notes': // New
        return hasPermission('submit:user_notes') ? <UserNotes /> : <AccessDenied />;
      case 'user_notes_management': // New
        return hasPermission('manage:user_notes') ? <UserNotesManagement /> : <AccessDenied />;
      case 'stock_details':
        if (typeof currentPage === 'object' && hasPermission('view:stock_analysis')) {
          return <StockDetails symbol={currentPage.symbol} setPage={setCurrentPage} />;
        }
        return <AccessDenied />;
      case 'dashboard':
        return hasPermission('view:dashboard') ? <Dashboard /> : <AccessDenied />;
      case 'landing':
      default:
        // The landing page should be accessible to everyone.
        return <LandingPage />;
    }
  };
  
  return (
    <Layout profile={profile} setPage={setCurrentPage} currentPage={currentPageName}>
      {renderPage()}
    </Layout>
  );
};

export default App;
--- END OF FILE App.tsx ---
--- START OF FILE types.ts ---
export interface Profile {
  id: string;
  full_name: string | null;
  email: string | null;
  role_id: string | null;
  email_confirmed_at: string | null;
  preferred_language: Language;
  // This nested structure is what we fetch from Supabase
  roles: {
    name: string;
    permissions: {
      action: string;
    }[];
  } | null;
}

export interface Role {
  id: string;
  name: string;
  description: string | null;
}

export interface Permission {
  id: string;
  action: string;
  description: string | null;
}

export interface RolePermission {
    role_id: string;
    permission_id: string;
}

export type AnnouncementType = 'info' | 'warning' | 'success' | 'error';

export interface GlobalAnnouncement {
    id: number;
    title: { [key: string]: string }; // For JSONB: { en: 'Title', ar: 'عنوان' }
    message: { [key: string]: string }; // For JSONB
    type: AnnouncementType;
    start_date: string; // ISO 8601 string
    end_date: string;   // ISO 8601 string
    is_enabled: boolean;
    created_at: string;
}

// FIX: Added the missing Advertisement interface to resolve import errors.
export interface Advertisement {
    id: number;
    title: { [key: string]: string }; // For JSONB: { en: 'Title', ar: 'عنوان' }
    advertiser_name: { [key: string]: string } | null; // For JSONB
    image_url: string | null;
    target_url: string | null;
    placement: string;
    start_date: string; // ISO 8601 string
    end_date: string;   // ISO 8601 string
    is_enabled: boolean;
    created_at: string;
}

export type Language = 'en' | 'ar';
export type Theme = 'light' | 'dark';

export type Translations = {
  [key: string]: string;
};

export type AppSettings = {
  [key: string]: string;
};

// --- App Navigation Types ---
export type PageName = 'landing' | 'dashboard' | 'users' | 'roles' | 'announcements' | 'system_documentation' | 'stock_analysis' | 'daily_watchlist' | 'stock_management' | 'translations' | 'stock_details' | 'activity_log' | 'user_notes' | 'user_notes_management';
export type PageState = PageName | { page: 'stock_details'; symbol: string };


// --- System Documentation Types ---

export interface ColumnDocumentation {
    name: string;
    type: string;
    nullable: 'YES' | 'NO';
    default: string | null;
    description: string | null;
}

export interface TableDocumentation {
    name: string;
    description: string | null;
    columns: ColumnDocumentation[];
}

export interface FunctionDocumentation {
    name: string;
    definition: string;
}

export interface PolicyDocumentation {
    table: string;
    name: string;
    command: 'SELECT' | 'INSERT' | 'UPDATE' | 'DELETE' | 'ALL';
    definition: string | null;
    with_check: string | null;
}

export interface DatabaseDocumentation {
    tables: TableDocumentation[];
    functions: FunctionDocumentation[];
    policies: PolicyDocumentation[];
}

// --- Stock Analysis Types ---
export interface DailyChecklistItem {
  stock_symbol: string;
  stock_name: string;
  last_updated: string | null;
  price: number | null;
  actual_low: number;
  actual_high: number;
  predicted_lo: number;
  predicted_hi: number;
  is_hit: boolean;
  forecast_date: string;
}

export interface DailyWatchlistItem {
  // Stock info
  symbol: string;
  stock_name: string;
  last_price: number | null;
  daily_change: number | null;
  daily_change_percent: number | null;
  
  // Next upcoming forecast
  next_forecast_date: string | null;
  next_predicted_lo: number | null;
  next_predicted_hi: number | null;
  
  // Latest technical indicators
  indicator_date: string | null;
  rsi: number | null;
  macd: number | null;
  macd_signal: number | null;
  sma20: number | null;
  sma50: number | null;

  // Latest candle pattern
  pattern_name: string | null;
  bullish: boolean | null;
}


// --- NEW Stock Management Type ---
export interface Stock {
  symbol: string;
  name: string;
  is_tracked: boolean;
  price?: number | null;
  change?: number | null;
  change_percent?: number | null;
  volume?: number | null;
  market_cap?: number | null;
  last_updated?: string | null;
}


// --- OLD / UNUSED TYPES ---
export interface StockListItem {
    symbol: string;
    name: string;
}

export interface StockDetails {
    symbol: string;
    name: string;
    price: number;
    change: number;
    change_percent: number;
    volume: number;
    market_cap: number;
    last_updated: string;
    is_tracked: boolean;
}

export interface HistoricalData {
    id: number;
    stock_symbol: string;
    date: string;
    open: number;
    high: number;
    low: number;
    close: number;
    volume: number;
}

export interface TechnicalIndicators {
    id: number;
    stock_symbol: string;
    date: string;
    rsi: number | null;
    macd: number | null;
    macd_signal: number | null;
    macd_histogram: number | null;
    sma20: number | null;
    sma50: number | null;
    sma200: number | null;
    ema12: number | null;
    ema26: number | null;
    boll_upper: number | null;
    boll_middle: number | null;
    boll_lower: number | null;
    stochastic_k: number | null;
    stochastic_d: number | null;
    williams_r: number | null;
    volatility_20: number | null;
    atr14: number | null;
    macd_cross: number | null;
    rsi_zone: number | null;
}

export interface CandlePattern {
    id: number;
    stock_symbol: string;
    date: string;
    pattern_name: string;
    bullish: boolean;
    confidence: number;
}

export interface Forecast {
    id: number;
    stock_symbol: string;
    forecast_date: string;
    predicted_price: number;
    predicted_lo: number;
    predicted_hi: number;
    confidence: number;
}

export interface ForecastHistory {
    run_id: number;
    stock_symbol: string;
    forecast_date: string;
    predicted_price: number;
    actual_close: number;
    hit_range: boolean;
}

export interface StockDeepDive {
    details: StockDetails;
    historical_data: HistoricalData[];
    technical_indicators: TechnicalIndicators[];
    candle_patterns: CandlePattern[];
    latest_forecast: Forecast | null;
    forecast_history: ForecastHistory[];
}

// --- Stock Details Page Types ---

export interface ForecastCheckHistoryItem {
    stock_symbol: string;
    forecast_date: string;
    predicted_price: number | null;
    predicted_lo: number;
    predicted_hi: number;
    actual_low: number;
    actual_high: number;
    actual_close: number | null;
    hit_range: boolean;
    abs_error: number | null;
    pct_error: number | null;
    confidence: number | null;
    created_at: string;
}

export interface StockDetailsPageData {
    details: Stock | null;
    next_forecast: Forecast | null;
    historical_data: HistoricalData[];
    latest_indicators: TechnicalIndicators | null;
    forecast_history: ForecastCheckHistoryItem[];
    recent_patterns: CandlePattern[];
}

// --- NEW Activity Log Type ---
export interface ActivityLogItem {
  id: number;
  created_at: string;
  user_full_name: string | null;
  user_email: string | null;
  action: string;
  ip_address: string | null;
  details: any; // JSONB
  total_count: number;
}

// --- NEW User Notes Types ---
export interface UserNote {
  id: number;
  created_at: string;
  user_id: string;
  note_content: string;
  user_full_name: string | null; // From JOIN
  user_email: string | null; // From JOIN
  total_count: number; // For pagination
}
--- END OF FILE types.ts ---
... (The rest of the files would follow in the structured order described in the thought process) ...
