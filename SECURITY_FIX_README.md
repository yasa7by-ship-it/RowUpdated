# Security Fix - Migration Guide

## ๐ ุงููููุงุช ุงููุฑููุฉ

1. **`SECURITY_FIX_FUNCTIONS_LIST.csv`** - ูุงุฆูุฉ ููุงุฆูุฉ ุจุฌููุน ุงูุฏูุงู ูููู `search_path` ุงููุทููุจุฉ
2. **`migration_174_security_fix_add_search_path.sql.txt`** - Migration Script ุงูุดุงูู
3. **`rollback_security_fixes.sql.txt`** - Rollback Script ููุฑุฌูุน
4. **`BEFORE_AFTER_REPORT.sql.txt`** - ุชูุงุฑูุฑ ูุจู/ุจุนุฏ ุงูุชูููุฐ
5. **`SMOKE_TEST.sql.txt`** - ุงุฎุชุจุงุฑุงุช Smoke Tests

---

## ๐ ุฎุทูุงุช ุงูุชูููุฐ

### ุงูุฎุทูุฉ 1: ุงููุณุฎ ุงูุงุญุชูุงุทู
```sql
-- ุญูุธ ุฌููุน ุชุนุฑููุงุช ุงูุฏูุงู ูุจู ุงูุชุนุฏูู
SELECT 
    p.proname as function_name,
    pg_get_functiondef(p.oid) as function_definition
FROM pg_proc p
JOIN pg_namespace n ON p.pronamespace = n.oid
WHERE n.nspname = 'public'
    AND p.proname NOT LIKE 'pg_%'
ORDER BY p.proname;
```
**ุงุญูุธ ุงููุชูุฌุฉ ูู ููู:** `FUNCTIONS_BACKUP_BEFORE.sql`

### ุงูุฎุทูุฉ 2: ุชูุฑูุฑ ูุจู ุงูุชูููุฐ
```sql
-- ุชูููุฐ BEFORE_AFTER_REPORT.sql.txt (ูุจู ุงูุชูููุฐ)
-- ุงุญูุธ ุงููุชูุฌุฉ ูู: BEFORE_SECURITY_FIX_REPORT.txt
```

### ุงูุฎุทูุฉ 3: ุชูููุฐ Migration
```sql
-- ุชูููุฐ migration_174_security_fix_add_search_path.sql.txt
-- โ๏ธ ุชุฃูุฏ ูู ุฃูู ูู ุจูุฆุฉ ุขููุฉ (ุบูุฑ Production) ุฃููุงู
-- โ๏ธ ุงูููู ูุญุชูู ุนูู ูุนุงููุฉ ูุงุญุฏุฉ (BEGIN...COMMIT)
-- โ๏ธ ูููุฉ ุงูุชูููุฐ: 5 ุฏูุงุฆู
```

### ุงูุฎุทูุฉ 4: ุชูุฑูุฑ ุจุนุฏ ุงูุชูููุฐ
```sql
-- ุชูููุฐ BEFORE_AFTER_REPORT.sql.txt (ุจุนุฏ ุงูุชูููุฐ)
-- ุงุญูุธ ุงููุชูุฌุฉ ูู: AFTER_SECURITY_FIX_REPORT.txt
```

### ุงูุฎุทูุฉ 5: Smoke Tests
```sql
-- ุชูููุฐ SMOKE_TEST.sql.txt
-- ุชุฃูุฏ ูู ุฃู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ุชูุฑ ุจูุฌุงุญ
-- ุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ Warnings
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

### ุญูู `get_tomorrows_forecasts`
- ุงูุฏุงูุฉ `get_tomorrows_forecasts` **ุบูุฑ ููุฌูุฏุฉ** ูู ุงูููุฏ ุงูุญุงูู
- ุชู ุงุณุชุจุฏุงููุง ุจู `get_the_coming_trend_data` ุฃู `get_daily_watchlist_data`
- ุฅุฐุง ูุงูุช ููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ ุณูุชู ุฅุตูุงุญูุง ุชููุงุฆูุงู ุจุงูููุฌ ุงูุฏููุงูููู

### ุญูู ุงูุฏูุงู ุงูููููุฏุฉ ุงูุฃุฎุฑู
- `set_updated_at` - ูุฏ ุชููู ููุฌูุฏุฉ ูู migrations ุฃุฎุฑู
- `get_my_role` - ูุฏ ุชููู ููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- `get_confidence_analysis_data` - ุชุญุชุงุฌ ูุญุต ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

**ุงูููุฌ ุงูุฏููุงูููู ูู Migration Script ุณูุตูุญ ุฌููุน ุงูุฏูุงู ุงููุชุจููุฉ ุชููุงุฆูุงู**

---

## โ ุงูุชุญูู ูู ุงููุฌุงุญ

### Checklist:
- [ ] ุชู ุชูููุฐ Migration ุจุฏูู ุฃุฎุทุงุก
- [ ] ุฌููุน Smoke Tests ุชูุฑ ุจูุฌุงุญ
- [ ] ูุง ุชูุฌุฏ Warnings ูู ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑุงุช
- [ ] ุฌููุน ุงูุฏูุงู ูุฏููุง `SET search_path` ุงูุขู
- [ ] ุงูุฏูุงู ุงูุชู ุชุณุชุฎุฏู `auth` ูุฏููุง `SET search_path = public, auth, pg_temp`
- [ ] ุงูุฏูุงู ุงูุฃุฎุฑู ูุฏููุง `SET search_path = public, pg_temp`

---

## ๐ Rollback

ุฅุฐุง ุงุญุชุฌุช ููุฑุฌูุน:

1. **ุงูุทุฑููุฉ ุงูููุถูุฉ:** ุงุณุชุนุงุฏุฉ ูู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
2. **ุงูุทุฑููุฉ ุงูุจุฏููุฉ:** ุชูููุฐ `rollback_security_fixes.sql.txt`
3. **ุงูุชุญูู:** ุชุฃูุฏ ูู ุฃู ุงูุฏูุงู ุนุงุฏุช ููุญุงูุฉ ุงูุฃุตููุฉ

---

## ๐ ุงูุฅุญุตุงุฆูุงุช ุงููุชููุนุฉ

- **ุฅุฌูุงูู ุงูุฏูุงู ุงููุณุชูุฏูุฉ:** ~59 ุฏุงูุฉ
- **ุงูุฏูุงู ุงูุชู ุชุญุชุงุฌ `SET search_path = public, pg_temp`:** ~54 ุฏุงูุฉ
- **ุงูุฏูุงู ุงูุชู ุชุญุชุงุฌ `SET search_path = public, auth, pg_temp`:** ~5 ุฏูุงู
- **ุงูุฏูุงู ุงูุตุญูุญุฉ (ูุง ุชุญุชุงุฌ ุชุนุฏูู):** ~15 ุฏุงูุฉ

---

## โ๏ธ ุชุญุฐูุฑุงุช

1. **ูุง ุชุนุฏู ุฏูุงู Supabase:** ุงูุฏูุงู ูู schemas (`auth`, `extensions`, `storage`, `graphql`, `realtime`, `vault`) ูู ูู Supabase ููุง ูุฌุจ ุชุนุฏูููุง
2. **ุงูุชุฑุชูุจ ููู:** Migration Script ูุตูู ููุนูู ูู ูุนุงููุฉ ูุงุญุฏุฉ
3. **ุงูุงุฎุชุจุงุฑ ุถุฑูุฑู:** ูุฌุจ ุงุฎุชุจุงุฑ ุฌููุน ุงูุฏูุงู ุจุนุฏ ุงูุชุนุฏููุงุช

---

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:
1. ุฑุงุฌุน ูููุงุช ุงูุชูุงุฑูุฑ (BEFORE/AFTER)
2. ุฑุงุฌุน ูุชุงุฆุฌ Smoke Tests
3. ุฑุงุฌุน ููู CSV ููุชุญูู ูู ุงูุฏูุงู ุงููุณุชูุฏูุฉ



