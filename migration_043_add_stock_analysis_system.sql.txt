-- #############################################################################
-- #
-- # MIGRATION SCRIPT: Add Stock Analysis System
-- #
-- # Purpose: This script introduces the backend components for the new
-- # Stock Analysis dashboard page.
-- #
-- # It performs three key actions:
-- # 1. Creates a new permission `view:stock_analysis`.
-- # 2. Assigns this permission to the 'Admin' role.
-- # 3. Creates a suite of secure RPC functions to fetch aggregated and
-- #    detailed data for the analysis page, improving performance and security.
-- #
-- # This script is safe to run multiple times.
-- #
-- #############################################################################

BEGIN;

-- Step 1: Add the new permission to the permissions table.
INSERT INTO public.permissions (action, description)
VALUES ('view:stock_analysis', 'Can view the stock analysis and forecast performance dashboard.')
ON CONFLICT (action) DO UPDATE SET description = EXCLUDED.description;


-- Step 2: Assign the new permission to the Admin role.
DO $$
DECLARE
    admin_role_id UUID;
    view_analysis_perm_id UUID;
BEGIN
    RAISE NOTICE 'SUCCESS: Permission "view:stock_analysis" added or already exists.';
    -- Get IDs
    SELECT id INTO admin_role_id FROM public.roles WHERE name = 'Admin';
    SELECT id INTO view_analysis_perm_id FROM public.permissions WHERE action = 'view:stock_analysis';

    -- Assign the permission to Admin if both exist
    IF admin_role_id IS NOT NULL AND view_analysis_perm_id IS NOT NULL THEN
        INSERT INTO public.role_permissions (role_id, permission_id)
        VALUES (admin_role_id, view_analysis_perm_id)
        ON CONFLICT (role_id, permission_id) DO NOTHING;

        IF FOUND THEN
             RAISE NOTICE 'SUCCESS: Assigned "view:stock_analysis" permission to Admin role.';
        ELSE
             RAISE NOTICE 'INFO: Admin role already has "view:stock_analysis" permission.';
        END IF;
    ELSE
        RAISE WARNING 'Could not assign "view:stock_analysis" permission. Admin role or permission not found.';
    END IF;
END $$;


-- Step 3: Create RPC functions for the analysis page.

-- Function 1: Get high-level summary statistics.
CREATE OR REPLACE FUNCTION public.get_stock_analysis_summary()
RETURNS json
LANGUAGE sql
STABLE
AS $$
SELECT json_build_object(
    'tracked_stocks_count', (SELECT count(*) FROM public.stocks WHERE is_tracked = true),
    'latest_forecast_date', (SELECT max(forecast_date) FROM public.forecasts),
    'last_audit_mape', (SELECT mape FROM public.audit_runs ORDER BY started_at DESC LIMIT 1),
    'last_audit_hit_rate', (
        SELECT avg(CASE WHEN hit_range = true THEN 1 ELSE 0 END)
        FROM public.audit_forecast_metrics
        WHERE run_id = (SELECT id FROM public.audit_runs ORDER BY started_at DESC LIMIT 1)
    )
);
$$;
RAISE NOTICE 'SUCCESS: RPC function "get_stock_analysis_summary" created or updated.';


-- Function 2: Get a list of tracked stocks for the search dropdown.
CREATE OR REPLACE FUNCTION public.get_tracked_stocks_list()
RETURNS TABLE(symbol TEXT, name TEXT)
LANGUAGE sql
STABLE
AS $$
  SELECT symbol, name
  FROM public.stocks
  WHERE is_tracked = true
  ORDER BY symbol;
$$;
RAISE NOTICE 'SUCCESS: RPC function "get_tracked_stocks_list" created or updated.';


-- Function 3: Get detailed data for a specific stock for the deep-dive view.
CREATE OR REPLACE FUNCTION public.get_stock_deep_dive(p_symbol TEXT)
RETURNS json
LANGUAGE sql
STABLE
AS $$
SELECT json_build_object(
    'details', (
        SELECT row_to_json(s)
        FROM public.stocks s
        WHERE s.symbol = p_symbol
    ),
    'historical_data', (
        SELECT COALESCE(json_agg(h ORDER BY h.date DESC), '[]'::json)
        FROM (
            SELECT * FROM public.historical_data
            WHERE stock_symbol = p_symbol
            ORDER BY date DESC
            LIMIT 90
        ) h
    ),
    'technical_indicators', (
        SELECT COALESCE(json_agg(ti ORDER BY ti.date DESC), '[]'::json)
        FROM (
            SELECT * FROM public.technical_indicators
            WHERE stock_symbol = p_symbol
            ORDER BY date DESC
            LIMIT 90
        ) ti
    ),
    'candle_patterns', (
         SELECT COALESCE(json_agg(cp ORDER BY cp.date DESC), '[]'::json)
        FROM (
            SELECT * FROM public.candle_patterns
            WHERE stock_symbol = p_symbol
            ORDER BY date DESC
            LIMIT 30 -- Patterns are less frequent, limit to a smaller recent window
        ) cp
    ),
    'latest_forecast', (
        SELECT row_to_json(f)
        FROM public.forecasts f
        WHERE f.stock_symbol = p_symbol
        ORDER BY f.forecast_date DESC
        LIMIT 1
    ),
    'forecast_history', (
        SELECT COALESCE(json_agg(afm ORDER BY afm.forecast_date DESC), '[]'::json)
        FROM (
            SELECT * FROM public.audit_forecast_metrics
            WHERE stock_symbol = p_symbol
            ORDER BY forecast_date DESC
            LIMIT 10
        ) afm
    )
);
$$;
RAISE NOTICE 'SUCCESS: RPC function "get_stock_deep_dive" created or updated.';


COMMIT;

-- #############################################################################
-- # END OF SCRIPT
-- #############################################################################