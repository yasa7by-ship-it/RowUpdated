قاعدة البيانات مبنية على PostgreSQL وتدار عبر Supabase مع تفعيل سياسات Row Level Security. تم تقسيم الجداول إلى محاور رئيسية كما يلي.

جداول المستخدمين والصلاحيات: جدول roles لتخزين الأدوار، جدول permissions لتخزين الإجراءات المسموح بها، جدول role_permissions للربط بين الأدوار والصلاحيات، وجدول profiles الذي يحمل بيانات المستخدم مثل الاسم الكامل والبريد واللغة المرتبطة بالمستخدم في auth.users. يوجد جدول user_favorites لحفظ الرموز المفضلة لكل مستخدم وجدول user_notes لتخزين الملاحظات الشخصية لكل سهم. يتم تسجيل نشاطات المنصة داخل activity_logs الذي يحفظ هوية المستخدم والفعل والتفاصيل في حقل JSON.

جداول الترجمة والإعدادات تشمل translations الذي يحتوي على كل المفاتيح النصية باللغتين، وجداول app_settings و app_settings_history لحفظ قيم الإعدادات وسجل التغيير. توجد دوال RPC مثل get_translations، get_translations_for_key، get_all_app_settings، update_setting لدعم الواجهة.

جداول البيانات المالية الرئيسية تبدأ بجدول stocks الذي يحفظ رمز السهم واسم الشركة. جدول historical_data يحتفظ بالأسعار اليومية (open high low close volume). جدول forecasts يسجل التوقعات لكل سهم مع الحدود العليا والدنيا ومستوى الثقة. جدول forecast_checks يحفظ نتيجة التوقع (hit أو miss) مقارنة بالمجال الفعلي، وجدول audit_forecast_metrics يحتفظ بإحصائيات مجمعة مثل total_forecasts و hits و misses و hit_rate لكل تاريخ. يوجد جدول trader_summaries للملخصات النصية المولدة. جدول technical_indicators يخزن قيم RSI و MACD وغيرها حسب التاريخ، وجدول pattern_signals يحفظ أنماط الشموع bullish أو bearish مع نسبة الثقة. جدول forecast_history يخزن نتائج التوقعات السابقة الخاصة بصفحة التاريخ.

جداول إضافية تشمل global_announcements للإعلانات الموجهة لجميع المستخدمين، وسجلات system_documentation، بالإضافة إلى جدول nasdaq_daily_snapshot الذي يخزن بيانات إغلاق ناسداك (close_price change_points change_percent open high low volume advancers decliners leading_sector lagging_sector headline metadata والحقول الزمنية). توجد فهارس مثل idx_nasdaq_daily_snapshot_created_at لتحسين سرعة الاستعلام، ودالة upsert_nasdaq_daily_snapshot لتحديث السجل أو إدخاله مع السماح بالتشغيل للخدمات (anon authenticated service_role).

واجهات العرض Views أهمها daily_checklist_view الذي يجمع نتائج التوقعات اليومية ويستخدم في صفحات Stock Analysis و Daily Watchlist. تعتمد الصفحات على دوال RPC رئيسية منها get_daily_checklist، get_stock_details_page_data، get_what_happened_summary، get_what_happened_stock_details، get_latest_nasdaq_snapshot، get_forecast_accuracy_overall، get_forecast_accuracy_by_stock، get_forecast_accuracy_by_date، get_forecast_accuracy_by_confidence، get_forecast_error_range_stats، get_forecast_time_trends، get_forecast_bias_analysis إضافة إلى نسخ خاصة لكل سهم. توجد دوال إدارية مثل get_all_users_with_roles، get_all_roles، get_user_profile_and_permissions، get_active_announcements، evaluate_and_save_forecasts، trigger_daily_tasks، generate_stock_analysis_summary.

الصلاحيات موزعة عبر سياسات RLS: اختيار من stocks و historical_data و forecasts و translations مسموح للجميع، بينما عمليات الكتابة مقيدة بالأدوار. المستخدم يرى ملفه الشخصي فقط، ويعدل user_favorites الخاصة به فقط، بينما الجداول الحساسة مثل activity_logs و global_announcements تتطلب صلاحية manage:*.

المحفزات Triggers المهمة هي handle_new_user الذي ينشئ صفا في profiles وينسخ الدور الافتراضي مع التأكيد، trigger_forecast_evaluation الذي يقيم التوقعات الجديدة ويحدث جدول forecast_checks أثناء إدخال بيانات جديدة، log_activity_trigger الذي يسجل التغييرات في activity_logs، بالإضافة إلى محفزات على جداول الترجمة والإعدادات لتاريخ التعديلات.

الاستعلامات الشائعة تشمل جلب الترجمات حسب اللغة (SELECT * FROM translations WHERE lang_id = 'ar')، جلب توقعات اليوم (SELECT * FROM forecasts WHERE forecast_date = CURRENT_DATE)، وجلب أحدث إحصائية أداء (SELECT * FROM audit_forecast_metrics ORDER BY forecast_date DESC LIMIT 1). تتوفر ملفات migration_* لإضافة الجداول أو تعديلها بشكل تدريجي، وملف create_nasdaq_daily_snapshot.sql لإنشاء جدول snapshot ووظائفه.
